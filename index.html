<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8">
    <!-- Updated viewport to include safe-area for iOS devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Traceability - BTH</title>

    <!-- PWA Meta Tags -->
    <meta name="description" content="ระบบบันทึกและติดตามข้อมูลเกษตรกร - บริษัท บ้านไทยเฮิร์บเซ็นเตอร์ จำกัด">
    <meta name="theme-color" content="#16a34a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="BTH Farmer">

    <!-- PWA Manifest -->
    <link rel="manifest" href="./manifest.json">

    <!-- App Icons -->
    <link rel="icon" type="image/png" sizes="192x192" href="./icons/icon-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="./icons/icon-512x512.png">
    <link rel="apple-touch-icon" href="./icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="./icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="./icons/icon-192x192.png">

    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Sarabun:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body class="p-4 md:p-8">

    <!-- Login Modal สำหรับตัวแทน -->
    <div id="login-modal" class="fixed inset-0 z-50 flex items-center justify-center hidden"
        style="background: rgba(0, 0, 0, 0.5);">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4">
            <h2 class="text-2xl font-bold text-stone-800 mb-6 text-center">เข้าสู่ระบบสำหรับตัวแทน</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label for="username" class="block text-sm font-medium mb-1">Username</label>
                        <input type="text" id="username" placeholder="username" required
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div>
                        <label for="password" class="block text-sm font-medium mb-1">Password</label>
                        <input type="password" id="password" placeholder="password" required
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-blue-500 focus:ring-2 focus:ring-blue-200">
                    </div>
                    <div id="login-error" class="text-red-500 text-sm hidden text-center"></div>

                    <button id="login-submit" type="submit"
                        class="w-full bg-gradient-to-r from-blue-600 via-blue-500 to-blue-400 text-white px-4 py-2 rounded-lg shadow-lg hover:shadow-2xl hover:from-blue-700 hover:to-blue-500 transition-all duration-300 font-semibold">
                        เข้าสู่ระบบ
                    </button>
                    <button type="button" onclick="hideLoginModal()"
                        class="w-full bg-stone-200 text-stone-700 py-3 rounded-lg font-semibold hover:bg-stone-300">
                        ยกเลิก
                    </button>
                    <div class="text-center text-sm text-red-500 mt-4">
                        <p>หากลืมรหัสผ่าน: <strong>เข้าสู่ระบบ</strong></p>
                        <p>ติดต่อผู้ดูแลระบบ</p>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Admin Login Modal สำหรับผู้ดูแลระบบ -->
    <div id="admin-login" class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-60">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full mx-4 border-t-4 border-teal-700">
            <div class="flex items-center justify-center mb-6">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-teal-600 mr-3" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 11c2.21 0 4-1.79 4-4S14.21 3 12 3 8 4.79 8 7s1.79 4 4 4zM6 20a6 6 0 0112 0" />
                </svg>
                <h2 class="text-2xl font-bold text-stone-800">เข้าสู่ระบบผู้ดูแล</h2>
            </div>
            <form id="admin-login-form" onsubmit="handleAdminLogin(event)">
                <div class="space-y-4">
                    <div>
                        <label for="admin-username" class="block text-sm font-medium mb-1 text-stone-700">Admin
                            Username</label>
                        <input type="text" id="admin-username" placeholder="admin username" required maxlength="50"
                            autocomplete="username"
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-teal-600 focus:ring-2 focus:ring-teal-200">
                    </div>
                    <div>
                        <label for="admin-password" class="block text-sm font-medium mb-1 text-stone-700">Admin
                            Password</label>
                        <input type="password" id="admin-password" placeholder="admin password" required maxlength="100"
                            autocomplete="current-password"
                            class="w-full p-3 border border-stone-300 rounded-lg focus:border-teal-600 focus:ring-2 focus:ring-teal-200">
                    </div>
                    <div id="admin-login-error" class="text-red-500 text-sm hidden text-center"></div>

                    <button id="admin-login-submit" type="submit"
                        class="w-full bg-gradient-to-r from-green-600 via-green-500 to-green-400 text-white px-4 py-2 rounded-lg shadow-lg hover:shadow-2xl hover:from-green-700 hover:to-green-500 transition-all duration-300 font-semibold">
                        เข้าสู่ระบบ
                    </button>
                    <button type="button" onclick="hideAdminLoginModal()"
                        class="w-full bg-stone-200 text-stone-700 py-3 rounded-lg font-semibold hover:bg-stone-300">
                        ยกเลิก
                    </button>
                    <div class="text-center text-sm text-stone-600 mt-4">
                        <p class="font-semibold text-teal-700">สำหรับผู้ดูแลระบบเท่านั้น</p>
                        <p class="text-xs mt-1">หากลืมรหัสผ่าน ติดต่อ Super Admin</p>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Back Button - moved inside container below -->


    <div class="form-container mx-auto">
        <!-- Back Button -->
        <button id="back-button" onclick="goBack()"
            class="mb-4 px-4 py-2 rounded-full bg-white shadow-lg hidden hover:shadow-xl transition-shadow"
            title="กลับหน้าหลัก">
            <div class="flex items-center">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-400 mr-1" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                </svg>
                <span class="text-sm text-stone-600">กลับหน้าหลัก</span>
            </div>
        </button>

        <div id="api-warning" class="hidden"></div>

        <div id="api-status" class="hidden mt-4 p-3 rounded-lg text-sm"></div>

        <!-- Loading Overlay -->
        <div id="loading-overlay" class="fixed inset-0 z-40 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black opacity-20"></div>
            <div class="bg-white p-6 rounded-xl shadow-xl z-50 flex items-center">
                <div class="loading-spinner mr-3"></div>
                <span class="text-stone-700 font-medium" id="loading-text">กำลังโหลด...</span>
            </div>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="fixed inset-0 z-50 flex items-center justify-center hidden">
            <div class="absolute inset-0 bg-black opacity-30"></div>
            <div class="bg-white p-8 rounded-xl shadow-2xl max-w-sm w-full z-10 border-t-4 border-stone-800">
                <h3 id="message-title" class="text-xl font-bold mb-4 text-stone-800"></h3>
                <p id="message-content" class="mb-6 text-stone-600"></p>
                <button onclick="hideMessageBox()" class="w-full blue-button py-2 rounded-lg">ตกลง</button>
            </div>
        </div>

        <!-- MAIN MENU VIEW - UPDATED DESIGN -->
        <div id="main-menu-view" class="space-y-6 relative">
            <!-- ส่วนหัว (Navigation) -->
            <nav class="bg-white shadow-md sticky top-0 z-50 -mx-4 -mt-4 sm:-mx-6 lg:-mx-8">
                <div class="max-w-6xl mx-auto px-4">
                    <div id="header-content" class="flex flex-wrap justify-between items-center py-3 gap-2">
                        <div id="header-logo" class="text-2xl font-bold text-green-600">
                            BANTHAIHERBCENTER
                        </div>
                        <div id="header-links" class="flex flex-wrap items-center gap-2 sm:gap-4">
                            <a href="#" class="hover:text-green-500 transition text-sm sm:text-base">หน้าแรก</a>
                            <a href="#features"
                                class="hover:text-green-500 transition text-sm sm:text-base">คุณสมบัติ</a>
                            <a href="#about"
                                class="hover:text-green-500 transition text-sm sm:text-base">เกี่ยวกับเรา</a>
                            <a href="#contact"
                                class="bg-blue-600 text-white px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg hover:bg-blue-700 transition text-sm sm:text-base">ติดต่อเรา</a>
                            <button id="admin-nav-btn" onclick="adminCheckAuthAndInit()" title="ผู้ดูแลระบบ (Admin)"
                                class="flex items-center gap-1 sm:gap-2 px-3 py-1.5 sm:px-4 sm:py-2 rounded-lg text-white transition hover:scale-105 text-sm sm:text-base"
                                style="background: linear-gradient(135deg,#0f766e,#10b981);">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 sm:w-5 sm:h-5" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.8">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 11c2.21 0 4-1.79 4-4S14.21 3 12 3 8 4.79 8 7s1.79 4 4 4zM6 20a6 6 0 0112 0" />
                                </svg>
                                <span class="font-semibold">Admin</span>
                            </button>
                        </div>
                    </div>
                </div>
            </nav>

            <div class="text-center mb-10">
                <h1 class="text-3xl font-extrabold text-stone-800 mb-3">
                    ระบบบันทึกและติดตามข้อมูลเกษตรกร
                </h1>
                <p class="text-sm text-gray-500">
                    เลือกเมนูที่ต้องการเพื่อเริ่มต้นใช้งานระบบ
                </p>
                <div class="flex justify-center space-x-4 mt-4">
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-2"></div>
                        <span class="text-xs text-gray-600">ฟอร์มข้อมูลพื้นฐาน</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-blue-500 mr-2"></div>
                        <span class="text-xs text-gray-600">ระบบตัวแทน</span>
                    </div>
                    <div class="flex items-center">
                        <div class="w-3 h-3 rounded-full bg-orange-500 mr-2"></div>
                        <span class="text-xs text-gray-600">รายงานประจำวัน</span>
                    </div>
                </div>
            </div>

            <div class="main-menu-grid">
                <!-- Card 1: Survey Form - เปลี่ยนเป็นสีเขียว -->
                <div id="card-sheet-a" class="portal-card-enhanced" onclick="showView('form-menu-view')"
                    style="--card-index: 1;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-green-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="card-title">ระบบข้อมูลเกษตรกรแปลงกระท่อม</h2>
                    <p class="card-description">
                        บันทึกข้อมูลแปลงกระท่อม
                        <span class="block text-red-500 font-semibold mt-2 text-sm">
                            (สำหรับเกษตรกรหรือตัวแทนที่จะซื้อขายกับบริษัท)
                        </span>
                    </p>
                    <div class="card-badge">
                        ฟอร์มสำรวจพื้นที่
                    </div>
                </div>

                <!-- Card 2: Data Management -->
                <div id="card-sheet-b" class="portal-card-enhanced" onclick="checkAuthAndShowSubmenu()"
                    style="--card-index: 2;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-blue-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <h2 class="card-title">ระบบข้อมูลตัวแทน BTH</h2>
                    <p class="card-description">
                        จัดการข้อมูล
                    </p>
                    <div class="card-badge">
                        ระบบตัวแทน
                    </div>
                </div>

                <!-- Card 3: Usage Report 4-7-16 -->
                <div id="card-sheet-b-use" class="portal-card-enhanced" onclick="showView('sheet-b-use-view')"
                    style="--card-index: 3;">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-orange-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M8 4h8l-1 3H9L8 4z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M7 7h10l1 13H6L7 7z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 11c-2 1-2 3 0 4c2-1 2-3 0-4z" />
                        </svg>
                    </div>
                    <h2 class="card-title">ระบบบันทึกข้อมูลบริหารจัดการแปลง</h2>
                    <p class="card-description">
                        <span class="block text-red-500 font-semibold mt-2 text-sm">
                            (บันทึกข้อมูลทุกครั้งที่เข้าสวน)
                        </span>
                    </p>
                    <div class="card-badge">
                        รายงานประจำทุกครั้ง
                    </div>
                </div>

                <!-- Card 4: Leaf Sample -->
                <div class="portal-card-enhanced" onclick="openLeafSampleForm()"
                    style="--card-index: 4; background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);">
                    <div class="card-glow"></div>
                    <div class="card-icon-wrapper"
                        style="background: linear-gradient(135deg, #ffffff 0%, #ffffff 100%);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-10 w-10 text-cyan-600" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.27 6.96L12 12.01l8.73-5.05" />
                            <path stroke-linecap="round" stroke-linejoin="round" d="M12 22.08V12" />
                        </svg>
                    </div>
                    <h2 class="card-title">แบบฟอร์มส่งใบกระท่อมตรวจค่าสารไมทราไจนีน</h2>
                    <p class="card-description">
                        <span class="block text-red-500 font-semibold mt-2 text-sm">
                            (สำหรับเกษตรกรหรือตัวแทนที่จะซื้อขายกับบริษัท)
                        </span>
                    </p>
                    <div class="card-badge"
                        style="background: linear-gradient(135deg, #a5f3fc 0%, #06b6d4 100%); color: #164e63;">
                        ตรวจวิเคราะห์แล็บ
                    </div>
                </div>
            </div>

            <!-- Footer note -->
            <div class="text-center mt-12 pt-6 border-t border-gray-200">
                <div class="mb-2 fw-bold">บริษัท บ้านไทยเฮิร์บเซ็นเตอร์ จำกัด</div>
                <div class="mb-2">ช่องทางติดต่อ: <a href="https://line.me/ti/p/LV4OFl3dcU" target="_blank"
                        class="btn btn-success fw-bold mx-1 d-inline-flex align-items-center gap-1"><i
                            class="fab fa-line"></i>
                        กดเพื่อสแกน QR เพิ่มเพื่อน และแชทผ่าน LINE </a> | <a href="tel:0924579929"
                        class="text-warning text-decoration-none fw-bold">092-4579929</a> | <a href="tel:0635033042"
                        class="text-warning text-decoration-none fw-bold">063-5033042</a></div>
            </div>
        </div>

        <!-- FORM MENU VIEW - เปลี่ยนสีเป็นเขียวทั้งหมด -->
        <div id="form-menu-view" class="space-y-6 hidden">
            <div class="text-center mb-6 md:mb-10">
                <h2 class="text-xl md:text-2xl font-bold text-stone-800 mb-2">แจ้งข้อมูลแปลงกระท่อม</h2>
                <p class="text-sm md:text-base text-stone-600">กรุณาเลือกประเภทแบบฟอร์มที่ต้องการ</p>
            </div>

            <div class="bg-white rounded-lg md:rounded-xl shadow-lg p-4 md:p-6 max-w-6xl mx-auto">
                <nav class="space-y-3">
                    <!-- =========== START: แทรกฟอร์มสำรวจข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม =========== -->
                    <div id="survey-form-container"
                        class="bg-white rounded-lg md:rounded-xl shadow-lg p-3 md:p-6 max-w-6xl mx-auto">
                        <!-- ฟอร์มสำรวจข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม -->
                        <div id="formStep" class="main-container">
                            <div class="form-card">
                                <div
                                    class="flex flex-col md:flex-row justify-between items-start md:items-center mb-4 md:mb-6 gap-4">
                                    <div class="w-full md:w-auto">
                                        <h1
                                            class="form-title text-lg md:text-xl lg:text-2xl font-bold text-stone-800 mb-2">
                                            ข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม บริษัท บ้านไทยเฮิร์บเซ็นเตอร์ จำกัด</h1>
                                        <p class="form-subtitle text-xs md:text-sm text-stone-600 mb-2">15 หมู่ 12 ตำบล
                                            ท่าบุญมี
                                            อำเภอ เกาะจันทร์ จังหวัด ชลบุรี 20240</p>
                                        <p class="mb-2 text-xs md:text-sm">
                                            ช่องทางติดต่อ:
                                            <a href="tel:0924579929"
                                                class="text-green-600 font-semibold">092-4579929</a> | <a
                                                href="tel:0635033042"
                                                class="text-green-600 font-semibold">063-5033042</a>
                                        </p>
                                    </div>
                                    <img src="https://i.postimg.cc/rsL6ZK4T/image.jpg" alt="BTH Logo"
                                        class="h-16 md:h-24 lg:h-32 w-auto object-contain mx-auto md:mx-0">
                                </div>

                                <form id="kratomForm" novalidate>
                                    <!-- ข้อมูลเกษตรกรและแปลงกระท่อม -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-geo-alt-fill me-2"></i>ข้อมูลเกษตรกรและแปลงกระท่อม
                                        </h3>
                                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3 md:gap-4">
                                            <!-- สถานะตัวแทนเกษตรกร -->
                                            <div class="sm:col-span-2 lg:col-span-3">
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">สถานะตัวแทนเกษตรกร<span
                                                        class="text-red-600">*</span></label>
                                                <div class="radio-group flex flex-wrap gap-2">
                                                    <input type="radio" id="agent-none" name="farmer_agent" value="none"
                                                        class="hidden" onchange="toggleAgentInput()">
                                                    <label for="agent-none"
                                                        class="px-3 py-2 rounded-lg cursor-pointer border border-gray-300 bg-white text-sm">
                                                        ยังไม่มีตัวแทน
                                                    </label>
                                                    <input type="radio" id="agent-have" name="farmer_agent" value="have"
                                                        class="hidden" onchange="toggleAgentInput()">
                                                    <label for="agent-have"
                                                        class="px-3 py-2 rounded-lg cursor-pointer border border-gray-300 bg-white text-sm">
                                                        มีตัวแทน
                                                    </label>
                                                </div>
                                                <input type="text" id="agent-name" name="agent_name"
                                                    placeholder="โปรดระบุชื่อตัวแทน"
                                                    class="hidden mt-2 w-full px-3 py-2 border border-gray-300 rounded text-sm">
                                            </div>

                                            <!-- ชื่อเกษตรกร -->
                                            <div class="sm:col-span-2 lg:col-span-6">
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">ชื่อและนามสกุล<span
                                                        class="text-red-600">*</span></label>
                                                <div class="grid grid-cols-2 gap-2">
                                                    <input type="text" id="farmer_firstname" name="farmer_firstname"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        required placeholder="ชื่อ">
                                                    <input type="text" id="farmer_lastname" name="farmer_lastname"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        required placeholder="นามสกุล">
                                                </div>
                                                <!-- hidden legacy field for backward compatibility -->
                                                <input type="hidden" id="farmer_name_main" name="farmer_name_main"
                                                    value="">
                                            </div>

                                            <!-- เบอร์โทร -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="tel"
                                                    class="form-label block font-medium mb-1 text-stone-800">เบอร์โทร<span
                                                        class="text-red-600">*</span></label>
                                                <input type="tel"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="tel" name="tel" required placeholder="เบอร์โทร">
                                            </div>

                                            <!-- พิกัด X -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="coord_x"
                                                    class="form-label block font-medium mb-1 text-stone-800">พิกัด
                                                    X<span class="text-red-600">*</span></label>
                                                <input type="number" step="any"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coord_x" name="coord_x" required placeholder="เช่น 13.7563">
                                            </div>

                                            <!-- พิกัด Y -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="coord_y"
                                                    class="form-label block font-medium mb-1 text-stone-800">พิกัด
                                                    Y<span class="text-red-600">*</span></label>
                                                <input type="number" step="any"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coord_y" name="coord_y" required placeholder="เช่น 100.5018">
                                            </div>

                                            <!-- ตำบล -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="subdistrict"
                                                    class="form-label block font-medium mb-1 text-stone-800">ตำบล<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="subdistrict" name="subdistrict" required placeholder="ตำบล">
                                            </div>

                                            <!-- อำเภอ -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="district"
                                                    class="form-label block font-medium mb-1 text-stone-800">อำเภอ<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="district" name="district" required placeholder="อำเภอ">
                                            </div>

                                            <!-- จังหวัด -->
                                            <div class="sm:col-span-1 lg:col-span-2">
                                                <label for="province"
                                                    class="form-label block font-medium mb-1 text-stone-800">จังหวัด<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="province" name="province" required placeholder="จังหวัด">
                                            </div>

                                            <!-- หลักฐานที่ดิน -->
                                            <div class="sm:col-span-2 lg:col-span-12">
                                                <label for="land_evidence"
                                                    class="form-label block font-medium mb-1 text-stone-800">หลักฐานที่ดิน<span
                                                        class="text-red-600">*</span></label>
                                                <select id="land_evidence" name="land_evidence"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base">
                                                    <option value="">-- ระบุหลักฐานที่ดิน --</option>
                                                    <option value="โฉนดที่ดิน (น.ส. 4 จ.)">โฉนดที่ดิน (น.ส. 4 จ.)
                                                    </option>
                                                    <option value="น.ส. 3 (ครุฑดำ)">น.ส. 3 (ครุฑดำ)</option>
                                                    <option value="น.ส. 3 ก. (ครุฑเขียว)">น.ส. 3 ก. (ครุฑเขียว)</option>
                                                    <option value="น.ส. 3 ข. (ครุฑดำ)">น.ส. 3 ข. (ครุฑดำ)</option>
                                                    <option value="ส.ป.ก. 4-01">ส.ป.ก. 4-01</option>
                                                    <option value="ใบจอง (น.ส. 2)">ใบจอง (น.ส. 2)</option>
                                                    <option value="ภ.ด.ส.">ภ.ด.ส.</option>
                                                    <option value="ภ.บ.ท. 5">ภ.บ.ท. 5</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div
                                            class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-12 gap-3 md:gap-4 mt-3 md:mt-4">
                                            <!-- จำนวนต้นทั้งหมด -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="tree_count"
                                                    class="form-label block font-medium mb-1 text-stone-800">จำนวนต้นทั้งหมด<span
                                                        class="text-red-600">*</span></label>
                                                <input type="number"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="tree_count" name="tree_count" required placeholder="จำนวนต้น">
                                            </div>

                                            <!-- วันที่ปลูก -->
                                            <div class="sm:col-span-1 lg:col-span-6">
                                                <label for="plant_date"
                                                    class="form-label block font-medium mb-1 text-stone-800">ว/ด/ป
                                                    ปลูกต้นกล้า<span class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="plant_date" name="plant_date" required
                                                    placeholder="วัน/เดือน/ปี ที่ปลูก (D/M/YYYY)">
                                            </div>

                                            <!-- จำนวนต้นที่พร้อมขายจริง -->
                                            <div class="sm:col-span-1 lg:col-span-3">
                                                <label for="ready_to_sell_count"
                                                    class="form-label block font-medium mb-1 text-stone-800">จำนวนต้นที่พร้อมขายจริง<span
                                                        class="text-red-600">*</span></label>
                                                <input type="number"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="ready_to_sell_count" name="ready_to_sell_count" required
                                                    placeholder="จำนวนต้นที่พร้อมขาย">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- การบริหารจัดการแปลง -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-tools me-2"></i>การบริหารจัดการแปลง
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">
                                            <!-- ระบบให้น้ำ -->
                                            <div>
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ระบบให้น้ำ <small class="text-gray-500">(เลือกได้มากกว่าหนึ่ง)<span
                                                            class="text-red-600">*</span></small>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_rain"
                                                            name="water_system[]" value="น้ำฝน">
                                                        <label for="water_rain"
                                                            class="cursor-pointer text-sm">น้ำฝน</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_natural"
                                                            name="water_system[]" value="แหล่งน้ำธรรมชาติ">
                                                        <label for="water_natural"
                                                            class="cursor-pointer text-sm">แหล่งน้ำธรรมชาติ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_reservoir"
                                                            name="water_system[]" value="แหล่งกักเก็บน้ำ">
                                                        <label for="water_reservoir"
                                                            class="cursor-pointer text-sm">แหล่งกักเก็บน้ำ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_irrigation"
                                                            name="water_system[]" value="ชลประทาน">
                                                        <label for="water_irrigation"
                                                            class="cursor-pointer text-sm">ชลประทาน</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_ground"
                                                            name="water_system[]" value="น้ำบาดาล">
                                                        <label for="water_ground"
                                                            class="cursor-pointer text-sm">น้ำบาดาล</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_sprinkler"
                                                            name="water_system[]" value="สปริงเกอร์">
                                                        <label for="water_sprinkler"
                                                            class="cursor-pointer text-sm">สปริงเกอร์</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="water_other"
                                                            name="water_system[]" value="อื่นๆ"
                                                            data-other-target="water_other_text">
                                                        <label for="water_other" class="cursor-pointer text-sm">อื่นๆ
                                                            (ระบุ)</label>
                                                    </div>
                                                </div>
                                                <input type="text" id="water_other_text"
                                                    class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    placeholder="ระบุระบบให้น้ำอื่นๆ">
                                                <label for="water_ph"
                                                    class="form-label block font-medium mt-3 mb-1 text-stone-800">ค่า PH
                                                    น้ำ</label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="water_ph" name="water_ph" required placeholder="ค่า PH น้ำ">
                                            </div>

                                            <!-- วิธีให้ปุ๋ย -->
                                            <div>
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ระบบให้ปุ๋ย <small class="text-gray-500">(เลือกได้มากกว่าหนึ่ง)<span
                                                            class="text-red-600">*</span></small>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_organic"
                                                            name="fertilizer_method[]" value="ปุ๋ยอินทรีย์">
                                                        <label for="fert_organic"
                                                            class="cursor-pointer text-sm">ปุ๋ยอินทรีย์</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_chemical"
                                                            name="fertilizer_method[]" value="ปุ๋ยเคมี">
                                                        <label for="fert_chemical"
                                                            class="cursor-pointer text-sm">ปุ๋ยเคมี</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_manure"
                                                            name="fertilizer_method[]" value="ปุ๋ยคอก">
                                                        <label for="fert_manure"
                                                            class="cursor-pointer text-sm">ปุ๋ยคอก</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_bio"
                                                            name="fertilizer_method[]" value="ปุ๋ยชีวภาพ">
                                                        <label for="fert_bio"
                                                            class="cursor-pointer text-sm">ปุ๋ยชีวภาพ</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_organic_chemical"
                                                            name="fertilizer_method[]" value="ปุ๋ยอินทรีย์เคมี">
                                                        <label for="fert_organic_chemical"
                                                            class="cursor-pointer text-sm">ปุ๋ยอินทรีย์เคมี</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="checkbox" id="fert_other"
                                                            name="fertilizer_method[]" value="อื่นๆ"
                                                            data-other-target="fert_other_text">
                                                        <label for="fert_other" class="cursor-pointer text-sm">อื่นๆ
                                                            (ระบุ)</label>
                                                    </div>
                                                </div>
                                                <input type="text" id="fert_other_text"
                                                    class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                    placeholder="โปรดระบุชนิดปุ๋ยอื่นๆ ที่ใช้">
                                                <label for="soil_ph"
                                                    class="form-label block font-medium mt-3 mb-1 text-stone-800">ค่า PH
                                                    ดิน</label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="soil_ph" name="soil_ph" required placeholder="ค่า PH ดิน">
                                            </div>

                                            <!-- ฮอร์โมน / อื่นๆ (รวมแร่ภูเขาไฟ ย้ายมาที่นี่) -->
                                            <div>
                                                <label
                                                    class="form-label block font-medium mb-1 text-stone-800">สารปรับปรุงดิน<span
                                                        class="text-red-600">*</span></label>

                                                <!-- ย้าย 'แร่ภูเขาไฟ' มาที่ส่วนนี้ -->
                                                <div class="flex items-center mb-2">
                                                    <input class="mr-2" type="checkbox" id="mineral_volcanic"
                                                        name="mineral_options[]" value="แร่ภูเขาไฟ">
                                                    <label for="mineral_volcanic"
                                                        class="cursor-pointer text-sm">แร่ภูเขาไฟ</label>
                                                </div>
                                                <label for="hormone_and_other"
                                                    class="form-label block font-medium mb-1 text-stone-800">ฮอร์โมน
                                                    /<span class="text-red-600">*</span>
                                                    อื่นๆ</label>

                                                <!-- รวมช่องฮอร์โมนและช่องอื่นๆ เป็นช่องเดียว -->
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-3"
                                                    id="hormone_and_other" name="hormone_and_other"
                                                    placeholder="ระบุฮอร์โมนและข้อมูลอื่นๆ (ถ้ามี)">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ข้อมูลฤดูกาล -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-cloud-rain me-2"></i>ข้อมูลฤดูกาล แต่ละพื้นที่ปลูก
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-6">

                                            <!-- ฤดูแตัวแทน -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">ช่วงฤดูแล้ง<span
                                                        class="text-red-600">*</span></label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="dry_start_month" id="dry_start_month">
                                                    <option value="">เดือนเริ่มต้น</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="dry_end_month" id="dry_end_month">
                                                    <option value="">เดือนสิ้นสุด</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                            </div>

                                            <!-- ฤดูฝน -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">ช่วงฤดูฝน<span
                                                        class="text-red-600">*</span></label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="rainy_start_month" id="rainy_start_month">
                                                    <option value="">เดือนเริ่มต้น</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="rainy_end_month" id="rainy_end_month">
                                                    <option value="">เดือนสิ้นสุด</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                            </div>

                                            <!-- ฤดูหนาว -->
                                            <div>
                                                <label
                                                    class="form-label block font-bold mb-1 text-stone-800">ช่วงฤดูหนาว<span
                                                        class="text-red-600">*</span></label>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base mb-2"
                                                    name="winter_start_month" id="winter_start_month">
                                                    <option value="">เดือนเริ่มต้น</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                                <select
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    name="winter_end_month" id="winter_end_month">
                                                    <option value="">เดือนสิ้นสุด</option>
                                                    <option value="1">มกราคม</option>
                                                    <option value="2">กุมภาพันธ์</option>
                                                    <option value="3">มีนาคม</option>
                                                    <option value="4">เมษายน</option>
                                                    <option value="5">พฤษภาคม</option>
                                                    <option value="6">มิถุนายน</option>
                                                    <option value="7">กรกฎาคม</option>
                                                    <option value="8">สิงหาคม</option>
                                                    <option value="9">กันยายน</option>
                                                    <option value="10">ตุลาคม</option>
                                                    <option value="11">พฤศจิกายน</option>
                                                    <option value="12">ธันวาคม</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- มาตรฐานแปลงและคู่สัญญา -->
                                    <div id="section-standard-contract"
                                        class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-file-earmark-check me-2"></i>มาตรฐานแปลงและคู่สัญญา
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                                            <!-- GAP สมุนไพร -->
                                            <div>
                                                <label class="form-label block font-bold mb-1 text-stone-800">
                                                    ข้อมูล GAP สมุนไพร<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gap_status" id="gap_yes"
                                                            value="yes" onchange="toggleDateRange('gap', true)">
                                                        <label for="gap_yes" class="cursor-pointer">มี</label>
                                                    </div>
                                                    <div id="gap-date-range" class="mt-2 hidden">
                                                        <label
                                                            class="form-label block text-sm mb-1 text-stone-800">ถ้ามี
                                                            โปรดระบุ วันที่เริ่มต้นและวันที่สิ้นสุด</label>
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gap_start_date" id="gap_start_date"
                                                                    placeholder="วันเริ่มต้น">
                                                            </div>
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gap_end_date" id="gap_end_date"
                                                                    placeholder="วันหมดอายุ">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gap_status" id="gap_no"
                                                            value="no" onchange="toggleDateRange('gap', false)">
                                                        <label for="gap_no" class="cursor-pointer">ไม่มี</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- GACP สมุนไพร -->
                                            <div>
                                                <label class="form-label block font-bold mb-1 text-stone-800">
                                                    ข้อมูล GACP สมุนไพร<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gacp_status"
                                                            id="gacp_yes" value="yes"
                                                            onchange="toggleDateRange('gacp', true)">
                                                        <label for="gacp_yes" class="cursor-pointer">มี</label>
                                                    </div>
                                                    <div id="gacp-date-range" class="mt-2 hidden">
                                                        <label
                                                            class="form-label block text-sm mb-1 text-stone-800">ถ้ามี
                                                            โปรดระบุ วันที่เริ่มต้นและวันที่สิ้นสุด</label>
                                                        <div class="grid grid-cols-2 gap-2">
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gacp_start_date" id="gacp_start_date">
                                                            </div>
                                                            <div>
                                                                <input type="date"
                                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                                                    name="gacp_end_date" id="gacp_end_date">
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="gacp_status" id="gacp_no"
                                                            value="no" onchange="toggleDateRange('gacp', false)">
                                                        <label for="gacp_no" class="cursor-pointer">ไม่มี</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- คู่สัญญา -->
                                            <div class="md:col-span-2">
                                                <label class="form-label block font-bold mt-3 mb-1 text-stone-800">
                                                    ข้อมูล คู่สัญญา<span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="contract_status"
                                                            id="contract_yes" value="old">
                                                        <label for="contract_yes"
                                                            class="cursor-pointer">ติดสัญญาเก่า</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2" type="radio" name="contract_status"
                                                            id="contract_no" value="none">
                                                        <label for="contract_no"
                                                            class="cursor-pointer">ไม่ติดสัญญาเก่า</label>
                                                    </div>
                                                </div>
                                            </div>

                                            <div class="mt-3">
                                                <label class="form-label block font-medium mb-1 text-stone-800">
                                                    ค่าสารไมทราไจนีน <span class="text-red-600">*</span>
                                                </label>
                                                <div class="flex flex-col gap-2">
                                                    <div class="flex items-center">
                                                        <input class="mr-2 substance-cb" type="checkbox"
                                                            id="substance_checked" name="substance_status"
                                                            value="checked">
                                                        <label for="substance_checked"
                                                            class="cursor-pointer text-sm">มีการตรวจค่าสาร</label>
                                                    </div>
                                                    <div class="flex items-center">
                                                        <input class="mr-2 substance-cb" type="checkbox"
                                                            id="substance_not_checked" name="substance_status"
                                                            value="not_checked">
                                                        <label for="substance_not_checked"
                                                            class="cursor-pointer text-sm">ยังไม่เคยมีการตรวจค่าสาร</label>
                                                    </div>
                                                </div>
                                                <div id="substanceValueBox" class="mt-3 hidden">
                                                    <label for="substance_value"
                                                        class="form-label block font-medium mb-1 text-stone-800">
                                                        ระบุค่าสารไมทราไจนีน
                                                    </label>
                                                    <input type="number" step="any"
                                                        class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                        id="substance_value" name="substance_value"
                                                        placeholder="เช่น 1.25">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ข้อมูลสายพันธุ์กระท่อม -->
                                    <div id="section-species-info"
                                        class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-trophy-fill me-2"></i>ข้อมูลสายพันธุ์กระท่อม<span
                                                class="text-red-600">*</span>
                                        </h3>

                                        <!-- เลือกสายพันธุ์กระท่อม -->
                                        <div class="mb-4">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">สายพันธุ์กระท่อม</label>
                                            <div class="flex flex-wrap gap-3">
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="red"
                                                        id="stem_red" name="stem_selector">
                                                    <label for="stem_red" class="cursor-pointer text-sm">ก้านแดง</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="white"
                                                        id="stem_white" name="stem_selector">
                                                    <label for="stem_white"
                                                        class="cursor-pointer text-sm">ก้านขาว</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="green"
                                                        id="stem_green" name="stem_selector">
                                                    <label for="stem_green"
                                                        class="cursor-pointer text-sm">ก้านเขียว</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <input class="mr-2 stem-cb" type="checkbox" value="cross"
                                                        id="stem_cross" name="stem_selector">
                                                    <label for="stem_cross"
                                                        class="cursor-pointer text-sm">ข้ามสายพันธุ์</label>
                                                </div>
                                                <div class="flex items-center">
                                                    <!-- เพิ่ม data-other-target เพื่อเชื่อมกับ textarea #other_varieties -->
                                                    <input class="mr-2 stem-cb" type="checkbox" value="other"
                                                        id="stem_other" name="stem_selector"
                                                        data-other-target="other_varieties">
                                                    <label for="stem_other" class="cursor-pointer text-sm">อื่นๆ</label>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- ระบุชื่อ (ข้ามสายพันธุ์ / อื่นๆ) -->
                                        <div id="special-name" class="hidden mb-4">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">ระบุชื่อสายพันธุ์
                                                (ข้ามสายพันธุ์)</label>
                                            <input type="text"
                                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                name="special_species_name" id="special_species_name"
                                                placeholder="ระบุชื่อสายพันธุ์">
                                        </div>

                                        <!-- เพิ่มช่องสำหรับ 'อื่นๆ' ของสายพันธุ์ แยกจากข้ามสายพันธุ์ -->
                                        <div class="mb-4">
                                            <label class="form-label block font-bold mb-1 text-stone-800">อื่นๆ
                                                (สายพันธุ์อื่นๆ
                                                ที่นอกเหนือจากรายการ)</label>
                                            <!-- ซ่อนเริ่มต้นไว้ จะถูกแสดงเมื่อ checkbox ชื่อ 'อื่นๆ' ถูกติ๊ก (data-other-target) -->
                                            <textarea id="other_varieties" name="other_varieties"
                                                class="hidden w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                rows="2"
                                                placeholder="ระบุชื่อสายพันธุ์อื่นๆ (คั่นด้วยคอมม่า ถ้ามากกว่า 1)"></textarea>
                                        </div>

                                        <!-- container ของแต่ละก้าน -->
                                        <div id="stem-sections"></div>

                                        <!-- รวมจำนวนทั้งหมด -->
                                        <div class="mt-4 w-full md:w-1/2">
                                            <label
                                                class="form-label block font-bold mb-1 text-stone-800">จำนวนต้นรวมที่ระบุในส่วนสายพันธุ์</label>
                                            <input type="number"
                                                class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base bg-gray-50"
                                                id="total_tree_count" readonly>
                                        </div>
                                    </div>

                                    <!-- ข้อมูลพื้นที่ย้อนหลัง 3ปี -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-list-ol me-2"></i>ข้อมูลพื้นที่ย้อนหลัง 3ปี<span
                                                class="text-red-600">*</span>
                                        </h3>
                                        <div class="flex flex-wrap gap-2">
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_empty"
                                                    name="past_land_types[]" value="พื้นที่เปล่า">
                                                <label for="past_empty"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่เปล่า</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_fruit_garden"
                                                    name="past_land_types[]" value="พื้นที่ทำสวนผลไม้">
                                                <label for="past_fruit_garden"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ทำสวนผลไม้</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_rice"
                                                    name="past_land_types[]" value="พื้นที่ทำนา">
                                                <label for="past_rice"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ทำนา</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_vegetable"
                                                    name="past_land_types[]" value="พื้นที่แปลงพืชผัก">
                                                <label for="past_vegetable"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่แปลงพืชผัก</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_fill"
                                                    name="past_land_types[]" value="พื้นที่ดินถมใหม่">
                                                <label for="past_fill"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ดินถมใหม่</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_mixed"
                                                    name="past_land_types[]" value="พื้นที่เกษตรผสมผสาน">
                                                <label for="past_mixed"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่เกษตรผสมผสาน</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_pond"
                                                    name="past_land_types[]" value="สระน้ำ">
                                                <label for="past_pond"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">สระน้ำ</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_forest"
                                                    name="past_land_types[]" value="พื้นที่ป่า">
                                                <label for="past_forest"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ป่า</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_mangrove"
                                                    name="past_land_types[]" value="พื้นที่ป่าชายเลน">
                                                <label for="past_mangrove"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">พื้นที่ป่าชายเลน</label>
                                            </div>
                                            <div class="flex items-center">
                                                <input class="mr-2" type="checkbox" id="past_other"
                                                    name="past_land_types[]" value="อื่นๆ"
                                                    data-other-target="past_other_text">
                                                <label for="past_other"
                                                    class="cursor-pointer text-sm px-2 py-1 rounded border">อื่นๆ
                                                    (ระบุ)</label>
                                            </div>
                                        </div>
                                        <input type="text" id="past_other_text"
                                            class="form-control mt-2 hidden w-full px-3 py-2 border border-gray-300 rounded text-sm"
                                            placeholder="ระบุอื่นๆ (ย้อนหลัง 3 ปี)">
                                    </div>

                                    <!-- ตัวแทนผู้ประสานงาน -->
                                    <div class="form-section border border-gray-200 rounded-lg p-3 md:p-6 mb-4 md:mb-6">
                                        <h3
                                            class="section-title text-lg md:text-xl font-bold text-stone-800 mb-3 md:mb-4">
                                            <i class="bi bi-person-lines-fill me-2"></i>ตัวแทนผู้ประสานงาน
                                        </h3>
                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div>
                                                <label for="coordinator_name"
                                                    class="form-label block font-medium mb-1 text-stone-800">ตัวแทนผู้ประสานงาน<span
                                                        class="text-red-600">*</span></label>
                                                <input type="text"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coordinator_name" name="coordinator_name" required
                                                    placeholder="ชื่อตัวแทนผู้ประสานงาน">
                                            </div>
                                            <div>
                                                <label for="coordinator_tel"
                                                    class="form-label block font-medium mb-1 text-stone-800">เบอร์โทรของตัวแทนผู้ประสานงาน<span
                                                        class="text-red-600">*</span></label>
                                                <input type="tel"
                                                    class="w-full px-3 py-2 border border-gray-300 rounded text-sm md:text-base"
                                                    id="coordinator_tel" name="coordinator_tel" required
                                                    placeholder="เบอร์โทรศัพท์">
                                            </div>
                                        </div>
                                    </div>

                                    <!-- ปุ่มส่งข้อมูล -->
                                    <div class="text-center mt-6">
                                        <button type="button" id="nextBtn"
                                            class="btn btn-primary bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base">
                                            <i class="bi bi-eye-fill me-2"></i>ดูตัวอย่างและส่งข้อมูล
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>

                        <!-- Preview Step (hidden initially) -->
                        <div id="previewStep" class="main-container hidden">
                            <div class="form-card">
                                <h2 class="form-title text-lg md:text-xl lg:text-2xl font-bold text-stone-800 mb-2">
                                    <i
                                        class="bi bi-search me-2 text-red-600"></i>ตัวอย่างแบบฟอร์มจริงสำรวจข้อมูลแปลงกระท่อม
                                </h2>
                                <p class="form-subtitle text-sm md:text-base text-stone-600 mb-4 md:mb-6">
                                    กรุณาตรวจสอบความถูกต้องของข้อมูลทั้งหมดก่อนกดส่ง</p>

                                <div id="previewCard" class="p-4 border rounded-lg bg-gray-50 mb-6">
                                    <p class="text-gray-500 text-center">กำลังโหลดข้อมูลตัวอย่าง...</p>
                                </div>

                                <div class="flex flex-col sm:flex-row justify-between gap-4">
                                    <button id="backBtn"
                                        class="btn btn-secondary bg-gray-600 hover:bg-gray-700 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base">
                                        <i class="bi bi-arrow-left-circle-fill me-2"></i>ย้อนกลับ
                                    </button>
                                    <button id="submitBtn"
                                        class="btn btn-primary bg-gradient-to-b from-green-600 to-green-800 hover:from-green-700 hover:to-green-900 text-white px-6 py-3 rounded-lg font-semibold text-sm md:text-base shadow-lg">
                                        <i class="bi bi-cloud-upload-fill me-2"></i>ยืนยันและส่งข้อมูล
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- =========== END: แทรกฟอร์มสำรวจข้อมูลพื้นที่ปลูกพืชมุนไพรกระท่อม =========== -->



                    <!-- ปุ่มกลับ -->
                    <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                        <button onclick="showView('form-menu-view')"
                            class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg text-sm transition duration-200">
                            <i class="bi bi-arrow-left me-1"></i>กลับไปเลือกรายการ
                        </button>
                    </div>
                </nav>

                <!-- ข้อความแนะนำ -->
                <div class="mt-6 pt-4 border-t border-gray-200 text-center">
                    <p class="text-xs text-stone-500">💡 เลือกเมนูที่ต้องการเพื่อดำเนินการต่อ</p>
                </div>
            </div>
        </div>

        <!-- SUBMENU VIEW (จัดการข้อมูล) -->
        <div id="submenu-view" class="space-y-6 hidden">
            <header class="mb-10 text-center">
                <div class="flex justify-end items-center mb-4">
                    <button onclick="logout()"
                        class="bg-red-500 text-white px-4 py-2 rounded-lg text-sm hover:bg-red-600 flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                            stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        ออกจากระบบ
                    </button>
                </div>
                <h2 class="text-2xl font-bold text-stone-800 mb-2">ระบบตัวแทนของบริษัท บ้านไทยเฮิร์บ เซ็นเตอร์ จำกัด
                </h2>
                <p class="text-stone-600">กรุณาเลือกรายการจัดการข้อมูลแร่/นาโน/ค่าสารและอื่นๆ</p>
            </header>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Card A: Sheet A - Farm & Farmer Info -->
                <div class="portal-card cursor-pointer" onclick="showView('sheet-a-view')"
                    style="background: linear-gradient(135deg, #A5C9FF, #dae7ff);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-indigo-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">ข้อมูลบริหารจัดการแปลง
                    </h2>
                    <p class="text-sm text-stone-600">บันทึกข้อมูลการรับแร่และนาโน</p>
                </div>

                <div class="portal-card cursor-pointer" onclick="showView('delivery-system-view')"
                    style="background: linear-gradient(135deg, #bbf7d0, #dcfce7);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-green-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">ระบบการจัดส่ง (Production Flow)</h2>
                    <p class="text-sm text-stone-600">บันทึกขั้นตอนการเก็บเกี่ยว คัดแยก และแปรรูป</p>
                </div>

                <div class="portal-card cursor-pointer" onclick="showView('sheet-c-view')"
                    style="background: linear-gradient(135deg, #fdba74, #fed7aa);">
                    <div class="flex items-center justify-center h-16 w-16 bg-white bg-opacity-30 rounded-full mb-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-red-800" fill="none"
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                    </div>
                    <h2 class="text-xl font-bold text-stone-800 mb-2">สรุปข้อมูลเกษตรกรของตัวแทน</h2>
                    <p class="text-sm text-stone-600">ดูและค้นหาข้อมูลทั้งหมดที่บันทึกไว้</p>
                </div>
            </div>
        </div>

        <!-- SHEET A VIEW -->
        <div id="sheet-a-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <button onclick="showView('submenu-view')"
                    class="mb-4 text-green-600 hover:text-green-800 flex items-center text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    กลับหน้าเมนู
                </button>
                <h2 class="text-2xl font-bold text-stone-700">
                    บันทึกข้อมูลการรับแร่และนาโนของเกษตรกร
                </h2>
            </div>
            <form id="sheet-a-form" onsubmit="handleSheetASubmit(event)" class="space-y-6">
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">ตัวแทนที่เกษตรกรสังกัด</h3>
                    <label for="a-long-affiliation" class="block text-sm font-medium mb-1">
                        <span id="long-affiliation-label">กรุณาเลือกตัวแทน</span>
                        <span id="auto-selected-label"
                            class="text-green-600 text-sm hidden">(เลือกอัตโนมัติจากการล็อกอิน)</span>
                    </label>
                    <select id="a-long-affiliation" required class="w-full">
                        <option value="" disabled selected>--- เลือกตัวแทนที่สังกัด ---</option>
                    </select>
                </div>

                <div class="space-y-4 p-4 border rounded-lg">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลส่วนตัวเกษตรกรที่จะรับแร่/นาโน</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="a-fullname" class="block text-sm font-medium mb-1">ชื่อ-สกุล เกษตรกร</label>
                            <input type="text" id="a-fullname" placeholder="ชื่อ-สกุล" required class="w-full">
                        </div>

                    </div>

                    <label for="a-id" class="block text-sm font-medium mb-1">รหัสเกษตรกร: ตัวแทนเป็นผู้กำหนดรหัสเอง<span
                            class="text-red-500">(ตัวแทนต้องตั้งให้เกษตรกรของตัวเอง)</span></label>
                    <input type="text" id="a-id" placeholder="เช่น TEST101 หรือ Test01N " required>

                    <h3 class="sm font-medium pt-2 border-t border-stone-100 text-stone-700">ที่อยู่ปัจจุบัน</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="a-address-tambon" class="block text-sm font-medium mb-1">ตำบล</label>
                            <input type="text" id="a-address-tambon" placeholder="ตำบล" class="w-full">
                        </div>
                        <div>
                            <label for="a-address-amphoe" class="block text-sm font-medium mb-1">อำเภอ</label>
                            <input type="text" id="a-address-amphoe" placeholder="อำเภอ" class="w-full">
                        </div>
                        <div>
                            <label for="a-address-province" class="block text-sm font-medium mb-1">จังหวัด</label>
                            <input type="text" id="a-address-province" placeholder="จังหวัด" class="w-full">
                        </div>
                    </div>
                    <textarea id="a-emergency" rows="2" placeholder="ข้อมูลการติดต่อฉุกเฉินหรือผู้แทน (ถ้ามี)"
                        class="w-full"></textarea>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลแปลง</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="a-gpsx" class="block text-sm font-medium mb-1">พิกัด GPS: X</label>
                            <input type="text" id="a-gpsx" placeholder="เช่น 13.7563" required class="w-full">
                        </div>
                        <div>
                            <label for="a-gpsy" class="block text-sm font-medium mb-1">พิกัด GPS: Y</label>
                            <input type="text" id="a-gpsy" placeholder="เช่น 100.5018" required class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="a-plotsize"
                                class="block text-sm font-medium mb-1">ขนาดแปลงที่ใช้แร่และนาโนจริง</label>
                            <input type="number" id="a-plotsize" placeholder="ขนาดแปลง (ไร่) " required min="0.1"
                                step="0.1" class="w-full">
                            <small class="text-stone-500">หน่วย: ไร่</small>
                        </div>
                        <div class="md:col-span-2">
                            <label for="a-cropspecies"
                                class="block text-sm font-medium mb-1">สายพันธุ์ที่จะใช้กับแร่และนาโน</label>
                            <input type="text" id="a-cropspecies" placeholder="เช่น ก้านแดงหางกั้ง,4ปี">
                        </div>
                    </div>




                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลการรับแร่และนาโน</h3>

                    <!-- ข้อมูลตัวแทนรับแร่ -->
                    <div class="border rounded-lg p-4 bg-purple-50">
                        <h4 class="font-semibold text-purple-800 mb-3">ข้อมูลการรับแร่ของตัวแทน</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-long-receive-mineral-date"
                                    class="block text-sm font-medium mb-1">วันที่ตัวแทนรับแร่จากบริษัท</label>
                                <input type="date" id="a-long-receive-mineral-date" required class="w-full">
                            </div>
                            <div>
                                <label for="a-long-receive-mineral-amount"
                                    class="block text-sm font-medium mb-1">จำนวนแร่ที่ตัวแทนรับไป (กระสอบ)</label>
                                <input type="number" id="a-long-receive-mineral-amount" required min="1" step="1"
                                    class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- ข้อมูลตัวแทนรับนาโน -->
                    <div class="border rounded-lg p-4 bg-indigo-50">
                        <h4 class="font-semibold text-indigo-800 mb-3">ข้อมูลการรับนาโนของตัวแทน</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-long-receive-nano-date"
                                    class="block text-sm font-medium mb-1">วันที่ตัวแทนรับนาโนจากบริษัท</label>
                                <input type="date" id="a-long-receive-nano-date" required class="w-full">
                            </div>
                            <div>
                                <label for="a-long-receive-nano-amount"
                                    class="block text-sm font-medium mb-1">จำนวนนาโนที่ตัวแทนรับไป (ลิตร)</label>
                                <input type="number" id="a-long-receive-nano-amount" required min="0.1" step="0.1"
                                    class="w-full">
                            </div>
                        </div>
                    </div>

                    <!-- ข้อมูลเกษตรกรรับแร่/นาโน -->
                    <div class="border rounded-lg p-4 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-3">ข้อมูลรับแร่/นาโนของเกษตรกร</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label for="a-datecollect"
                                    class="block text-sm font-medium mb-1">วันที่เกษตรกรมารับแร่</label>
                                <input type="date" id="a-datecollect" required class="w-full">
                            </div>
                            <div>
                                <label for="a-sackcollect"
                                    class="block text-sm font-medium mb-1">จำนวนแร่ที่เกษตรกรรับไป (กระสอบ)</label>
                                <input type="number" id="a-sackcollect" required min="1" step="1" class="w-full">
                            </div>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
                            <div>
                                <label for="a-datenano"
                                    class="block text-sm font-medium mb-1">วันที่เกษตรกรมารับนาโน</label>
                                <input type="date" id="a-datenano" required class="w-full">
                            </div>
                            <div>
                                <label for="a-nanoliters"
                                    class="block text-sm font-medium mb-1">จำนวนนาโนที่เกษตรกรรับไป (ลิตร)</label>
                                <input type="number" id="a-nanoliters" required min="0.1" step="0.1" class="w-full">
                            </div>
                        </div>
                    </div>

                    <div>
                        <label for="a-premitra" class="block text-sm font-medium mb-1">ค่าสารก่อนใช้
                            (ไมทราไจนีน)</label>
                        <input type="number" id="a-premitra" required placeholder="ถ้าไม่มีให้ใส่ 0" min="0" step="0.01"
                            class="w-full">
                    </div>
                </div>



                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">บันทึกหน้างาน</h3>

                    <div>
                        <label class="block text-sm font-medium mb-1">ผู้บันทึก</label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="radio" id="a-recorder-long" name="a-recorder" value="ตัวแทน" required
                                class="hidden">
                            <label for="a-recorder-long" class="px-4 py-2 rounded-lg cursor-pointer">ตัวแทน</label>
                        </div>
                    </div>

                    <div>
                        <label for="a-onsitenotes" class="block text-sm font-medium mb-1">บันทึกเพิ่มเติม</label>
                        <textarea id="a-onsitenotes" rows="3" placeholder="บันทึกเพิ่มเติมจากหน้างาน (ถ้ามี)"
                            class="w-full"></textarea>
                    </div>


                </div>

                <button type="submit"
                    class="w-full mt-6 bg-gradient-to-r from-green-600 via-green-500 to-green-400 text-white px-4 py-2 rounded-lg shadow-lg hover:shadow-2xl hover:from-green-700 hover:to-green-500 transition-all duration-300">
                    บันทึกข้อมูล (การรับแร่และนาโน)
                </button>
            </form>
        </div>

        <!-- SHEET B USE VIEW -->
        <div id="sheet-b-use-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <h2 class="text-2xl font-bold text-stone-700">
                    ข้อมูลการใช้แร่และนาโนของเกษตรกร
                </h2>
            </div>
            <form id="sheet-b-use-form" onsubmit="handleSheetBUseSubmit(event)" class="space-y-6">

                <!-- ข้อมูลเกษตรกร (อ้างอิง) -->
                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลเกษตรกร</h3>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="b-long-affiliation-use"
                                class="block text-sm font-medium mb-1">ตัวแทนที่สังกัด</label>
                            <select id="b-long-affiliation-use" required class="w-full">
                                <option value="" disabled selected>--- เลือกตัวแทนที่สังกัด ---</option>
                            </select>
                        </div>
                        <div>
                            <label for="b-farmer-id-use" class="block text-sm font-medium mb-1">รหัสเกษตรกร<span
                                    class="text-red-500">(ใช้รหัสที่ตัวแทนกำหนดให้เท่านั้น)</span></label>
                            <input type="text" id="b-farmer-id-use" placeholder="(Farmer ID)" required class="w-full">
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="b-fullname-use" class="block text-sm font-medium mb-1">ชื่อ-สกุลเกษตรกร
                                *</label>
                            <input type="text" id="b-fullname-use" placeholder="ชื่อ-สกุลเกษตรกร" required
                                class="w-full">
                        </div>

                    </div>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">ข้อมูลการใช้</h3>

                    <!-- วันที่ใส่ปุ๋ยบำรุงดิน -->
                    <div class="border rounded-lg p-4 bg-green-50">
                        <h4 class="font-semibold text-green-800 mb-3">วันที่ใส่ปุ๋ยบำรุงดิน ทุก 4 วัน / 1-2 ครั้ง /
                            สัปดาห์</h4>
                        <div id="fertilizer-usage-container">
                            <div class="fertilizer-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">วันที่ใส่ปุ๋ย</label>
                                    <input type="date" class="fertilizer-date w-full">
                                </div>

                                <div class="md:col-span-2">
                                    <label class="block text-sm font-medium mb-1">บำรุงดินด้วย<span
                                            class="text-xs text-green-600">(เลือกได้มากกว่าหนึ่ง)</span></label>
                                    <div class="radio-group flex flex-wrap gap-2">
                                        <input type="checkbox" id="b-fert-organic" name="fertilizer-type"
                                            value="ปุ๋ยอินทรีย์" class="hidden">
                                        <label for="b-fert-organic"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยอินทรีย์</label>

                                        <input type="checkbox" id="b-fert-chemical" name="fertilizer-type"
                                            value="ปุ๋ยเคมี" class="hidden">
                                        <label for="b-fert-chemical"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยเคมี</label>

                                        <input type="checkbox" id="b-fert-manure" name="fertilizer-type" value="ปุ๋ยคอก"
                                            class="hidden">
                                        <label for="b-fert-manure"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยคอก</label>

                                        <input type="checkbox" id="b-fert-volcanic" name="fertilizer-type"
                                            value="แร่ภูเขาไฟ" class="hidden">
                                        <label for="b-fert-volcanic"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">แร่ภูเขาไฟ</label>

                                        <input type="checkbox" id="b-fert-other" name="fertilizer-type" value="อื่นๆ"
                                            class="hidden" onchange="toggleOtherFertilizerInputUse(this)">
                                        <label for="b-fert-other"
                                            class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">อื่นๆ
                                            (ระบุ)</label>
                                    </div>
                                    <input type="text" id="b-fertilizer-other-text-use"
                                        placeholder="โปรดระบุชนิดปุ๋ยอื่นๆ ที่ใช้"
                                        class="hidden mt-2 w-full fertilizer-other-text">
                                </div>

                                <div class="flex items-end col-span-full">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- วันที่ใช้นาโน -->
                    <div class="border rounded-lg p-4 bg-blue-50">
                        <h4 class="font-semibold text-blue-800 mb-3">วันที่ใช้นาโน ทุก 7 วัน / 4 ครั้ง / เดือน</h4>
                        <div id="nano-usage-container">
                            <div class="nano-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">วันที่ใช้นาโน</label>
                                    <input type="date" class="nano-date w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (ลิตร)</label>
                                    <input type="number" class="nano-amount w-full" min="0.1" step="0.1">
                                </div>
                                <div class="flex items-end">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- วันที่ใช้แร่ -->
                    <div class="border rounded-lg p-4 bg-orange-50">
                        <h4 class="font-semibold text-orange-800 mb-3">วันที่ใช้แร่ ทุก 16 วัน / 2 ครั้ง / เดือน</h4>
                        <div id="mineral-usage-container">
                            <div class="mineral-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                                <div>
                                    <label class="block text-sm font-medium mb-1">วันที่ใช้แร่</label>
                                    <input type="date" class="mineral-date w-full">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (กิโลกรัม)</label>
                                    <input type="number" class="mineral-amount w-full" min="0.1" step="0.1">
                                </div>
                                <div class="flex items-end">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ค่าสารและอัตราการใช้ -->
                <div class="space-y-4 pt-4 border rounded-lg p-4">
                    <h3 class="text-lg font-semibold text-stone-700">อัตราการใช้ </h3>

                    <div>
                        <label class="block text-sm font-medium mb-1">อัตราการใส่แร่ที่แนะนำ (เช่น 1 กระสอบ / 1 ไร่)
                            <span class="text-red-500">กรุณาเลือกก่อนบันทึก</span></label>
                        <div class="radio-group flex items-center flex-wrap gap-2">
                            <input type="radio" id="b-rate-follow" name="b-rate" value="ปฏิบัติตาม" required
                                class="hidden" onchange="toggleAdjustedBRate()">
                            <label for="b-rate-follow" class="px-4 py-2 rounded-lg cursor-pointer">ปฏิบัติตาม</label>

                            <input type="radio" id="b-rate-adjust" name="b-rate" value="ปรับตาม" class="hidden"
                                onchange="toggleAdjustedBRate()">
                            <label for="b-rate-adjust" class="px-4 py-2 rounded-lg cursor-pointer">ปรับตาม</label>

                            <input type="number" id="b-rate-adjusted" placeholder="ระบุอัตรา (กระสอบ/ไร่)" min="0.1"
                                step="0.1" class="hidden ml-4">
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">อัตราการใส่นาโนที่แนะนำ (เช่น 1 ลิตร / 1 ไร่)
                            <span class="text-red-500">กรุณาเลือกก่อนบันทึก</span></label>
                        <div class="radio-group flex items-center flex-wrap gap-2">
                            <input type="radio" id="b-nano-rate-follow" name="b-nano-rate" value="ปฏิบัติตาม" required
                                class="hidden" onchange="toggleAdjustedBNanoRate()">
                            <label for="b-nano-rate-follow"
                                class="px-4 py-2 rounded-lg cursor-pointer">ปฏิบัติตาม</label>

                            <input type="radio" id="b-nano-rate-adjust" name="b-nano-rate" value="ปรับตาม"
                                class="hidden" onchange="toggleAdjustedBNanoRate()">
                            <label for="b-nano-rate-adjust" class="px-4 py-2 rounded-lg cursor-pointer">ปรับตาม</label>

                            <input type="number" id="b-nano-rate-adjusted" placeholder="ระบุอัตรา (ลิตร/ไร่)" min="0.1"
                                step="0.1" class="hidden ml-4">
                        </div>
                    </div>
                </div>

                <div>
                    <div>
                        <label for="b-recorder" class="block text-sm font-medium mb-1">ผู้บันทึก<span
                                class="text-red-500">(ใครเป็นคนบันทึก)</span></label>
                    </div>
                    <div class="radio-group flex flex-wrap gap-2">
                        <input type="radio" id="b-recorder-long" name="b-recorder" value="ตัวแทน" required>
                        <label for="b-recorder-long" class="px-4 py-2 rounded-lg cursor-pointer">ตัวแทน</label>

                        <input type="radio" id="b-recorder-kk" name="b-recorder" value="เกษตรกร" required>
                        <label for="b-recorder-kk" class="px-4 py-2 rounded-lg cursor-pointer">เกษตรกร</label>
                    </div>
                </div>

                <button type="submit"
                    class="w-full mt-6 bg-gradient-to-r from-green-600 via-green-500 to-green-400 text-white px-4 py-2 rounded-lg shadow-lg hover:shadow-2xl hover:from-green-700 hover:to-green-500 transition-all duration-300">
                    บันทึกข้อมูลการใช้ 4-7-16
                </button>
            </form>
        </div>

        <!-- SHEET C VIEW -->
        <div id="sheet-c-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <button onclick="showView('submenu-view')"
                    class="mb-4 text-orange-600 hover:text-orange-800 flex items-center text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    กลับหน้าเมนู
                </button>
                <h2 class="text-2xl font-bold text-stone-700">
                    สรุปข้อมูลเกษตรกรทั้งหมดของตัวแทน
                </h2>
            </div>

            <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                <h3 class="text-lg font-semibold text-stone-700">ข้อมูลเกษตรกรของคุณ</h3>

                <div class="flex flex-col md:flex-row gap-4 items-center">
                    <div class="flex-grow">
                        <p class="text-sm text-stone-600" id="auto-long-name">
                            <!-- แสดงชื่อตัวแทนอัตโนมัติ -->
                        </p>
                    </div>
                    <div>
                        <button onclick="fetchSummaryData()"
                            class="search-button py-2.5 px-6 rounded-lg whitespace-nowrap flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2"
                                stroke="currentColor" class="w-5 h-5 mr-1">
                                <path stroke-linecap="round" stroke-linejoin="round"
                                    d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                            </svg>
                            โหลดข้อมูลเกษตรกร
                        </button>
                    </div>
                </div>
                <div id="summary-count" class="text-sm text-stone-600 font-semibold">
                    กดปุ่ม "โหลดข้อมูลเกษตรกร" เพื่อดูข้อมูล
                </div>
            </div>

            <!-- Data Display Section -->
            <div id="summary-data-container"
                class="overflow-x-auto rounded-xl border border-stone-200 shadow-lg hidden">
                <table class="min-w-full divide-y divide-gray-300 data-table">
                    <thead class="bg-stone-100">
                        <tr class="text-sm uppercase text-stone-700">
                            <th class="px-4 py-3 text-left">รหัสเกษตรกร</th>
                            <th class="px-4 py-3 text-left">ชื่อ-สกุล</th>
                            <th class="px-4 py-3 text-left">เบอร์โทร</th>
                            <th class="px-4 py-3 text-left">ขนาดแปลง</th>
                            <th class="px-4 py-3 text-left">สายพันธุ์</th>
                            <th class="px-4 py-3 text-left">วันที่รับแร่</th>
                            <th class="px-4 py-3 text-left">จำนวนแร่</th>
                            <th class="px-4 py-3 text-left">วันที่รับนาโน</th>
                            <th class="px-4 py-3 text-left">จำนวนนาโน</th>
                            <th class="px-4 py-3 text-left">ค่าสารก่อนใช้</th>
                            <th class="px-4 py-3 text-left">สถานะ</th>
                        </tr>
                    </thead>
                    <tbody id="summary-table-body" class="divide-y divide-gray-200 text-sm bg-white">
                        <!-- Data will be populated here -->
                    </tbody>
                </table>
            </div>

            <div id="summary-loading" class="text-center p-8 text-stone-500 hidden">
                <div
                    class="animate-spin rounded-full h-8 w-8 border-2 border-stone-400 border-t-stone-800 mx-auto mb-2">
                </div>
                กำลังดึงข้อมูล...
            </div>

            <div id="summary-empty" class="text-center p-8 text-stone-500 hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto mb-2 text-stone-400" fill="none"
                    viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <p>ไม่พบข้อมูลเกษตรกรสำหรับตัวแทนนี้</p>
            </div>
        </div>

        <!-- DELIVERY SYSTEM VIEW -->
        <div id="delivery-system-view" class="space-y-6 hidden">
            <div class="w-full pt-6 pb-2 px-6">
                <button onclick="showView('submenu-view')"
                    class="mb-4 text-green-700 hover:text-green-900 flex items-center text-sm font-medium">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                    กลับหน้าเมนู
                </button>
                <h2 class="text-2xl font-bold text-stone-700">
                    ระบบการจัดส่ง (Production Flow)
                </h2>
                <div class="flex justify-between items-center mt-2">
                    <p class="text-sm text-stone-600">จัดการ Lot การผลิต และบันทึกขั้นตอนต่างๆ</p>
                    <div class="flex gap-2">
                        <button onclick="showDeliveryNewLotModal(true)"
                            class="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-blue-700 shadow-md flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path
                                    d="M8.707 7.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l2-2a1 1 0 00-1.414-1.414L11 7.586V3a1 1 0 10-2 0v4.586l-.293-.293z" />
                                <path
                                    d="M3 9a2 2 0 012-2h1a1 1 0 110 2H5v8a2 2 0 002 2h6a2 2 0 002-2v-8h-1a1 1 0 110-2h1a2 2 0 012 2v8a2 2 0 01-2 2H7a2 2 0 01-2-2V9z" />
                            </svg>
                            รับซื้อ (Receive)
                        </button>
                        <button onclick="showDeliveryNewLotModal(false)"
                            class="bg-green-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-green-700 shadow-md flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z"
                                    clip-rule="evenodd" />
                            </svg>
                            เก็บเกี่ยว (Harvest)
                        </button>
                        <button id="combine-cleaning-btn" onclick="showCombinedCleaningModal()"
                            class="hidden bg-cyan-600 text-white px-4 py-2 rounded-lg text-sm hover:bg-cyan-700 shadow-md flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20"
                                fill="currentColor">
                                <path fill-rule="evenodd"
                                    d="M6.267 3.455a3.066 3.066 0 001.745-.723 3.066 3.066 0 013.976 0 3.066 3.066 0 001.745.723 3.066 3.066 0 012.812 2.812c.051.643.304 1.254.723 1.745a3.066 3.066 0 010 3.976 3.066 3.066 0 00-.723 1.745 3.066 3.066 0 01-2.812 2.812 3.066 3.066 0 00-1.745.723 3.066 3.066 0 01-3.976 0 3.066 3.066 0 00-1.745-.723 3.066 3.066 0 01-2.812-2.812 3.066 3.066 0 00-.723-1.745 3.066 3.066 0 010-3.976 3.066 3.066 0 00.723-1.745 3.066 3.066 0 012.812-2.812zm7.44 5.252a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z"
                                    clip-rule="evenodd" />
                            </svg>
                            <span>รวมล้าง (0)</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Active Lots Container -->
            <div id="delivery-active-lots-container" class="px-6 space-y-4">
                <!-- Dynamic Content -->
                <div class="text-center py-10 text-gray-500">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    กำลังโหลดข้อมูล Lot...
                </div>
            </div>

            <!-- Forms Modal/Overlay -->
            <div id="delivery-form-overlay"
                class="fixed inset-0 z-50 flex items-center justify-center hidden bg-black bg-opacity-50 overflow-y-auto"
                onclick="if(event.target === this) closeDeliveryForm()">
                <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl mx-4 my-8 overflow-hidden relative"
                    onclick="event.stopPropagation()">
                    <div class="px-6 py-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                        <h3 id="delivery-form-title" class="text-lg font-bold text-gray-800">บันทึกขั้นตอน</h3>
                        <button onclick="closeDeliveryForm()" class="text-gray-400 hover:text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div id="delivery-form-content" class="p-6 max-h-[80vh] overflow-y-auto">
                        <!-- Dynamic Form Content Injected Here -->
                    </div>

                    <div class="px-6 py-4 bg-gray-50 border-t border-gray-100 flex justify-end gap-3">
                        <button type="button" onclick="closeDeliveryForm()"
                            class="px-4 py-2 bg-white border border-gray-300 rounded text-gray-700 hover:bg-gray-50">ยกเลิก</button>
                        <button type="button" id="delivery-form-submit-btn" onclick="submitDeliveryForm()"
                            class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 shadow-sm">บันทึก</button>
                    </div>
                </div>
            </div>

            <div id="admin-view" class="space-y-6 hidden overflow-y-auto max-h-screen">

                <div class="w-full pt-6 pb-2 px-6">
                    <h2 class="text-2xl font-bold text-stone-700">
                        หน้าผู้ดูแลระบบ (Admin)
                    </h2>
                </div>

                <div class="space-y-4 pt-4 border rounded-lg p-4 bg-stone-50">
                    <div class="flex items-center justify-between gap-4">
                        <div>
                            <p class="text-sm text-stone-600">เข้าสู่ระบบ: <span id="admin-current-user"
                                    class="font-semibold"></span></p>
                        </div>
                        <div class="flex gap-2">
                            <button id="admin-refresh-btn"
                                class="bg-gradient-to-r from-green-600 via-green-500 to-green-400 text-white px-4 py-2 rounded-lg shadow-lg hover:shadow-2xl hover:from-green-700 hover:to-green-500 transition-all duration-300"
                                onclick="adminCheckAuthAndInit()">
                                โหลดสถานะ / รีเฟรช
                            </button>
                            <button id="admin-logout-btn"
                                class="bg-gradient-to-r from-red-600 via-red-500 to-red-400 text-white px-4 py-2 rounded-lg shadow-lg hover:shadow-2xl hover:from-red-700 hover:to-red-500 transition-all duration-300"
                                onclick="adminForceLogout()">
                                ออกระบบ
                            </button>
                        </div>
                    </div>
                    <div id="admin-access-warning" class="text-red-600 text-sm hidden">
                        คุณไม่มีสิทธิ์เข้าถึงหน้านี้
                    </div>
                </div>

                <nav class="nav-tabs">

                    <button class="nav-tab active" data-target="admin-kratom" data-section-color="orange"
                        onclick="showSection('admin-kratom', this)">ดูข้อมูลทั้งหมด</button>

                    <button class="nav-tab" data-target="admin-production" data-section-color="green"
                        onclick="showSection('admin-production', this)">Production Dashboard</button>

                    <button class="nav-tab" data-target="admin-lounge" data-section-color="blue"
                        onclick="showSection('admin-lounge', this)">Thailand Kratom GACP</button>
                </nav>

                <!-- Production Dashboard Section -->
                <div id="admin-production" class="content-section hidden">
                    <div class="w-full pt-6 pb-2 px-6 flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-stone-700">
                            ภาพรวมการผลิต (Production Overview)
                        </h2>
                        <button onclick="adminInitProductionDashboard()"
                            class="text-sm bg-green-100 text-green-700 px-3 py-1 rounded hover:bg-green-200">
                            รีเฟรชข้อมูล
                        </button>
                    </div>

                    <div class="px-6 space-y-6">
                        <!-- Key Metrics -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                            <div class="bg-white p-4 rounded-lg shadow border border-gray-100">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase">Total Lots</h3>
                                <p class="text-2xl font-bold text-gray-800" id="ad-prod-total">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow border border-gray-100">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase">Active Lots</h3>
                                <p class="text-2xl font-bold text-blue-600" id="ad-prod-active">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow border border-gray-100">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase">Completed</h3>
                                <p class="text-2xl font-bold text-green-600" id="ad-prod-completed">0</p>
                            </div>
                            <div class="bg-white p-4 rounded-lg shadow border border-gray-100">
                                <h3 class="text-xs font-semibold text-gray-500 uppercase">Risk Alerts</h3>
                                <p class="text-2xl font-bold text-red-600" id="ad-prod-risk">0</p>
                            </div>
                        </div>

                        <!-- Charts / Breakdown -->
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 class="font-bold text-gray-700 mb-4">สถานะปัจจุบัน (By State)</h3>
                                <div id="ad-prod-state-breakdown" class="space-y-3">
                                    <!-- Dynamic Bars -->
                                    <div class="text-center text-gray-400 py-4">กำลังโหลด...</div>
                                </div>
                            </div>

                            <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                                <h3 class="font-bold text-gray-700 mb-4">Risk Analysis (Behavioral Signals)</h3>
                                <div class="overflow-y-auto max-h-[300px]">
                                    <table class="min-w-full text-sm">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="px-3 py-2 text-left">Lot ID</th>
                                                <th class="px-3 py-2 text-left">Risk Score</th>
                                                <th class="px-3 py-2 text-left">Flags</th>
                                            </tr>
                                        </thead>
                                        <tbody id="ad-prod-risk-table">
                                            <!-- Dynamic Rows -->
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- All Lots Table -->
                        <div class="bg-white p-6 rounded-lg shadow-sm border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-4">รายการ Lot ทั้งหมด</h3>
                            <div class="overflow-x-auto">
                                <table class="min-w-full text-sm divide-y divide-gray-200">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left">Lot ID</th>
                                            <th class="px-4 py-3 text-left">State</th>
                                            <th class="px-4 py-3 text-left">Agent</th>
                                            <th class="px-4 py-3 text-left">Farmer</th>
                                            <th class="px-4 py-3 text-left">Updated</th>
                                            <th class="px-4 py-3 text-left">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="ad-prod-lots-table" class="bg-white divide-y divide-gray-200">
                                        <!-- Dynamic Rows -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-kratom" class="content-section active">
                    <div class="w-full pt-6 pb-2 px-6">
                        <h2 class="text-2xl font-bold text-stone-700">
                            หน้าเพื่อดูและดาวน์โหลดข้อมูลทุกไฟล์ Sheet A / Sheet B / สรุป
                        </h2>
                    </div>

                    <div id="admin-controls" class="space-y-4 hidden">
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <button id="btn-fetch-farmers" class="pastel-button py-3" onclick="adminFetchAllFarmers()">
                                ดึงข้อมูลทั้งหมด (Sheet A)
                            </button>
                            <button id="btn-fetch-usage" class="search-button py-3" onclick="adminFetchAllUsage()">
                                ดึงข้อมูลการใช้ (Sheet B)
                            </button>
                            <button id="btn-fetch-merged" class="blue-button py-3" onclick="adminFetchMerged()">
                                ดึงข้อมูลรวม (Merge)
                            </button>
                        </div>

                        <div class="flex gap-3">
                            <input id="admin-search-input" type="text" placeholder="ค้นหาตามรหัส หรือ ชื่อ"
                                maxlength="100" class="w-full p-2 border rounded" />
                            <button id="admin-search-btn" class="search-button px-4"
                                onclick="adminFilterTable()">ค้นหา</button>
                            <button id="admin-export-btn" class="pastel-button px-4"
                                onclick="adminExportCurrentToCSV()">ดาวน์โหลด
                                CSV</button>
                        </div>

                        <div id="admin-loading" class="text-center p-6 hidden">
                            <div class="loading-spinner mx-auto mb-2"></div>
                            กำลังโหลดข้อมูล...
                        </div>

                        <div id="admin-results" class="space-y-4">
                            <div id="admin-table-wrapper" class="overflow-x-auto bg-white rounded-lg border p-4 hidden">
                                <h3 class="font-semibold text-stone-700 mb-2">ผลลัพธ์</h3>
                                <div id="admin-table-container" class="admin-table-scroll"></div>
                            </div>

                            <div id="admin-empty" class="text-stone-500 p-4 hidden">
                                ยังไม่มีข้อมูลที่จะแสดง
                            </div>
                        </div>
                    </div>
                </div>

                <div id="admin-lounge" class="content-section hidden bg-slate-100 font-sans">
                    <!-- Sidebar -->
                    <div id="gacp-sidebar" class="bg-slate-900 text-white shadow-2xl flex flex-col">
                        <div class="flex items-center justify-between p-6 border-b border-slate-800 bg-slate-900">
                            <h1 class="text-xl font-bold flex items-center gap-2 text-emerald-400">
                                <i data-lucide="leaf" class="w-6 h-6"></i> GACP <span
                                    class="text-[10px] bg-emerald-500/20 px-2 py-0.5 rounded text-emerald-300">v1.0</span>
                            </h1>
                            <button onclick="toggleGACPSidebar(false)" class="md:hidden p-1 hover:bg-slate-800 rounded">
                                <i data-lucide="x" class="w-6 h-6"></i>
                            </button>
                        </div>
                        <nav id="gacp-menu" class="mt-2 flex-1 overflow-y-auto custom-scrollbar">
                            <!-- Menu items will be injected here -->
                        </nav>
                    </div>

                    <!-- Mobile Sidebar Overlay -->
                    <div class="gacp-sidebar-overlay" onclick="toggleGACPSidebar(false)"></div>

                    <!-- Main Content -->
                    <main class="flex-1 overflow-y-auto p-4 md:p-8 lg:p-12 custom-scrollbar relative w-full">
                        <!-- Mobile Menu Trigger -->
                        <button onclick="toggleGACPSidebar(true)"
                            class="md:hidden absolute top-4 left-4 p-2 bg-white rounded-lg shadow-md z-40 text-slate-700">
                            <i data-lucide="menu" class="w-6 h-6"></i>
                        </button>

                        <!-- Header Section -->
                        <div
                            class="flex flex-col md:flex-row md:items-center justify-between mb-10 gap-4 md:gap-6 mt-12 md:mt-0">
                            <div>
                                <h1 class="text-3xl md:text-4xl font-black text-slate-900 tracking-tighter">Thailand
                                    Kratom
                                    GACP System</h1>
                                <p
                                    class="text-slate-500 font-bold text-xs uppercase tracking-[0.2em] mt-2 flex items-center gap-2">
                                    <span class="w-8 h-[2px] bg-emerald-500"></span>
                                    ระบบตรวจรับรองมาตรฐานพืชกระท่อม
                                </p>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="exportToPDF()"
                                    class="hidden md:flex items-center gap-2.5 bg-white text-slate-700 px-8 py-4 rounded-3xl font-black text-sm border border-slate-200 shadow-sm hover:bg-slate-50 transition-all active:scale-95">
                                    <i data-lucide="download" class="w-5 h-5"></i> รายงาน PDF
                                </button>
                                <button id="gacp-save-btn" onclick="saveGACPData()"
                                    class="flex items-center gap-2.5 px-8 py-4 rounded-3xl font-black text-sm shadow-xl transition-all active:scale-95 bg-emerald-600 text-white shadow-emerald-600/30 hover:bg-emerald-700">
                                    <i data-lucide="save" class="w-5 h-5"></i>
                                    <span>บันทึกข้อมูล</span>
                                </button>
                            </div>
                        </div>

                        <!-- Dynamic Content Area -->
                        <div id="gacp-content-area" class="animate-in fade-in duration-500">
                            <!-- Dashboard or Sections will be rendered here -->
                        </div>
                    </main>

                    <!-- Criteria Modal Overlay -->
                    <div id="gacp-criteria-modal"
                        class="fixed inset-0 bg-black/50 z-[60] hidden flex items-center justify-center p-4">
                        <div
                            class="bg-slate-900 text-white rounded-[2rem] p-8 md:p-10 shadow-2xl border border-slate-700 max-w-4xl w-full max-h-[90vh] overflow-y-auto animate-in zoom-in duration-300 relative">
                            <div class="flex justify-between items-center mb-8">
                                <h3 class="text-xl font-black flex items-center gap-4">
                                    <i data-lucide="alert-circle" class="text-amber-400 w-7 h-7"></i>
                                    ตารางค่ามาตรฐานความปลอดภัย
                                </h3>
                                <button onclick="toggleCriteriaModal(false)"
                                    class="bg-slate-800 p-2.5 rounded-full hover:bg-slate-700 transition-colors"><i
                                        data-lucide="x" class="w-5 h-5"></i></button>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-6">
                                <div class="flex justify-between items-center border-b border-slate-800 pb-4"><span
                                        class="text-slate-400 font-bold">ตะกั่ว (Pb)</span><span
                                        class="font-mono text-emerald-400 font-black bg-emerald-400/10 px-3 py-1 rounded-lg text-sm">ไม่เกิน
                                        10.0 มก./กก.</span></div>
                                <div class="flex justify-between items-center border-b border-slate-800 pb-4"><span
                                        class="text-slate-400 font-bold">สารหนู (As)</span><span
                                        class="font-mono text-emerald-400 font-black bg-emerald-400/10 px-3 py-1 rounded-lg text-sm">ไม่เกิน
                                        5.0 มก./กก.</span></div>
                                <div class="flex justify-between items-center border-b border-slate-800 pb-4"><span
                                        class="text-slate-400 font-bold">ปรอท (Hg)</span><span
                                        class="font-mono text-emerald-400 font-black bg-emerald-400/10 px-3 py-1 rounded-lg text-sm">ไม่เกิน
                                        0.5 มก./กก.</span></div>
                                <div class="flex justify-between items-center border-b border-slate-800 pb-4"><span
                                        class="text-slate-400 font-bold">แคดเมียม (Cd)</span><span
                                        class="font-mono text-emerald-400 font-black bg-emerald-400/10 px-3 py-1 rounded-lg text-sm">ไม่เกิน
                                        0.3 มก./กก.</span></div>
                                <div class="flex justify-between items-center border-b border-slate-800 pb-4"><span
                                        class="text-slate-400 font-bold">แมงกานีส (Mn)</span><span
                                        class="font-mono text-emerald-400 font-black bg-emerald-400/10 px-3 py-1 rounded-lg text-sm">ไม่เกิน
                                        200.0 มก./กก.</span></div>
                                <div class="flex justify-between items-center border-b border-slate-800 pb-4"><span
                                        class="text-slate-400 font-bold">DDT / Endosulfan</span><span
                                        class="font-mono text-emerald-400 font-black bg-emerald-400/10 px-3 py-1 rounded-lg text-sm">1.0
                                        / 3.0 มก./กก.</span></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

        <script>

            // =============================================
            // CONSTANTS & CONFIGURATION
            // =============================================
            const isGitHubPages = window.location.hostname.includes('github.io');
            const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbzkxJUonNQ4RKGcM-JkVPLBKClQw_L9lm7nA7zjUu-dWD7sw36WrpdSAthB_QcQ7zlH/exec';

            // =============================================
            // CONSTANTS
            // =============================================
            const LONG_OPTIONS = [
                { value: "", text: "--- เลือกตัวแทนที่สังกัด ---" },
                { value: "ตัวแทนบาสBDS", text: "ตัวแทนบาสBDS" },
                { value: "ตัวแทนHunterเวียงแก่น", text: "ตัวแทนHunterเวียงแก่น" },
                { value: "ตัวแทนก้ามท่าแค", text: "ตัวแทนก้ามท่าแค" },
                { value: "ตัวแทนกระรอก", text: "ตัวแทนกระรอก" },
                { value: "ตัวแทนรัชช์เมืองนคร", text: "ตัวแทนรัชช์เมืองนคร" },
                { value: "ตัวแทนตูนบางขัน", text: "ตัวแทนตูนบางขัน" },
                { value: "ตัวแทนป๋องส์เมืองพัทลุง", text: "ตัวแทนป๋องส์เมืองพัทลุง" },
                { value: "ตัวแทนบจก.จินดารัตน์ โปรดักส์", text: "ตัวแทนบจก.จินดารัตน์ โปรดักส์" },
                { value: "ตัวแทนดอน", text: "ตัวแทนดอน" },
                { value: "ตัวแทนเตยเกรซ", text: "ตัวแทนเตยเกรซ" },
                { value: "ตัวแทนสมพงศ์พะยูนตรัง", text: "ตัวแทนสมพงศ์พะยูนตรัง" },
                { value: "ตัวแทนกระท่อมปลอดสารคลองใหม่พัทลุง", text: "ตัวแทนกระท่อมปลอดสารคลองใหม่พัทลุง" },
                { value: "ตัวแทนหรั่งนุ้ยพระนคร", text: "ตัวแทนหรั่งนุ้ยพระนคร" },
                { value: "ตัวแทนเปรี้ยวหล่มสัก", text: "ตัวแทนเปรี้ยวหล่มสัก" },
                { value: "ตัวแทนพี.เจ.กระท่อมทอง", text: "ตัวแทนพี.เจ.กระท่อมทอง" },
                { value: "ตัวแทนทรัพย์มะรุมฟาร์ม", text: "ตัวแทนทรัพย์มะรุมฟาร์ม" },
                { value: "ตัวแทนสวนอิน-จักรภัทร", text: "ตัวแทนสวนอิน-จักรภัทร" },
                { value: "ตัวแทนรักษ์อุทัย", text: "ตัวแทนรักษ์อุทัย" },
                { value: "ตัวแทนวิทย์วิสาหกิจชุมชนชาววัง", text: "ตัวแทนวิทย์วิสาหกิจชุมชนชาววัง" },
                { value: "ตัวแทนสาโรจน์", text: "ตัวแทนสาโรจน์" },
            ];

            // Timing constants for consistent delays across the application
            const DROPDOWN_SELECT_DELAY_MS = 50;         // Delay after populate before auto-select
            const DROPDOWN_RETRY_DELAY_MS = 100;         // Delay between retry attempts
            const DROPDOWN_RETRY_TOTAL_DELAY_MS = 200;   // Total delay for full retry sequence
            const DOM_READY_DELAY_MS = 100;              // Delay for DOM to be fully ready

            // Partial matching constants
            const MIN_NAME_LENGTH_FOR_PARTIAL_MATCH = 6; // Minimum chars in normalized name to attempt partial matching
            // Prevents matching generic prefixes like "ตัวแทน"

            /**
             * Normalize longName for backward compatibility
             * Converts "ล้ง" prefix to "ตัวแทน" prefix
             * Removes all "พี่" characters from the name
             */
            function normalizeLongName(longName) {
                if (!longName) return longName;

                let normalized = longName;

                // If it starts with "ล้ง", replace with "ตัวแทน"
                if (normalized.startsWith('ล้ง')) {
                    normalized = normalized.replace(/^ล้ง/, 'ตัวแทน');
                    console.log(`🔄 Normalized (ล้ง→ตัวแทน): "${longName}" → "${normalized}"`);
                }

                // Remove all "พี่" characters from the name
                // This handles cases like "ตัวแทนพี่บาสBDS" → "ตัวแทนบาสBDS"
                // and "ตัวแทนพี่เตยพี่เกรซ" → "ตัวแทนเตยเกรซ"
                if (normalized.includes('พี่')) {
                    const beforeRemoval = normalized;
                    normalized = normalized.replace(/พี่/g, '');
                    console.log(`🔄 Normalized (removed พี่): "${beforeRemoval}" → "${normalized}"`);
                }

                return normalized;
            }

            // Check if running externally (GitHub Pages, Localhost, etc.) where google.script.run is missing
            if (typeof google === 'undefined') {
                // Create mock google.script.run for GitHub Pages
                window.google = {
                    script: {
                        run: {
                            withSuccessHandler: function (successCallback) {
                                this._success = successCallback;
                                return this;
                            },
                            withFailureHandler: function (failureCallback) {
                                this._failure = failureCallback;
                                return this;
                            },
                            withUserObject: function (userObject) {
                                this._userObject = userObject;
                                return this;
                            }
                        }
                    }
                };

                // Add proxy functions for each backend function
                const backendFunctions = [
                    'userLogin', 'writeSheetA', 'writeSheetB', 'submitForm',
                    'searchFarmerData', 'getAllFarmersByLong', 'searchSheetBData',
                    'createNewSheetForLong', 'getAllFarmers', 'getAllUsage', 'getAllMerged',
                    'getAgentLots', 'createLot', 'updateLotState', 'getFarmersWithSheetBRecords',
                    'updateMultipleLotState'
                ];

                backendFunctions.forEach(funcName => {
                    google.script.run[funcName] = function (...args) {
                        const self = google.script.run;

                        // Call backend via fetch
                        fetch(BACKEND_URL, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/x-www-form-urlencoded',
                            },
                            body: new URLSearchParams({
                                function: funcName,
                                args: JSON.stringify(args)
                            })
                        })
                            .then(response => response.json())
                            .then(result => {
                                if (self._success) {
                                    self._success.call(null, result, self._userObject);
                                }
                            })
                            .catch(error => {
                                if (self._failure) {
                                    self._failure.call(null, error, self._userObject);
                                }
                            });
                    };
                });
            }

            let currentView = 'main-menu-view';
            let previousView = null;

            // Helper: safe JSON parse that supports object input and string input.
            function safeParseJSON(input) {
                if (input === null || input === undefined) return null;
                if (typeof input === 'object') return input;
                try {
                    return JSON.parse(input);
                } catch (e) {
                    console.warn('safeParseJSON: invalid JSON input', e, input);
                    return null;
                }
            }

            // =============================================
            // UTILITY FUNCTIONS
            // =============================================
            function showMessageBox(title, content) {
                const messageBox = document.getElementById('message-box');
                const messageTitle = document.getElementById('message-title');
                const messageContent = document.getElementById('message-content');

                if (!messageBox || !messageTitle || !messageContent) {
                    console.error('❌ ไม่พบ element ของ message box');
                    alert(`${title}\n\n${content}`);
                    return;
                }

                messageTitle.textContent = title;
                messageContent.style.whiteSpace = 'pre-line';
                // Allow HTML in content (we assume inputs are trusted in this internal app).
                messageContent.innerHTML = content;

                messageBox.classList.remove('hidden');
            }

            function hideMessageBox() {
                const messageBox = document.getElementById('message-box');
                if (messageBox) {
                    messageBox.classList.add('hidden');
                }
            }

            function isAppsScriptReady(handlerName, callback) {
                if (typeof google === 'undefined' || typeof google.script === 'undefined' || typeof google.script.run === 'undefined') {
                    const errorMessage = `❌ [${handlerName}] Google Apps Script API (google.script.run) ไม่พร้อมใช้งาน. โปรดตรวจสอบว่ารันในสภาพแวดล้อม Google Sheets Web App หรือไม่.`;
                    console.error(errorMessage);

                    if (handlerName.includes('Submission') || handlerName.includes('Data Fetching')) {
                        showMessageBox("❌ ข้อผิดพลาดการเชื่อมต่อ!", errorMessage);
                    }

                    const submitAButton = document.querySelector('#sheet-a-form button[type="submit"]');
                    if (submitAButton) {
                        submitAButton.disabled = true;
                    }

                    const fetchButton = document.getElementById('fetch-data-btn');
                    if (fetchButton) {
                        fetchButton.disabled = true;
                        fetchButton.innerHTML = 'ค้นหา';
                    }

                    if (callback) {
                        callback({ success: false, message: errorMessage, data: null });
                    }
                    return false;
                }

                const fetchButton = document.getElementById('fetch-data-btn');
                if (fetchButton) {
                    fetchButton.disabled = false;
                }
                return true;
            }

            // =============================================
            // MOBILE MENU TOGGLE
            // =============================================
            function toggleMobileMenu() {
                const mobileMenu = document.getElementById('mobile-menu');
                if (mobileMenu) {
                    mobileMenu.classList.toggle('hidden');
                }
            }

            // =============================================
            // NAVIGATION FUNCTIONS
            // =============================================
            function showView(viewId) {
                const allViews = [
                    'main-menu-view',
                    'submenu-view',
                    'form-menu-view',
                    'sheet-a-view',
                    'sheet-b-use-view',
                    'sheet-c-view',
                    'delivery-system-view',
                    'admin-view'
                ];

                allViews.forEach(id => {
                    const view = document.getElementById(id);
                    if (view) {
                        view.classList.add('hidden');
                    }
                });

                const targetView = document.getElementById(viewId);
                if (targetView) {
                    targetView.classList.remove('hidden');
                }

                if (viewId === 'sheet-c-view') {
                    updateSummaryView();
                }

                if (viewId === 'sheet-a-view') {
                    updateSheetALongDropdown();
                }

                // Update long dropdowns for Sheet B view when user is logged in
                if (viewId === 'sheet-b-view') {
                    console.log(`📋 Showing ${viewId}, checking login status...`);
                    const currentUser = checkLoginStatus();
                    if (currentUser && currentUser.longName) {
                        console.log(`✅ User logged in: ${currentUser.longName}`);
                        updateAllLongDropdowns(currentUser.longName);
                    } else {
                        console.log('❌ No user logged in or no longName');
                    }
                }

                // For sheet-b-use-view, optionally auto-select if user is logged in, but don't require it
                if (viewId === 'sheet-b-use-view') {
                    const currentUser = checkLoginStatus();
                    if (currentUser && currentUser.longName) {
                        console.log(`✅ User logged in as ${currentUser.longName}, auto-selecting dropdown`);
                        updateAllLongDropdowns(currentUser.longName);
                    }
                    // No error message if not logged in - this is allowed
                }

                updateBackButton(viewId);

                previousView = currentView;
                currentView = viewId;

                window.scrollTo(0, 0);
            }

            function goBack() {
                if (currentView === 'admin-view') {
                    console.log('goBack: current view is admin-view — no action performed.');
                    return;
                }
                if (currentView === 'form-menu-view') {
                    showView('main-menu-view');
                } else if (currentView === 'sheet-a-view' || currentView === 'sheet-c-view') {
                    showView('submenu-view');
                } else if (currentView === 'sheet-b-use-view') {
                    showView('main-menu-view');
                } else {
                    showView('main-menu-view');
                }
            }

            function updateBackButton(viewId) {
                const backButton = document.getElementById('back-button');
                if (backButton) {
                    // Hide back button for main-menu, submenu, and views accessed from submenu
                    const hideBackViews = ['main-menu-view', 'submenu-view', 'sheet-a-view', 'delivery-system-view', 'sheet-c-view'];
                    if (hideBackViews.includes(viewId)) {
                        backButton.classList.add('hidden');
                    } else {
                        backButton.classList.remove('hidden');
                    }
                }
            }

            function updateSummaryView() {
                const currentUser = checkLoginStatus();
                const autoLongElement = document.getElementById('auto-long-name');

                if (currentUser && autoLongElement) {
                    autoLongElement.textContent = `ตัวแทน: ${currentUser.longName}`;

                    document.getElementById('summary-data-container').classList.add('hidden');
                    document.getElementById('summary-empty').classList.add('hidden');
                    document.getElementById('summary-count').textContent = 'กดปุ่ม "โหลดข้อมูลเกษตรกร" เพื่อดูข้อมูล';
                    document.getElementById('summary-count').className = 'text-sm text-stone-600 font-semibold';
                }
            }

            // =============================================
            // FORM HANDLING FUNCTIONS
            // =============================================
            function toggleOtherWateringInput() {
                const otherInput = document.getElementById('a-watering-other-text');
                const otherRadio = document.getElementById('water-other');
                if (otherInput && otherRadio) {
                    if (otherRadio.checked) {
                        otherInput.classList.remove('hidden');
                        otherInput.required = true;
                    } else {
                        otherInput.classList.add('hidden');
                        otherInput.required = false;
                        otherInput.value = '';
                    }
                }
            }

            function toggleOtherFertilizerInput() {
                const otherInput = document.getElementById('a-fertilizer-other-text');
                const otherRadio = document.getElementById('fert_other');
                if (otherRadio && otherInput) {
                    if (otherRadio.checked) {
                        otherInput.classList.remove('hidden');
                        otherInput.required = true;
                    } else {
                        otherInput.classList.add('hidden');
                        otherInput.required = false;
                        otherInput.value = '';
                    }
                }
            }

            function populateLongOptions() {
                console.log('🔄 populateLongOptions: Starting dropdown population...');

                const selectA = document.getElementById('a-long-affiliation');
                const selectB = document.getElementById('b-long-affiliation');
                const selectBUse = document.getElementById('b-long-affiliation-use');

                const selectElements = [selectA, selectB, selectBUse].filter(el => el !== null);

                if (selectElements.length === 0) {
                    console.error('❌ populateLongOptions: No dropdown elements found!');
                    return false;
                }

                console.log(`🔄 populateLongOptions: Found ${selectElements.length} dropdown(s) to populate`);

                // Validate LONG_OPTIONS structure (it's defined as const but we check runtime structure)
                if (!Array.isArray(LONG_OPTIONS) || LONG_OPTIONS.length === 0) {
                    console.error('❌ populateLongOptions: LONG_OPTIONS is empty or invalid structure');
                    return false;
                }

                let successCount = 0;
                selectElements.forEach(selectEl => {
                    try {
                        const elementId = selectEl.id;

                        // Clear existing options
                        while (selectEl.options.length > 0) {
                            selectEl.remove(0);
                        }

                        // Populate with LONG_OPTIONS
                        LONG_OPTIONS.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option.value;
                            opt.textContent = option.text;
                            selectEl.appendChild(opt);
                        });

                        // Set first option as disabled placeholder
                        if (selectEl.options.length > 0) {
                            selectEl.options[0].disabled = true;
                            selectEl.options[0].selected = true;
                        }

                        successCount++;
                        console.log(`✅ populateLongOptions: Populated ${elementId} with ${selectEl.options.length} options`);
                    } catch (e) {
                        console.error(`❌ populateLongOptions: Failed to populate ${selectEl.id}:`, e);
                    }
                });

                console.log(`📊 populateLongOptions: ${successCount}/${selectElements.length} dropdowns populated successfully`);
                return successCount === selectElements.length;
            }

            // =============================================
            // FORM TOGGLE FUNCTIONS
            // =============================================
            function toggleOtherFertilizerInputUse(checkbox) {
                const item = checkbox.closest('.fertilizer-usage-item');
                if (!item) {
                    console.error('❌ ไม่พบ fertilizer-usage-item');
                    return;
                }

                const otherText = item.querySelector('.fertilizer-other-text');
                if (!otherText) {
                    console.error('❌ ไม่พบ fertilizer-other-text input');
                    return;
                }

                if (checkbox.checked) {
                    otherText.classList.remove('hidden');
                    otherText.required = true;
                } else {
                    otherText.classList.add('hidden');
                    otherText.required = false;
                    otherText.value = '';
                }
            }

            function handleOtherCheckboxChange(event) {
                toggleOtherFertilizerInputUse(event.target);
            }

            function toggleAdjustedBRate() {
                const adjustedInput = document.getElementById('b-rate-adjusted');
                const adjustRadio = document.getElementById('b-rate-adjust');

                if (!adjustRadio || !adjustedInput) {
                    console.warn('⚠️ toggleAdjustedBRate: Element ไม่พบ');
                    return;
                }
                if (adjustRadio.checked) {
                    adjustedInput.classList.remove('hidden');
                    adjustedInput.required = true;
                } else {
                    adjustedInput.classList.add('hidden');
                    adjustedInput.required = false;
                    adjustedInput.value = '';
                }
            }

            function toggleAdjustedBNanoRate() {
                const adjustedInput = document.getElementById('b-nano-rate-adjusted');
                const adjustRadio = document.getElementById('b-nano-rate-adjust');

                if (!adjustRadio || !adjustedInput) {
                    console.warn('⚠️ toggleAdjustedBNanoRate: Element ไม่พบ');
                    return;
                }
                if (adjustRadio.checked) {
                    adjustedInput.classList.remove('hidden');
                    adjustedInput.required = true;
                } else {
                    adjustedInput.classList.add('hidden');
                    adjustedInput.required = false;
                    adjustedInput.value = '';
                }
            }

            // =============================================
            // VALIDATION & SANITIZATION
            // (single robust validateInput used everywhere)
            // =============================================
            function validateInput(value, type, fieldName) {
                // handle null/undefined and numeric values safely
                if (value === null || value === undefined || (typeof value === 'string' && value.trim() === '')) {
                    throw new Error(`กรุณากรอก ${fieldName}`);
                }

                const valStr = (typeof value === 'string') ? value.trim() : String(value);

                switch (type) {
                    case 'phone':
                        const phonePattern = /^0[0-9]{9}$/;
                        const cleaned = valStr.replace(/-/g, '');
                        if (!phonePattern.test(cleaned)) {
                            throw new Error(`${fieldName} ไม่ถูกต้อง (ต้องเป็น 0XXXXXXXXX)`);
                        }
                        break;

                    case 'number':
                        const num = parseFloat(valStr);
                        if (isNaN(num) || num <= 0) {
                            throw new Error(`${fieldName} ต้องเป็นตัวเลขที่มากกว่า 0`);
                        }
                        break;

                    case 'date':
                        if (!valStr) {
                            throw new Error(`กรุณาเลือก ${fieldName}`);
                        }
                        const selectedDate = new Date(valStr);
                        const today = new Date();
                        // compare only date part - not future
                        if (selectedDate > today) {
                            throw new Error(`${fieldName} ไม่สามารถเป็นวันที่ในอนาคตได้`);
                        }
                        break;

                    case 'farmerId':
                        if (!valStr) {
                            throw new Error(`${fieldName} ไม่ถูกต้อง`);
                        }
                        if (valStr.length < 3) {
                            throw new Error(`${fieldName} ต้องมีความยาวอย่างน้อย 3 ตัวอักษร`);
                        }
                        break;
                }
                return value;
            }

            // =============================================
            // FORM RESET & MANAGEMENT
            // =============================================
            function resetSheetAFormExceptLong() {
                const form = document.getElementById('sheet-a-form');
                if (!form) return;
                const longSelect = document.getElementById('a-long-affiliation');
                const longValue = longSelect ? longSelect.value : '';

                form.reset();

                if (longSelect) {
                    document.getElementById('a-long-affiliation').value = longValue;
                }

                toggleOtherWateringInput();
                toggleOtherFertilizerInput();
            }

            function resetDisplayData() {
                try {
                    console.log('🔄 รีเซ็ตข้อมูลแสดงผล');

                    const dataElements = document.querySelectorAll('[data-field]');
                    dataElements.forEach(el => {
                        el.textContent = '---';
                        if (el.getAttribute('data-field') === 'a-premitra') {
                            el.className = 'text-xl font-bold text-red-600';
                        }
                        if (el.getAttribute('data-field') === 'b-post-mitra') {
                            el.className = 'text-xl font-bold text-blue-600';
                        }
                    });

                    const fEl = document.getElementById('b-fertilizer-usage-display');
                    const nEl = document.getElementById('b-nano-usage-display');
                    const mEl = document.getElementById('b-mineral-usage-display');
                    if (fEl) fEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                    if (nEl) nEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                    if (mEl) mEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';

                    console.log('✅ รีเซ็ตข้อมูลเสร็จสิ้น');

                } catch (error) {
                    console.error('❌ ข้อผิดพลาดในการรีเซ็ตข้อมูล:', error);
                }
            }

            // =============================================
            // SHEET A FUNCTIONS
            // =============================================
            function getSheetAFormData(form) {
                try {
                    if (!form) throw new Error('ไม่พบฟอร์ม');

                    const getEl = (id) => {
                        const el = document.getElementById(id);
                        if (!el) throw new Error(`ไม่พบ element: ${id}`);
                        return el;
                    };



                    const farmerId = getEl('a-id').value.trim();
                    validateInput(farmerId, 'farmerId', 'รหัสเกษตรกร');

                    const mineralAmount = getEl('a-long-receive-mineral-amount').value;
                    validateInput(mineralAmount, 'number', 'จำนวนแร่');

                    const nanoAmount = getEl('a-long-receive-nano-amount').value;
                    validateInput(nanoAmount, 'number', 'จำนวนนาโน');

                    const plotSize = getEl('a-plotsize').value;
                    validateInput(plotSize, 'number', 'ขนาดแปลง');

                    const sackcollect = getEl('a-sackcollect').value;
                    validateInput(sackcollect, 'number', 'จำนวนแร่ที่เกษตรกรรับ');

                    const nanoliters = getEl('a-nanoliters').value;
                    validateInput(nanoliters, 'number', 'จำนวนนาโนที่เกษตรกรรับ');

                    validateInput(getEl('a-long-receive-mineral-date').value, 'date', 'วันที่ตัวแทนรับแร่');
                    validateInput(getEl('a-long-receive-nano-date').value, 'date', 'วันที่ตัวแทนรับนาโน');
                    validateInput(getEl('a-datecollect').value, 'date', 'วันที่เกษตรกรรับแร่');
                    validateInput(getEl('a-datenano').value, 'date', 'วันที่เกษตรกรรับนาโน');

                    const parsedMineralAmount = parseFloat(getEl('a-long-receive-mineral-amount').value);
                    const parsedNanoAmount = parseFloat(getEl('a-long-receive-nano-amount').value);

                    if (isNaN(parsedMineralAmount) || parsedMineralAmount <= 0) {
                        throw new Error("จำนวนแร่ต้องเป็นตัวเลขที่มากกว่า 0");
                    }
                    if (isNaN(parsedNanoAmount) || parsedNanoAmount <= 0) {
                        throw new Error("จำนวนนาโนต้องเป็นตัวเลขที่มากกว่า 0");
                    }

                    const formData = {
                        timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                        'a-long-affiliation': (document.getElementById('a-long-affiliation') && document.getElementById('a-long-affiliation').value) || '',
                        'a-fullname': (document.getElementById('a-fullname') && document.getElementById('a-fullname').value.trim()) || '',

                        'a-id': farmerId,
                        'a-address-tambon': (document.getElementById('a-address-tambon') && document.getElementById('a-address-tambon').value.trim()) || '',
                        'a-address-amphoe': (document.getElementById('a-address-amphoe') && document.getElementById('a-address-amphoe').value.trim()) || '',
                        'a-address-province': (document.getElementById('a-address-province') && document.getElementById('a-address-province').value.trim()) || '',
                        'a-emergency': (document.getElementById('a-emergency') && document.getElementById('a-emergency').value.trim()) || '',
                        'a-gpsx': (document.getElementById('a-gpsx') && document.getElementById('a-gpsx').value.trim()) || '',
                        'a-gpsy': (document.getElementById('a-gpsy') && document.getElementById('a-gpsy').value.trim()) || '',
                        'a-plotsize': parseFloat(document.getElementById('a-plotsize').value),
                        'a-cropspecies': (document.getElementById('a-cropspecies') && document.getElementById('a-cropspecies').value.trim()) || '',

                        'a-long-receive-mineral-date': document.getElementById('a-long-receive-mineral-date').value,
                        'a-long-receive-mineral-amount': parsedMineralAmount,
                        'a-long-receive-nano-date': document.getElementById('a-long-receive-nano-date').value,
                        'a-long-receive-nano-amount': parsedNanoAmount,
                        'a-datecollect': document.getElementById('a-datecollect').value,
                        'a-sackcollect': parseInt(document.getElementById('a-sackcollect').value, 10),
                        'a-datenano': document.getElementById('a-datenano').value,
                        'a-nanoliters': parseFloat(document.getElementById('a-nanoliters').value),
                        'a-premitra': (document.getElementById('a-premitra') && parseFloat(document.getElementById('a-premitra').value)) || '',
                        'a-recorder': document.querySelector('input[name="a-recorder"]:checked')?.value || '',
                        'a-onsitenotes': (document.getElementById('a-onsitenotes') && document.getElementById('a-onsitenotes').value.trim()) || ''
                    };



                    return formData;
                } catch (error) {
                    showMessageBox("❌ ข้อมูลไม่ถูกต้อง", error.message);
                    throw error;
                }
            }

            function handleSheetASubmit(event) {
                event.preventDefault();

                const form = document.getElementById('sheet-a-form');
                const submitButton = form ? form.querySelector('button[type="submit"]') : null;


                try {
                    const session = checkLoginStatus();
                    if (!session) {
                        showMessageBox("❌ Session หมดอายุ", "กรุณาล็อกอินใหม่");
                        showLoginModal();
                        return;
                    }

                    const formData = getSheetAFormData(form);



                    if (!formData['a-recorder'] || formData['a-recorder'].trim() === '') {
                        showMessageBox("❌ ข้อมูลไม่ครบถ้วน!", "กรุณาเลือก **ผู้บันทึก**");
                        return;
                    }

                    if (!isAppsScriptReady('Sheet A Submission')) {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'บันทึกข้อมูล';
                        }
                        return;
                    }

                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<div class="loading-spinner"></div> กำลังบันทึก...';
                    }

                    const successHandler = (result) => {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'บันทึกข้อมูล';
                        }

                        if (result && result.success) {
                            showMessageBox("✅ บันทึกสำเร็จ!",
                                `บันทึกข้อมูลการรับแร่และนาโนของ **${formData['a-fullname']}** 
                            รหัส **${formData['a-id']}** เข้าระบบเรียบร้อยแล้ว 
                            <br>เวลา: ${new Date().toLocaleTimeString('th-TH')}`
                            );

                            resetSheetAFormExceptLong();
                            showView('sheet-a-view');
                        } else {
                            showMessageBox("❌ บันทึกไม่สำเร็จ!", (result && result.message) || 'ไม่สามารถบันทึกข้อมูลได้');
                        }
                    };

                    const errorHandler = (error) => {
                        if (submitButton) {
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'บันทึกข้อมูล';
                        }
                        showMessageBox("❌ บันทึกไม่สำเร็จ!",
                            `เกิดข้อผิดพลาดในการบันทึกข้อมูล:
                        <br><br><strong class='text-red-600'>${(error && error.message) || 'Unknown Error'}</strong>
                        <br><br>กรุณาติดต่อผู้ดูแลระบบ`
                        );
                    };

                    google.script.run
                        .withSuccessHandler(successHandler)
                        .withFailureHandler(errorHandler)
                        .writeSheetA(formData, session.token);

                } catch (error) {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'บันทึกข้อมูล';
                    }
                    console.error('Validation error:', error);
                }
            }

            function updateSheetALongDropdown() {
                const currentUser = checkLoginStatus();
                const longSelect = document.getElementById('a-long-affiliation');

                if (!currentUser) {
                    console.log('⚠️ updateSheetALongDropdown: No current user');
                    return;
                }

                if (!longSelect) {
                    console.error('❌ updateSheetALongDropdown: dropdown element not found');
                    return;
                }

                // Ensure dropdown is populated
                if (longSelect.options.length === 0) {
                    console.log('⚠️ updateSheetALongDropdown: dropdown empty, calling populateLongOptions');
                    populateLongOptions();
                }

                // Normalize longName for backward compatibility
                const normalizedLongName = normalizeLongName(currentUser.longName);
                console.log(`🔍 updateSheetALongDropdown: Looking for "${normalizedLongName}"`);

                let found = false;
                for (let i = 0; i < longSelect.options.length; i++) {
                    if (longSelect.options[i].value === normalizedLongName) {
                        longSelect.selectedIndex = i;
                        longSelect.disabled = true;
                        longSelect.classList.add('bg-gray-100', 'cursor-not-allowed');
                        found = true;
                        console.log(`✅ updateSheetALongDropdown: Auto-selected at index ${i}`);

                        // Trigger change event
                        try {
                            const event = new Event('change', { bubbles: true });
                            longSelect.dispatchEvent(event);
                        } catch (e) {
                            console.warn('⚠️ Could not dispatch change event:', e);
                        }
                        break;
                    }
                }

                if (!found) {
                    console.warn(`⚠️ updateSheetALongDropdown: No match for "${normalizedLongName}"`);
                    console.warn('Available options:', Array.from(longSelect.options).map(o => `"${o.value}"`));
                }

                updateLongDropdownLabels(true);
            }

            // =============================================
            // DATA FETCHING & DISPLAY
            // =============================================
            function fetchAndDisplaySheetAData() {
                const longAffiliationEl = document.getElementById('b-long-affiliation');
                const longAffiliation = longAffiliationEl ? longAffiliationEl.value : '';
                const farmerId = (document.getElementById('summary-search-id') && document.getElementById('summary-search-id').value.trim()) || '';
                const fetchButton = document.getElementById('fetch-data-btn');


                if (!longAffiliation || !farmerId) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกตัวแทนและป้อนรหัสเกษตรกร");
                    return;
                }

                if (fetchButton) {
                    fetchButton.disabled = true;
                    fetchButton.innerHTML = '<div class="loading-spinner"></div> กำลังค้นหา...';
                }

                google.script.run
                    .withSuccessHandler((sheetAResult) => {

                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = `ค้นหา`;
                        }

                        try {
                            const sheetAData = safeParseJSON(sheetAResult);

                            if (sheetAData && sheetAData.success && Array.isArray(sheetAData.data) && sheetAData.data.length > 0) {
                                const farmer = sheetAData.data[sheetAData.data.length - 1];
                                updateSheetBReadonlyData(farmer);

                                fetchSheetBData(longAffiliation, farmerId);

                            } else {
                                showMessageBox("❌ ไม่พบข้อมูล!", `ไม่พบข้อมูลสำหรับรหัส: ${farmerId}`);
                            }
                        } catch (e) {
                            console.error('❌ ข้อผิดพลาดในการประมวลผลข้อมูล', e);
                            showMessageBox("❌ ข้อผิดพลาด!", "เกิดข้อผิดพลาดในการแสดงผลข้อมูล");
                        }
                    })
                    .withFailureHandler((error) => {
                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = `ค้นหา`;
                        }
                        showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'เกิดข้อผิดพลาดในการค้นหา');
                    })
                    .searchFarmerData(longAffiliation, farmerId);
            }

            function fetchSheetBData(longAffiliation, farmerId) {
                const fetchButton = document.getElementById('fetch-data-btn');

                console.log('🔍 กำลังดึงข้อมูล Sheet B:', { longAffiliation, farmerId });

                // First ensure sheet for long exists (try to create or ensure)
                google.script.run
                    .withSuccessHandler((createResult) => {
                        // Now fetch sheet B data
                        google.script.run
                            .withSuccessHandler((sheetBResult) => {
                                if (fetchButton) {
                                    fetchButton.disabled = false;
                                    fetchButton.innerHTML = `ค้นหา`;
                                }

                                try {
                                    const sheetBData = safeParseJSON(sheetBResult);
                                    if (sheetBData && sheetBData.data) {
                                        displaySheetBUsageData(sheetBData.data);
                                    } else {
                                        displaySheetBUsageData([]);
                                    }
                                } catch (e) {
                                    console.error('❌ ข้อผิดพลาดในการประมวลผลข้อมูล Sheet B', e);
                                    displaySheetBUsageData([]);
                                }
                            })
                            .withFailureHandler((err) => {
                                if (fetchButton) {
                                    fetchButton.disabled = false;
                                    fetchButton.innerHTML = `ค้นหา`;
                                }
                                console.error('❌ searchSheetBData failed', err);
                                showMessageBox("❌ ข้อผิดพลาด!", (err && err.message) || 'ไม่สามารถดึงข้อมูล Sheet B ได้');
                            })
                            .searchSheetBData(longAffiliation, farmerId);
                    })
                    .withFailureHandler((error) => {
                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = `ค้นหา`;
                        }
                        console.error('❌ createNewSheetForLong failed', error);
                        showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'ไม่สามารถเตรียม Sheet สำหรับตัวแทนนี้ได้');
                    })
                    .createNewSheetForLong(longAffiliation);
            }

            function fetchSheetBUsageData(longAffiliation, farmerId, fetchButton) {
                google.script.run
                    .withSuccessHandler((sheetBResult) => {
                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = 'ค้นหา';
                        }

                        try {
                            const sheetBData = safeParseJSON(sheetBResult);

                            if (sheetBData && sheetBData.success && sheetBData.data && sheetBData.data.length > 0) {
                                displaySheetBUsageData(sheetBData.data);
                            } else {
                                const fEl = document.getElementById('b-fertilizer-usage-display');
                                const nEl = document.getElementById('b-nano-usage-display');
                                const mEl = document.getElementById('b-mineral-usage-display');
                                if (fEl) fEl.textContent = '- ยังไม่มีข้อมูล -';
                                if (nEl) nEl.textContent = '- ยังไม่มีข้อมูล -';
                                if (mEl) mEl.textContent = '- ยังไม่มีข้อมูล -';
                            }
                        } catch (e) {
                            console.error('❌ ข้อผิดพลาดในการประมวลผล Sheet B:', e);
                        }
                    })
                    .withFailureHandler((error) => {
                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = 'ค้นหา';
                        }
                        console.error('❌ ข้อผิดพลาดในการดึง Sheet B:', error);
                    })
                    .searchSheetBData(longAffiliation, farmerId);
            }

            // =============================================
            // SHEET B FUNCTIONS
            // =============================================
            function fetchAndDisplaySheetBUseData() {
                const longAffiliation = document.getElementById('b-long-affiliation') ? document.getElementById('b-long-affiliation').value : '';
                const farmerId = document.getElementById('summary-search-id') ? document.getElementById('summary-search-id').value.trim() : '';

                if (!longAffiliation || !farmerId) {
                    showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกตัวแทนและป้อนรหัสเกษตรกร");
                    return;
                }

                const fetchButton = document.getElementById('fetch-data-btn');
                if (fetchButton) {
                    fetchButton.disabled = true;
                    fetchButton.innerHTML = '<div class="loading-spinner"></div> กำลังค้นหา...';
                }

                google.script.run
                    .withSuccessHandler((sheetAResult) => {
                        try {
                            const sheetAData = safeParseJSON(sheetAResult);

                            if (sheetAData && sheetAData.success && sheetAData.data.length > 0) {
                                const farmer = sheetAData.data[sheetAData.data.length - 1];
                                updateSheetBReadonlyData(farmer);

                                fetchSheetBUsageData(longAffiliation, farmerId, fetchButton);
                            } else {
                                if (fetchButton) {
                                    fetchButton.disabled = false;
                                    fetchButton.innerHTML = 'ค้นหา';
                                }
                                showMessageBox("❌ ไม่พบข้อมูล!", `ไม่พบข้อมูลสำหรับรหัส: ${farmerId}`);
                            }
                        } catch (e) {
                            if (fetchButton) {
                                fetchButton.disabled = false;
                                fetchButton.innerHTML = 'ค้นหา';
                            }
                            showMessageBox("❌ ข้อผิดพลาด!", "เกิดข้อผิดพลาดในการแสดงผลข้อมูล");
                        }
                    })
                    .withFailureHandler((error) => {
                        if (fetchButton) {
                            fetchButton.disabled = false;
                            fetchButton.innerHTML = 'ค้นหา';
                        }
                        showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'เกิดข้อผิดพลาดในการดึงข้อมูล');
                    })
                    .searchFarmerData(longAffiliation, farmerId);
            }

            function displaySheetBUsageData(usageData) {
                console.log('🔍 displaySheetBUsageData - ข้อมูลที่ได้รับ:', usageData);

                if (!usageData || usageData.length === 0) {
                    console.log('❌ ไม่มีข้อมูล - แสดง placeholder');

                    const fEl = document.getElementById('b-fertilizer-usage-display');
                    const nEl = document.getElementById('b-nano-usage-display');
                    const mEl = document.getElementById('b-mineral-usage-display');
                    if (fEl) fEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                    if (nEl) nEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';
                    if (mEl) mEl.innerHTML = '<p class="text-stone-500">- ยังไม่มีข้อมูล -</p>';

                    const postMitraEl = document.querySelector('[data-field="b-post-mitra"]');
                    if (postMitraEl) postMitraEl.textContent = '---';
                    return;
                }

                const latestUsage = usageData[0];

                const fertilizerUsage = latestUsage['b-fertilizer-usage'] || '';
                const nanoUsage = latestUsage['b-nano-usage'] || '';
                const mineralUsage = latestUsage['b-mineral-usage'] || '';
                const postMitra = latestUsage['b-post-mitra'] || '---';

                displayUsageText('b-fertilizer-usage-display', fertilizerUsage);
                displayUsageText('b-nano-usage-display', nanoUsage);
                displayUsageText('b-mineral-usage-display', mineralUsage);

                const postMitraElement = document.querySelector('[data-field="b-post-mitra"]');
                if (postMitraElement) {
                    if (postMitra && postMitra !== '' && postMitra !== '---') {
                        const num = parseFloat(postMitra);
                        postMitraElement.textContent = isNaN(num) ? '---' : num.toFixed(2);
                        postMitraElement.className = 'text-xl font-bold text-blue-600';
                    } else {
                        postMitraElement.textContent = '---';
                        postMitraElement.className = 'text-xl font-bold text-gray-400';
                    }
                }
            }

            function updateSheetBReadonlyData(sheetAData) {
                try {
                    console.log('🔄 อัพเดตข้อมูลแสดงผล:', sheetAData);

                    if (!sheetAData || Object.keys(sheetAData).length === 0) {
                        console.log('📭 ไม่มีข้อมูลที่จะแสดง');
                        resetDisplayData();
                        return;
                    }

                    const dataMapA = {
                        'a-fullname': sheetAData['a-fullname'] || '---',
                        'a-id': sheetAData['a-id'] || '---',
                        'a-long-affiliation': sheetAData['a-long-affiliation'] || '---',
                        'a-plotsize': sheetAData['a-plotsize'] || '---',
                        'a-cropspecies': sheetAData['a-cropspecies'] || '---',
                        'a-watering': sheetAData['a-watering'] || '---',
                        'a-fertilizer-methods': sheetAData['a-fertilizer-method'] || '---',
                        'a-datecollect': formatDateForDisplay(sheetAData['a-datecollect']),
                        'a-sackcollect': sheetAData['a-sackcollect'] || '---',
                        'a-datenano': formatDateForDisplay(sheetAData['a-datenano']),
                        'a-nanoliters': sheetAData['a-nanoliters'] || '---',
                        'a-premitra': sheetAData['a-premitra'] || '---'
                    };

                    Object.keys(dataMapA).forEach(fieldName => {
                        const elements = document.querySelectorAll(`[data-field="${fieldName}"]`);
                        elements.forEach(el => {
                            el.textContent = dataMapA[fieldName];

                            if (fieldName === 'a-premitra' && dataMapA[fieldName] !== '---') {
                                el.className = 'text-xl font-bold text-red-600';
                            }
                        });
                    });

                } catch (error) {
                    console.error('❌ ข้อผิดพลาดใน updateSheetBReadonlyData:', error);
                    showMessageBox("⚠️ ข้อผิดพลาด", "เกิดข้อผิดพลาดในการแสดงผลข้อมูลบางส่วน");
                }
            }

            // =============================================
            // DATA DISPLAY FUNCTIONS
            // =============================================
            function displayUsageText(displayElementId, textData) {
                const displayElement = document.getElementById(displayElementId);

                if (!displayElement) return;

                if (!textData || (typeof textData === 'string' && textData.trim() === '') || textData === '-') {
                    displayElement.textContent = '- ยังไม่มีข้อมูล -';
                    return;
                }

                // if it's array/object, stringify appropriately
                if (Array.isArray(textData)) {
                    displayElement.textContent = textData.map(t => (typeof t === 'string' ? t : JSON.stringify(t))).join('\n');
                    return;
                }
                displayElement.textContent = typeof textData === 'string' ? textData : JSON.stringify(textData);
            }

            function formatDateForDisplay(dateString) {
                if (!dateString || dateString === '---') {
                    return '---';
                }

                try {
                    // handle ISO timestamp or full date
                    if (typeof dateString === 'string' && dateString.includes('T') && dateString.includes('Z')) {
                        const date = new Date(dateString);
                        return date.toLocaleDateString('th-TH', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric'
                        });
                    }

                    // handle YYYY-MM-DD (input type="date" value)
                    if (typeof dateString === 'string' && dateString.match(/^\d{4}-\d{2}-\d{2}$/)) {
                        const [year, month, day] = dateString.split('-');
                        return `${day}/${month}/${year}`;
                    }

                    // if already DD/MM/YYYY or other readable, return as-is
                    return dateString;
                } catch (error) {
                    console.error('Error formatting date:', error, dateString);
                    return dateString;
                }
            }

            // =============================================
            // SHEET B USE FUNCTIONS
            // =============================================
            function getUsageData() {
                const fertilizerUsage = getFertilizerUsageData();
                const nanoUsage = [];
                const mineralUsage = [];

                console.log('🔍 กำลังดึงข้อมูลการใช้...');

                document.querySelectorAll('.nano-usage-item').forEach(item => {
                    const date = item.querySelector('.nano-date')?.value;
                    const amount = item.querySelector('.nano-amount')?.value;
                    if (date && amount) {
                        const parsed = parseFloat(amount);
                        if (!isNaN(parsed)) {
                            nanoUsage.push({
                                date: date,
                                amount: parsed
                            });
                        }
                    }
                });

                document.querySelectorAll('.mineral-usage-item').forEach(item => {
                    const date = item.querySelector('.mineral-date')?.value;
                    const amount = item.querySelector('.mineral-amount')?.value;
                    if (date && amount) {
                        const parsed = parseFloat(amount);
                        if (!isNaN(parsed)) {
                            mineralUsage.push({
                                date: date,
                                amount: parsed
                            });
                        }
                    }
                });

                console.log('📊 สรุปข้อมูลการใช้:', {
                    fertilizer: fertilizerUsage,
                    nano: nanoUsage,
                    mineral: mineralUsage
                });

                return {
                    fertilizerUsage: fertilizerUsage,
                    nanoUsage: nanoUsage,
                    mineralUsage: mineralUsage
                };
            }

            function createFertilizerUsageHTML() {
                const uniqueId = `fert-${Date.now()}`;

                // NOTE: removed inline onchange attribute; will attach listener in initializeFertilizerCheckboxes()
                return `
                <div class="fertilizer-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                    <div>
                        <label class="block text-sm font-medium mb-1">วันที่ใส่ปุ๋ย</label>
                        <input type="date" class="fertilizer-date w-full">
                    </div>

                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium mb-1">บำรุงดินด้วย <span class="text-xs text-green-600">(เลือกได้มากกว่าหนึ่ง)</span></label>
                        <div class="radio-group flex flex-wrap gap-2">
                            <input type="checkbox" id="${uniqueId}-organic" name="fertilizer_type[]" value="ปุ๋ยอินทรีย์" class="">
                            <label for="${uniqueId}-organic" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยอินทรีย์</label>

                            <input type="checkbox" id="${uniqueId}-chemical" name="fertilizer_type[]" value="ปุ๋ยเคมี" class="">
                            <label for="${uniqueId}-chemical" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยเคมี</label>

                            <input type="checkbox" id="${uniqueId}-manure" name="fertilizer_type[]" value="ปุ๋ยคอก" class="">
                            <label for="${uniqueId}-manure" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">ปุ๋ยคอก</label>

                            <input type="checkbox" id="${uniqueId}-other" name="fertilizer_type[]" value="อื่นๆ" class="">
                            <label for="${uniqueId}-other" class="px-3 py-2 rounded-lg cursor-pointer border border-green-300 bg-white hover:bg-green-50">อื่นๆ (ระบุ)</label>
                        </div>
                        <input type="text" placeholder="โปรดระบุชนิดปุ๋ยอื่นๆ ที่ใช้" class="hidden mt-2 w-full fertilizer-other-text">
                    </div>

                    <div class="flex items-end col-span-full"></div> 
                </div>
            `;
            }

            async function handleSheetBUseSubmit(event) {
                event.preventDefault();

                const form = document.getElementById('sheet-b-use-form');
                const submitButton = form ? form.querySelector('button[type="submit"]') : null;

                try {
                    const longAffiliation = document.getElementById('b-long-affiliation-use')?.value;
                    const farmerId = document.getElementById('b-farmer-id-use')?.value.trim();
                    const fullname = document.getElementById('b-fullname-use')?.value.trim();

                    if (!longAffiliation) {
                        showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกตัวแทนที่สังกัด");
                        return;
                    }

                    if (!farmerId) {
                        showMessageBox("❌ ขาดข้อมูล!", "กรุณาป้อนรหัสเกษตรกร");
                        return;
                    }

                    if (!fullname) {
                        showMessageBox("❌ ขาดข้อมูล!", "กรุณากรอกชื่อ-สกุลเกษตรกร");
                        return;
                    }



                    const recorderElement = document.querySelector('input[name="b-recorder"]:checked');
                    if (!recorderElement) {
                        showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกผู้บันทึก");
                        return;
                    }

                    const usageData = getUsageData();
                    const hasFertilizer = usageData.fertilizerUsage.length > 0;
                    const hasNano = usageData.nanoUsage.length > 0;
                    const hasMineral = usageData.mineralUsage.length > 0;

                    if (!hasFertilizer && !hasNano && !hasMineral) {
                        showMessageBox("❌ ขาดข้อมูล!", "กรุณากรอกข้อมูลการใช้อย่างน้อย 1 รายการ (ปุ๋ย, นาโน, หรือแร่)");
                        return;
                    }

                    let errorMessage = '';

                    usageData.fertilizerUsage.forEach((item, index) => {
                        if (!item.date || !item.type) {
                            errorMessage += `• รายการปุ๋ยที่ ${index + 1}: กรุณากรอกวันที่และชนิดปุ๋ยให้ครบ<br>`;
                        }
                    });

                    usageData.nanoUsage.forEach((item, index) => {
                        if (!item.date || !item.amount) {
                            errorMessage += `• รายการนาโนที่ ${index + 1}: กรุณากรอกวันที่และจำนวนให้ครบ<br>`;
                        }
                    });

                    usageData.mineralUsage.forEach((item, index) => {
                        if (!item.date || !item.amount) {
                            errorMessage += `• รายการแร่ที่ ${index + 1}: กรุณากรอกวันที่และจำนวนให้ครบ<br>`;
                        }
                    });

                    if (errorMessage) {
                        showMessageBox("❌ ข้อมูลไม่ครบถ้วน!", errorMessage);
                        return;
                    }

                    const rateElement = form.querySelector('input[name="b-rate"]:checked');
                    const nanoRateElement = form.querySelector('input[name="b-nano-rate"]:checked');

                    if (!rateElement) {
                        showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกอัตราการใส่แร่");
                        return;
                    }

                    if (!nanoRateElement) {
                        showMessageBox("❌ ขาดข้อมูล!", "กรุณาเลือกอัตราการใส่นาโน");
                        return;
                    }


                    if (submitButton) {
                        submitButton.disabled = true;
                        submitButton.innerHTML = '<div class="loading-spinner"></div> กำลังบันทึก...';
                    }

                    const formData = {
                        timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                        'b-long-affiliation': longAffiliation,
                        'b-farmer-id': farmerId,
                        'b-fullname': fullname,
                        'b-fertilizer-usage': usageData.fertilizerUsage,
                        'b-nano-usage': usageData.nanoUsage,
                        'b-mineral-usage': usageData.mineralUsage,
                        'b-rate': rateElement.value,
                        'b-rate-adjusted': document.getElementById('b-rate-adjusted')?.value || '',
                        'b-nano-rate': nanoRateElement.value,
                        'b-nano-rate-adjusted': document.getElementById('b-nano-rate-adjusted')?.value || '',
                        'b-recorder': recorderElement.value
                    };

                    console.log('📦 ข้อมูลที่จะบันทึก Sheet B:', formData);

                    const token = sessionStorage.getItem('sessionToken');
                    google.script.run
                        .withSuccessHandler((result) => {
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.innerHTML = 'บันทึกข้อมูลการใช้';
                            }

                            if (result && result.success) {
                                showMessageBox("✅ บันทึกสำเร็จ!",
                                    `บันทึกข้อมูลการใช้ 4-7-16 ของ **${formData['b-fullname']}** 
                                เรียบร้อยแล้ว
                                <br>เวลา: ${new Date().toLocaleTimeString('th-TH')}`
                                );
                                if (form) form.reset();
                                resetUsageContainers();
                                showView('main-menu-view');
                            } else {
                                showMessageBox("❌ บันทึกไม่สำเร็จ!", (result && result.message) || 'ไม่สามารถบันทึกข้อมูลได้');
                            }
                        })
                        .withFailureHandler((error) => {
                            if (submitButton) {
                                submitButton.disabled = false;
                                submitButton.innerHTML = 'บันทึกข้อมูลการใช้';
                            }
                            showMessageBox("❌ บันทึกไม่สำเร็จ!",
                                `เกิดข้อผิดพลาด: ${(error && error.message) || 'Unknown error'}
                            <br><br>กรุณาตรวจสอบข้อมูลและลองอีกครั้ง`
                            );
                            console.error('❌ ข้อผิดพลาดในการบันทึก:', error);
                        })
                        .writeSheetB(formData, token);

                } catch (error) {
                    if (submitButton) {
                        submitButton.disabled = false;
                        submitButton.innerHTML = 'บันทึกข้อมูลการใช้';
                    }
                    console.error('❌ ข้อผิดพลาด:', error);
                    showMessageBox("❌ ข้อผิดพลาด!", error.message || 'เกิดข้อผิดพลาด');
                }
            }

            function resetUsageContainers() {
                const fertilizerContainer = document.getElementById('fertilizer-usage-container');
                if (fertilizerContainer) {
                    fertilizerContainer.innerHTML = createFertilizerUsageHTML();
                }

                const nanoContainer = document.getElementById('nano-usage-container');
                if (nanoContainer) {
                    nanoContainer.innerHTML = `
                    <div class="nano-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">วันที่ใช้นาโน</label>
                            <input type="date" class="nano-date w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (ลิตร)</label>
                            <input type="number" class="nano-amount w-full" min="0.1" step="0.1">
                        </div>
                        <div class="flex items-end"></div>
                    </div>
                `;
                }

                const mineralContainer = document.getElementById('mineral-usage-container');
                if (mineralContainer) {
                    mineralContainer.innerHTML = `
                    <div class="mineral-usage-item grid grid-cols-1 md:grid-cols-3 gap-3 mb-3">
                        <div>
                            <label class="block text-sm font-medium mb-1">วันที่ใช้แร่</label>
                            <input type="date" class="mineral-date w-full">
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1">จำนวนที่ใช้ (กิโลกรัม)</label>
                            <input type="number" class="mineral-amount w-full" min="0.1" step="0.1">
                        </div>
                        <div class="flex items-end"></div>
                    </div>
                `;
                }
                initializeFertilizerCheckboxes();
            }

            document.addEventListener('DOMContentLoaded', function () {
                initializeFertilizerCheckboxes();
            });

            // =============================================
            // USAGE DATA MANAGEMENT
            // =============================================
            let fertilizerUsageCount = 1;
            let nanoUsageCount = 1;
            let mineralUsageCount = 1;

            function getFertilizerUsageData() {
                const fertilizerUsage = [];

                document.querySelectorAll('.fertilizer-usage-item').forEach((item, index) => {
                    const date = item.querySelector('.fertilizer-date')?.value;
                    const checkedBoxes = item.querySelectorAll('input[type="checkbox"]:checked');
                    const checkedTypes = Array.from(checkedBoxes).map(cb => {
                        if (cb.value === 'อื่นๆ') {
                            const otherTextInput = item.querySelector('.fertilizer-other-text');
                            if (otherTextInput && !otherTextInput.classList.contains('hidden')) {
                                const otherValue = otherTextInput.value.trim();
                                return otherValue ? `อื่นๆ: ${otherValue}` : 'อื่นๆ';

                            }
                            return 'อื่นๆ'
                        }
                        return cb.value;
                    }).filter(val => val); // กรองค่าว่าง

                    if (date && checkedTypes.length > 0) {
                        fertilizerUsage.push({
                            date: date,
                            type: checkedTypes.join(', ')
                        });
                    }
                });
                return fertilizerUsage;
            }

            function getSheetBUseFormData(form) {
                const usageData = getUsageData();

                const hasUsageData = usageData.fertilizerUsage.length > 0 ||
                    usageData.nanoUsage.length > 0 ||
                    usageData.mineralUsage.length > 0;

                if (!hasUsageData) {
                    throw new Error("กรุณากรอกข้อมูลการใช้อย่างน้อย 1 รายการ");
                }

                const formData = {
                    timestamp: new Date().toLocaleString('th-TH', { timeZone: 'Asia/Bangkok' }),
                    'b-long-affiliation': document.getElementById('b-long-affiliation-use')?.value,
                    'b-farmer-id': document.getElementById('b-farmer-id-use')?.value.trim(),
                    'b-fullname': document.getElementById('b-fullname-use')?.value.trim(),
                    'b-phone': '',
                    'b-fertilizer-usage': usageData.fertilizerUsage,
                    'b-nano-usage': usageData.nanoUsage,
                    'b-mineral-usage': usageData.mineralUsage,
                    'b-premitra': parseFloat(document.getElementById('b-premitra')?.value || 0),
                    'b-rate': form.querySelector('input[name="b-rate"]:checked')?.value,
                    'b-rate-adjusted': document.getElementById('b-rate-adjusted')?.value ? parseFloat(document.getElementById('b-rate-adjusted').value) : '',
                    'b-nano-rate': form.querySelector('input[name="b-nano-rate"]:checked')?.value,
                    'b-nano-rate-adjusted': document.getElementById('b-nano-rate-adjusted')?.value ? parseFloat(document.getElementById('b-nano-rate-adjusted').value) : '',
                    'b-recorder': document.querySelector('input[name="b-recorder"]:checked')?.value || ''
                };

                if (formData['b-rate'] !== 'ปรับตาม') {
                    delete formData['b-rate-adjusted'];
                }
                if (formData['b-nano-rate'] !== 'ปรับตาม') {
                    delete formData['b-nano-rate-adjusted'];
                }

                Object.keys(formData).forEach(key => {
                    if (formData[key] === '' || formData[key] === null || formData[key] === undefined) {
                        delete formData[key];
                    }
                });
                return formData;
            }

            // =============================================
            // VALIDATION & SECURITY
            // =============================================
            function validateBeforeSubmit() {
                const longAffiliation = document.getElementById('b-long-affiliation-use')?.value;
                const farmerId = document.getElementById('b-farmer-id-use')?.value.trim();

                if (!longAffiliation || !farmerId) {
                    return Promise.resolve(false);
                }

                return new Promise((resolve) => {
                    google.script.run
                        .withSuccessHandler((result) => {
                            if (result && result.success && result.exists) {
                                resolve(true);
                            } else {
                                showMessageBox("❌ ข้อผิดพลาด",
                                    `ไม่สามารถบันทึกข้อมูลได้: ${result && result.message ? result.message : 'ความสัมพันธ์ข้อมูลไม่ถูกต้อง'}
                                 <br><br>กรุณาตรวจสอบว่า:
                                 <br>• ดูแลตัวแทนได้บันทึกข้อมูลการรับแร่/นาโนของเกษตรกรหรือยัง
                                 <br>• รหัสเกษตรกรถูกต้องไหม
                                 <br>• เลือกตัวแทนที่สังกัดถูกต้องไหม`);
                                resolve(false);
                            }
                        })
                        .withFailureHandler((error) => {
                            showMessageBox("❌ ข้อผิดพลาด", "ไม่สามารถตรวจสอบข้อมูลได้: " + (error && error.message ? error.message : 'Unknown error'));
                            resolve(false);
                        })
                        .validateDataRelationship(longAffiliation, farmerId);
                });
            }

            // =============================================
            // AUTHENTICATION FUNCTIONS
            // =============================================
            async function handleLogin(event) {
                event.preventDefault();

                const username = document.getElementById('username')?.value.trim();
                const password = document.getElementById('password')?.value;
                const errorElement = document.getElementById('login-error');
                const submitButton = event.target.querySelector('button[type="submit"]');

                if (!username || !password) {
                    const errorMessage = "กรุณากรอกชื่อตัวแทนและรหัสผ่าน";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    } else {
                        showMessageBox("❌ ข้อมูลไม่ครบ", errorMessage);
                    }
                    return;
                }

                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="loading-spinner"></div> กำลังตรวจสอบ...';

                if (errorElement) {
                    errorElement.classList.add('hidden');
                }

                try {
                    const response = await new Promise((resolve, reject) => {
                        google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                            .userLogin(username, password);
                    });

                    if (response && response.success) {
                        console.log('✅ Login successful:', response);

                        // Store session data
                        sessionStorage.setItem('sessionToken', response.token);
                        sessionStorage.setItem('longName', response.longName);
                        sessionStorage.setItem('username', response.username);
                        sessionStorage.setItem('isAdmin', response.isAdmin ? 'true' : 'false');

                        hideLoginModal();

                        if (response.isAdmin) {
                            // Admin users go to admin panel
                            adminCheckAuthAndInit();
                        } else {
                            // CRITICAL FIX: Ensure dropdowns are populated BEFORE auto-selecting
                            console.log('🔄 Populating dropdowns before auto-select...');

                            // Force populate all dropdowns
                            const populated = populateLongOptions();

                            if (!populated) {
                                console.warn('⚠️ Dropdown population failed, retrying...');
                                // Single setTimeout with total delay for retry
                                setTimeout(() => {
                                    populateLongOptions();
                                    updateAllLongDropdowns(response.longName);
                                }, DROPDOWN_RETRY_TOTAL_DELAY_MS);
                            } else {
                                // Success - small delay for DOM rendering before auto-select
                                setTimeout(() => {
                                    console.log('🔄 Dropdowns populated, now auto-selecting...');
                                    updateAllLongDropdowns(response.longName);
                                }, DROPDOWN_SELECT_DELAY_MS);
                            }

                            showView('submenu-view');
                        }

                        showMessageBox("✅ ล็อกอินสำเร็จ", `ยินดีต้อนรับ ${response.longName}`);
                    } else {
                        const errorMessage = (response && response.message) || "ชื่อตัวแทนหรือรหัสผ่านไม่ถูกต้อง";
                        if (errorElement) {
                            errorElement.textContent = errorMessage;
                            errorElement.classList.remove('hidden');
                        } else {
                            showMessageBox("❌ ล็อกอินไม่สำเร็จ", errorMessage);
                        }
                    }
                } catch (error) {
                    console.error('❌ ข้อผิดพลาดในการล็อกอิน:', error);
                    const errorMessage = "เกิดข้อผิดพลาดในการเชื่อมต่อระบบ";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    } else {
                        showMessageBox("❌ ข้อผิดพลาดระบบ", errorMessage);
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'เข้าสู่ระบบ';
                }
            }

            function showLoginModal() {
                const el = document.getElementById('login-modal');
                if (el) el.classList.remove('hidden');
                const input = document.getElementById('username');
                if (input) input.focus();
            }

            function hideLoginModal() {
                const modal = document.getElementById('login-modal');
                if (modal) modal.classList.add('hidden');
                const form = document.getElementById('login-form');
                if (form) form.reset();
                const err = document.getElementById('login-error');
                if (err) err.classList.add('hidden');
            }

            // =============================================
            // ADMIN LOGIN FUNCTIONS (INDEPENDENT)
            // =============================================

            // Helper function to show admin view after successful login
            function showAdminView() {
                const warning = document.getElementById('admin-access-warning');
                const controls = document.getElementById('admin-controls');
                const currentUserEl = document.getElementById('admin-current-user');

                if (warning) warning.classList.add('hidden');
                if (controls) controls.classList.remove('hidden');

                const username = sessionStorage.getItem('username') || '';
                const longName = sessionStorage.getItem('longName') || '';
                if (currentUserEl) {
                    currentUserEl.textContent = username ? `${username} (${longName || '-'})` : 'ไม่ได้ล็อกอิน';
                }

                // Removed navigateTo('admin-view') to prevent infinite loop with MutationObserver
            }

            async function handleAdminLogin(event) {
                event.preventDefault();

                const username = document.getElementById('admin-username')?.value.trim();
                const password = document.getElementById('admin-password')?.value;
                const errorElement = document.getElementById('admin-login-error');
                const submitButton = event.target.querySelector('button[type="submit"]');

                // Enhanced validation
                if (!username || !password) {
                    const errorMessage = "กรุณากรอก Admin Username และ Password";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    } else {
                        showMessageBox("❌ ข้อมูลไม่ครบ", errorMessage);
                    }
                    return;
                }

                // Input length validation
                if (username.length > 50) {
                    const errorMessage = "Username ยาวเกินไป";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    }
                    return;
                }

                if (password.length > 100) {
                    const errorMessage = "Password ยาวเกินไป";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    }
                    return;
                }

                // Check rate limiting
                if (typeof window._adminRateLimitCheck === 'function') {
                    const rateLimitResult = window._adminRateLimitCheck();
                    if (!rateLimitResult.allowed) {
                        const errorMessage = `คุณพยายามเข้าสู่ระบบหลายครั้งเกินไป กรุณารออีก ${rateLimitResult.waitMinutes} นาที`;
                        if (errorElement) {
                            errorElement.textContent = errorMessage;
                            errorElement.classList.remove('hidden');
                        } else {
                            showMessageBox("❌ ถูกจำกัดการเข้าถึง", errorMessage);
                        }
                        return;
                    }
                }

                // Prevent multiple simultaneous login attempts
                if (submitButton.disabled) {
                    return;
                }

                submitButton.disabled = true;
                submitButton.innerHTML = '<div class="loading-spinner"></div> กำลังตรวจสอบ...';

                if (errorElement) {
                    errorElement.classList.add('hidden');
                }

                try {
                    const response = await new Promise((resolve, reject) => {
                        // Set timeout for login request
                        const timeoutId = setTimeout(() => {
                            reject(new Error('การเชื่อมต่อหมดเวลา กรุณาลองอีกครั้ง'));
                        }, 30000); // 30 second timeout

                        google.script.run
                            .withSuccessHandler((result) => {
                                clearTimeout(timeoutId);
                                resolve(result);
                            })
                            .withFailureHandler((error) => {
                                clearTimeout(timeoutId);
                                reject(error);
                            })
                            .userLogin(username, password);
                    });

                    if (response && response.success) {
                        console.log('✅ Admin login successful:', response);

                        // Verify this is actually an admin user
                        if (!response.isAdmin) {
                            const errorMessage = "บัญชีนี้ไม่มีสิทธิ์ผู้ดูแลระบบ";
                            if (errorElement) {
                                errorElement.textContent = errorMessage;
                                errorElement.classList.remove('hidden');
                            } else {
                                showMessageBox("❌ ไม่มีสิทธิ์", errorMessage);
                            }
                            submitButton.disabled = false;
                            submitButton.innerHTML = 'เข้าสู่ระบบ';
                            return;
                        }

                        // Validate response data before storing
                        if (!response.token || typeof response.token !== 'string' || response.token.length === 0) {
                            throw new Error('Invalid token received from server');
                        }

                        if (!response.username || typeof response.username !== 'string' || response.username.length === 0) {
                            throw new Error('Invalid username received from server');
                        }

                        // Store admin session data
                        // Note: longName is optional - backend may return empty string or undefined
                        sessionStorage.setItem('sessionToken', response.token);
                        sessionStorage.setItem('longName', response.longName || ''); // Optional field
                        sessionStorage.setItem('username', response.username);
                        // We already validated isAdmin is true, so set it directly
                        sessionStorage.setItem('isAdmin', 'true');

                        hideAdminLoginModal();

                        // Navigate to admin view using helper function
                        showAdminView();
                        if (typeof navigateTo === 'function') navigateTo('admin-view');

                        showMessageBox("✅ เข้าสู่ระบบผู้ดูแลสำเร็จ", `ยินดีต้อนรับ ${response.username}`);
                    } else {
                        const errorMessage = (response && response.message) || "Admin Username หรือ Password ไม่ถูกต้อง";
                        if (errorElement) {
                            errorElement.textContent = errorMessage;
                            errorElement.classList.remove('hidden');
                        } else {
                            showMessageBox("❌ ล็อกอินไม่สำเร็จ", errorMessage);
                        }
                    }
                } catch (error) {
                    console.error('❌ ข้อผิดพลาดในการล็อกอินผู้ดูแล:', error);
                    const errorMessage = error && error.message ? error.message : "เกิดข้อผิดพลาดในการเชื่อมต่อระบบ";
                    if (errorElement) {
                        errorElement.textContent = errorMessage;
                        errorElement.classList.remove('hidden');
                    } else {
                        showMessageBox("❌ ข้อผิดพลาดระบบ", errorMessage);
                    }
                } finally {
                    submitButton.disabled = false;
                    submitButton.innerHTML = 'เข้าสู่ระบบ';
                }
            }

            function showAdminLoginModal() {
                const el = document.getElementById('admin-login');
                if (el) el.classList.remove('hidden');
                const input = document.getElementById('admin-username');
                if (input) input.focus();
            }

            function hideAdminLoginModal() {
                const modal = document.getElementById('admin-login');
                if (modal) modal.classList.add('hidden');
                const form = document.getElementById('admin-login-form');
                if (form) form.reset();
                const err = document.getElementById('admin-login-error');
                if (err) err.classList.add('hidden');
            }

            function checkLoginStatus() {

                const token = sessionStorage.getItem('sessionToken');
                const longName = sessionStorage.getItem('longName');
                const username = sessionStorage.getItem('username');

                if (!token || !longName || !username) {
                    return null;
                }

                try {
                    const parts = token.split('.');
                    if (parts.length < 2) {
                        console.log('❌ โครงสร้าง token ไม่ถูกต้อง');
                        sessionStorage.clear();
                        return null;
                    }

                    const tokenData = JSON.parse(atob(parts[0]));
                    const tokenTime = tokenData.timestamp;
                    const hoursDiff = (new Date().getTime() - tokenTime) / (1000 * 60 * 60);

                    if (hoursDiff >= 24) {
                        console.log('❌ Token หมดอายุ');
                        sessionStorage.clear();
                        showMessageBox("⏰ Session หมดอายุ", "กรุณาล็อกอินใหม่");
                        return null;
                    }

                    return { username, longName, token };
                } catch (e) {
                    console.error('❌ ข้อผิดพลาดในการตรวจสอบ token:', e);
                    sessionStorage.clear();
                    return null;
                }
            }

            function checkAuthAndShowSubmenu() {
                console.log('🔐 checkAuthAndShowSubmenu called');
                const currentUser = checkLoginStatus();

                if (currentUser) {
                    console.log(`✅ User authenticated: ${currentUser.longName}`);
                    showView('submenu-view');

                    // CRITICAL FIX: Ensure dropdowns are populated before auto-selecting
                    console.log('🔄 Ensuring dropdowns are populated...');
                    populateLongOptions();

                    // Small delay to ensure DOM rendering, then auto-select
                    setTimeout(() => {
                        console.log('🔄 Auto-selecting dropdowns...');
                        updateAllLongDropdowns(currentUser.longName);
                    }, DROPDOWN_SELECT_DELAY_MS);

                    const header = document.querySelector('#submenu-view header');
                    if (header) {
                        // ensure we don't append duplicates
                        if (!header.querySelector('.submenu-user-info')) {
                            const userInfo = document.createElement('div');
                            userInfo.className = 'submenu-user-info text-sm text-stone-600 mb-2';
                            userInfo.innerHTML = `ล็อกอินเป็น: <strong>${currentUser.longName}</strong>`;
                            header.insertBefore(userInfo, header.firstChild);
                        }
                    }

                } else {
                    console.log('❌ User not authenticated, showing login modal');
                    showLoginModal();
                }
            }

            function logout() {
                try {
                    let longName = sessionStorage.getItem('longName');

                    try {
                        const currentUser = sessionStorage.getItem('currentUser');
                        if (currentUser) {
                            const userData = JSON.parse(currentUser);
                            longName = longName || userData.longName;
                        }
                    } catch (e) {
                        console.log('❌ ไม่สามารถ parse currentUser:', e);
                    }

                    sessionStorage.clear();
                    resetLongDropdowns();
                    showView('main-menu-view');

                    showMessageBox("👋 ล็อกเอาท์สำเร็จ", `คุณได้ออกจากระบบ ${longName || ''} แล้ว`);

                } catch (error) {
                    console.error('❌ ข้อผิดพลาดใน logout:', error);
                    sessionStorage.clear();
                    window.location.reload();
                }
            }

            // =============================================
            // SUMMARY & DATA FUNCTIONS
            // =============================================
            function fetchSummaryData() {
                const currentUser = checkLoginStatus();

                if (!currentUser) {
                    showMessageBox("❌ ยังไม่ได้ล็อกอิน", "กรุณาล็อกอินใหม่");
                    showLoginModal();
                    return;
                }

                const loadingElement = document.getElementById('summary-loading');
                const dataContainer = document.getElementById('summary-data-container');
                const emptyElement = document.getElementById('summary-empty');

                if (dataContainer) dataContainer.classList.add('hidden');
                if (emptyElement) emptyElement.classList.add('hidden');
                if (loadingElement) loadingElement.classList.remove('hidden');

                const selectedLong = currentUser.longName;

                if (!isAppsScriptReady('Summary Data Fetching')) {
                    if (loadingElement) loadingElement.classList.add('hidden');
                    return;
                }

                google.script.run
                    .withSuccessHandler((result) => {
                        if (loadingElement) loadingElement.classList.add('hidden');

                        try {
                            const data = safeParseJSON(result);

                            if (data && data.success && Array.isArray(data.data) && data.data.length > 0) {
                                displaySummaryData(data.data, selectedLong);
                            } else {
                                showEmptySummary(selectedLong);
                            }
                        } catch (e) {
                            console.error('❌ ข้อผิดพลาดในการประมวลผลข้อมูล:', e);
                            showMessageBox("❌ ข้อผิดพลาด!", "เกิดข้อผิดพลาดในการดึงข้อมูล");
                        }
                    })
                    .withFailureHandler((error) => {
                        if (loadingElement) loadingElement.classList.add('hidden');
                        console.error('❌ ข้อผิดพลาดในการดึงข้อมูลสรุป:', error);
                        showMessageBox("❌ ข้อผิดพลาด!", (error && error.message) || 'ไม่สามารถดึงข้อมูลได้');
                    })
                    .getAllFarmersByLong(selectedLong, currentUser.token);
            }

            function displaySummaryData(farmers, selectedLong) {
                const tableBody = document.getElementById('summary-table-body');
                const dataContainer = document.getElementById('summary-data-container');
                const countElement = document.getElementById('summary-count');
                const emptyElement = document.getElementById('summary-empty');

                if (countElement) {
                    countElement.textContent = `พบข้อมูลเกษตรกรทั้งหมด ${farmers.length} รายการในตัวแทน ${selectedLong}`;
                    countElement.className = 'text-sm text-green-600 font-semibold';
                }

                if (tableBody) tableBody.innerHTML = '';

                farmers.forEach((farmer, index) => {
                    const row = document.createElement('tr');
                    row.className = index % 2 === 0 ? 'bg-white' : 'bg-stone-50';

                    // Map Thai headers from backend to variables
                    // Keys must match exactly with Google Sheet headers in WriteSheetA
                    const id = farmer['รหัสเกษตรกร'] || farmer['a-id'] || '---';
                    const name = farmer['ชื่อ-นามสกุล'] || farmer['a-fullname'] || '---';
                    const phone = farmer['เบอร์โทร'] || farmer['a-phone'] || '---';
                    const size = farmer['ขนาดแปลง'] || farmer['a-plotsize'] || '---';
                    const species = farmer['ชนิดพืช'] || farmer['a-cropspecies'] || '---';

                    const dateCollect = farmer['วันที่เกษตรกรรับแร่'] || farmer['a-datecollect'];
                    const sackCollect = farmer['จำนวนกระสอบ'] || farmer['a-sackcollect'];

                    const dateNano = farmer['วันที่เกษตรกรรับนาโน'] || farmer['a-datenano'];
                    const nanoAmount = farmer['จำนวนนาโน_ลิตร'] || farmer['a-nanoliters'];

                    const preMitra = farmer['ค่าไมทราไจนีน'] || farmer['a-premitra'];

                    row.innerHTML = `
                    <td class="px-4 py-3 font-medium text-stone-800">${id}</td>
                    <td class="px-4 py-3">${name}</td>
                    <td class="px-4 py-3">${phone}</td>
                    <td class="px-4 py-3">${size !== '---' ? `${size} ไร่` : '---'}</td>
                    <td class="px-4 py-3">${species}</td>
                    <td class="px-4 py-3">${formatDateForDisplay(dateCollect) || '---'}</td>
                    <td class="px-4 py-3">${sackCollect ? `${sackCollect} กระสอบ` : '---'}</td>
                    <td class="px-4 py-3">${formatDateForDisplay(dateNano) || '---'}</td>
                    <td class="px-4 py-3">${nanoAmount ? `${nanoAmount} ลิตร` : '---'}</td>
                    <td class="px-4 py-3 font-medium ${getMitraColorClass(preMitra)}">
                        ${preMitra ? `${parseFloat(preMitra).toFixed(2)}` : '---'}
                    </td>
                    <td class="px-4 py-3">
                        <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${getStatusClass(farmer)}">
                            ${getStatusText(farmer)}
                        </span>
                    </td>
                `;
                    if (tableBody) tableBody.appendChild(row);
                });

                if (dataContainer) dataContainer.classList.remove('hidden');
                if (emptyElement) emptyElement.classList.add('hidden');
            }

            function showEmptySummary(selectedLong) {
                const dataContainer = document.getElementById('summary-data-container');
                const countElement = document.getElementById('summary-count');
                const emptyElement = document.getElementById('summary-empty');

                if (dataContainer) dataContainer.classList.add('hidden');
                if (emptyElement) emptyElement.classList.remove('hidden');
                if (countElement) {
                    countElement.textContent = `ไม่พบข้อมูลเกษตรกรในตัวแทน ${selectedLong}`;
                    countElement.className = 'text-sm text-red-600 font-semibold';
                }
            }

            function getMitraColorClass(premitra) {
                if (!premitra || premitra === 0) return 'text-stone-500';
                const value = parseFloat(premitra);
                if (isNaN(value)) return 'text-stone-500';
                if (value < 1) return 'text-red-600';
                if (value < 2) return 'text-yellow-600';
                return 'text-green-600';
            }

            function getStatusClass(farmer) {
                if (!farmer['a-datecollect'] && !farmer['a-datenano']) return 'bg-gray-100 text-gray-800';
                if (farmer['a-datecollect'] && farmer['a-datenano']) return 'bg-green-100 text-green-800';
                return 'bg-yellow-100 text-yellow-800';
            }

            function getStatusText(farmer) {
                if (!farmer['a-datecollect'] && !farmer['a-datenano']) return 'รอรับ';
                if (farmer['a-datecollect'] && farmer['a-datenano']) return 'รับแล้ว';
                return 'รับบางส่วน';
            }

            // =============================================
            // DROPDOWN MANAGEMENT
            // =============================================
            function updateAllLongDropdowns(selectedLong) {
                console.log('🔄 updateAllLongDropdowns called with:', selectedLong);

                if (!selectedLong) {
                    console.warn('⚠️ updateAllLongDropdowns called with empty selectedLong');
                    return;
                }

                // Normalize the selectedLong for backward compatibility
                const normalizedLong = normalizeLongName(selectedLong);
                console.log('🔄 Normalized long name:', normalizedLong);

                const longSelectors = [
                    'a-long-affiliation',
                    'b-long-affiliation',
                    'b-long-affiliation-use'
                ];

                let successCount = 0;
                let failureCount = 0;

                longSelectors.forEach(selector => {
                    const element = document.getElementById(selector);
                    if (!element) {
                        console.log(`  ❌ Element not found: ${selector}`);
                        failureCount++;
                        return;
                    }

                    // CRITICAL FIX: Ensure dropdown is populated before attempting auto-select
                    if (element.options.length === 0 || element.options.length === 1) {
                        console.log(`  ⚠️ Dropdown ${selector} is empty or has only placeholder, populating...`);

                        // Clear existing options
                        while (element.options.length > 0) {
                            element.remove(0);
                        }

                        // Populate with LONG_OPTIONS (always defined as const, no typeof check needed)
                        if (!Array.isArray(LONG_OPTIONS) || LONG_OPTIONS.length === 0) {
                            console.error(`  ❌ LONG_OPTIONS is empty for ${selector}`);
                            failureCount++;
                            return;
                        }

                        LONG_OPTIONS.forEach(option => {
                            const opt = document.createElement('option');
                            opt.value = option.value;
                            opt.textContent = option.text;
                            if (option.value === "") {
                                opt.disabled = true;
                            }
                            element.appendChild(opt);
                        });

                        console.log(`  ✅ Populated ${selector} with ${element.options.length} options`);
                    }

                    console.log(`  🔍 Checking dropdown: ${selector}, options count: ${element.options.length}`);

                    // Try to find and select the matching option (exact match first)
                    let found = false;
                    for (let i = 0; i < element.options.length; i++) {
                        const optionValue = element.options[i].value;
                        if (optionValue === normalizedLong) {
                            element.selectedIndex = i;
                            found = true;
                            console.log(`  ✅ AUTO-SELECTED at index ${i} for ${selector}: "${optionValue}"`);

                            // Trigger change event to ensure any listeners are notified
                            try {
                                const event = new Event('change', { bubbles: true });
                                element.dispatchEvent(event);
                            } catch (e) {
                                console.warn('  ⚠️ Could not dispatch change event:', e);
                            }

                            successCount++;
                            break;
                        }
                    }

                    // Improved fallback: Partial matching with safeguards against false positives
                    // Only use partial match if the normalized name is specific enough (longer than generic prefix)
                    if (!found && normalizedLong.length > MIN_NAME_LENGTH_FOR_PARTIAL_MATCH) {
                        console.warn(`  ⚠️ NO EXACT MATCH for "${normalizedLong}" in ${selector}, trying partial...`);

                        for (let i = 0; i < element.options.length; i++) {
                            const optionValue = element.options[i].value;
                            // Skip empty values
                            if (!optionValue || optionValue === "") continue;

                            // One-way matching: check if option contains normalized
                            // This avoids false positives from generic prefixes like "ตัวแทน"
                            if (optionValue.includes(normalizedLong)) {
                                console.log(`  🔧 Found partial match at index ${i}: "${optionValue}"`);
                                element.selectedIndex = i;

                                try {
                                    const event = new Event('change', { bubbles: true });
                                    element.dispatchEvent(event);
                                } catch (e) { }

                                successCount++;
                                found = true;
                                break;
                            }
                        }
                    }

                    if (!found) {
                        console.warn(`  ❌ NO MATCH found (exact or partial) for "${normalizedLong}" in ${selector}`);
                        console.warn(`  Available options:`, Array.from(element.options).map(o => `"${o.value}"`));
                        failureCount++;
                    }

                    // Lock the dropdown after selection (or attempted selection)
                    element.disabled = true;
                    element.classList.add('bg-gray-100', 'cursor-not-allowed');
                });

                updateLongDropdownLabels(true);

                // Summary log
                console.log(`📊 Dropdown update summary: ${successCount} succeeded, ${failureCount} failed`);

                // Show user feedback if there were failures
                if (failureCount > 0 && successCount === 0) {
                    console.error('❌ All dropdown updates failed! User data may not match available options.');
                    // Optional: show a subtle notification to user (uncomment if desired)
                    // showMessageBox('⚠️ Notice', 'Some dropdowns could not be auto-selected. Please verify your selections.');
                }
            }

            function resetLongDropdowns() {
                const longSelectors = [
                    'a-long-affiliation',
                    'b-long-affiliation',
                    'b-long-affiliation-use'
                ];

                longSelectors.forEach(selector => {
                    const element = document.getElementById(selector);
                    if (element) {
                        element.disabled = false;
                        element.selectedIndex = 0;
                        element.classList.remove('bg-gray-100', 'cursor-not-allowed');
                    }
                });

                updateLongDropdownLabels(false);
            }

            function updateLongDropdownLabels(isAutoSelected) {
                const labels = [
                    document.getElementById('long-affiliation-label'),
                ];

                labels.forEach(label => {
                    if (label) {
                        const autoLabel = document.getElementById('auto-selected-label');

                        if (isAutoSelected) {
                            label.textContent = 'ตัวแทนที่เกษตรกรสังกัด *';
                            if (autoLabel) autoLabel.classList.remove('hidden');
                        } else {
                            label.textContent = 'กรุณาเลือกตัวแทน';
                            if (autoLabel) autoLabel.classList.add('hidden');
                        }
                    }
                });
            }

            // =============================================
            // INITIALIZATION
            // =============================================
            function initializeFertilizerCheckboxes() {
                const items = document.querySelectorAll('.fertilizer-usage-item');
                if (!items || items.length === 0) return;

                items.forEach(item => {
                    const checkboxes = item.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(checkbox => {
                        if (checkbox.value && checkbox.value.trim() === 'อื่นๆ') {
                            // For static items that already have onchange="toggleOtherFertilizerInputUse(this)"
                            // or dynamic items, we ensure handleOtherCheckboxChange is attached if not already
                            checkbox.removeEventListener('change', handleOtherCheckboxChange);
                            checkbox.addEventListener('change', handleOtherCheckboxChange);
                        }
                    });
                });
            }

            // =============================================
            // EXTERNAL LINK FUNCTIONS
            // =============================================
            function openSurveyForm() {
                const surveyUrl = "https://script.google.com/macros/s/AKfycbwIy3D5nPqvIyVbOAjzEop3gIy2y5IXS4r1BhkmgAYEwDNZqLqGesA_2lBbQvjWzw/exec";

                const newWindow = window.open(surveyUrl, '_blank');

                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    showMessageBox(
                        "📋 เปิดฟอร์มสำรวจข้อมูลแปลงกระท่อม",
                        "กรุณาคลิกลิงก์ด้านล่างนี้:<br><br>" +
                        "<a href='" + surveyUrl + "' target='_blank' style='color: #16a34a; text-decoration: underline; font-weight: 600;'>" +
                        "🔗 เปิดฟอร์มสำรวจข้อมูลแปลงกระท่อม" +
                        "</a><br><br>" +
                        "<small>หรือคัดลอกลิงก์: " + surveyUrl + "</small>"
                    );
                } else {
                    showMessageBox(
                        "📋 เปิดฟอร์มสำรวจข้อมูลแปลงกระท่อม",
                        "✅ เปิดฟอร์มสำรวจในแท็บใหม่แล้ว"
                    );
                }
            }

            function openLeafSampleForm() {
                const leafSampleUrl = "https://script.google.com/macros/s/AKfycbzYZ0ZPXzjGLujcCto9GwJmDXEhQvSTelAYKt6Z_2Q9FhSCqWVw8DHVhjd2zr25N_dp/exec";

                const newWindow = window.open(leafSampleUrl, '_blank');

                if (!newWindow || newWindow.closed || typeof newWindow.closed == 'undefined') {
                    showMessageBox(
                        "🌿 ระบบจัดส่งตัวอย่างใบกระท่อม",
                        "กรุณาคลิกลิงก์ด้านล่างนี้:<br><br>" +
                        "<a href='" + leafSampleUrl + "' target='_blank' style='color: #16a34a; text-decoration: underline; font-weight: 600;'>" +
                        "🔗 เปิดระบบจัดส่งตัวอย่างใบกระท่อม" +
                        "</a><br><br>" +
                        "<small>หรือคัดลอกลิงก์: " + leafSampleUrl + "</small>"
                    );
                } else {
                    showMessageBox(
                        "🌿 ระบบจัดส่งตัวอย่างใบกระท่อม",
                        "✅ เปิดระบบจัดส่งตัวอย่างใบในแท็บใหม่แล้ว"
                    );
                }
            }

            // =============================================
            // ฟังก์ชันสำหรับฟอร์มสำรวจข้อมูลแปลงกระท่อม
            // =============================================

            /* ===== รายชื่อสายพันธุ์ ===== */
            const varieties = [
                'ชุมพช', 'ปทุมธานี', 'สุราษฎร์ธานี', 'หางกั้ง', 'เหรียญทอง',
                'ใบโพธิ์', 'แตงกวา', 'หลังตะพาบ', 'ยอดธง', 'เจ้าพระเยา',
                'สองเล', 'บูรพา', 'ล้านนา', 'นาคา'
            ];

            const stemLabels = {
                red: 'ก้านแดง',
                white: 'ก้านขาว',
                green: 'ก้านเขียว'
            };

            // lazy getter for stem container to avoid null before DOM ready
            function getStemContainer() {
                return document.getElementById('stem-sections');
            }

            function renderStemSection(stem) {
                if (!stem || !stemLabels[stem]) return;
                const stemContainer = getStemContainer();
                if (!stemContainer) return;
                if (document.getElementById(`section-${stem}`)) return;

                let html = `
                <div class="mt-4" id="section-${stem}" style="margin-top: 1rem;">
                    <h5 class="fw-bold" style="font-weight: 700; margin-bottom: 1rem; color: #292524;">${stemLabels[stem]} : ระบุชื่อสายพันธุ์และจำนวนต้น</h5>
                    <div class="row g-3" style="display: grid; grid-template-columns: repeat(12, 1fr); gap: 0.75rem;">
            `;

                varieties.forEach(v => {
                    // create a safe id for checkbox + label
                    const safeVar = v.replace(/["'\[\]\s]/g, '_').toLowerCase();
                    const checkboxId = `${stem}_${safeVar}_${Math.random().toString(36).substr(2, 5)}`;

                    html += `
                    <div class="col-md-6" style="grid-column: span 6;">
                        <div class="input-group" style="display: flex; align-items: center;">
                            <div class="input-group-text d-flex align-items-center gap-2" style="padding: 0.5rem; background-color: #f9fafb; border: 1px solid #d1d5db; border-radius: 0.375rem 0 0 0.375rem; display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="${checkboxId}" class="variety-cb form-check-input" style="margin-right: 0.25rem;" aria-label="เลือกสายพันธุ์ ${esc(v)}" />
                                <label for="${checkboxId}" class="mb-0" style="margin-bottom: 0; cursor: pointer;">${esc(v)}</label>
                            </div>
                            <input type="number"
                                   class="form-control variety-count"
                                   name="${stem}_count[${safeVar}]"
                                   placeholder="จำนวนต้น"
                                   disabled
                                   style="flex: 1; padding: 0.5rem; border: 1px solid #d1d5db; border-radius: 0 0.375rem 0.375rem 0; border-left: none;">
                        </div>
                    </div>
                `;
                });

                html += `</div></div>`;
                stemContainer.insertAdjacentHTML('beforeend', html);
            }

            /* ===== คำนวณผลรวม ===== */
            function calculateTotal() {
                let total = 0;
                document.querySelectorAll('.variety-count').forEach(i => {
                    if (!i.disabled && i.value) total += Number(i.value);
                });
                const totalEl = document.getElementById('total_tree_count');
                if (totalEl) totalEl.value = total;
            }

            // =============================================
            // ฟังก์ชันช่วยสำหรับฟอร์มสำรวจ
            // =============================================

            // Toggle agent input (show agent-name when 'have' is selected)
            function toggleAgentInput() {
                const agentNameInput = document.getElementById('agent-name');
                const have = document.getElementById('agent-have');
                if (!agentNameInput) return;
                if (have && have.checked) {
                    agentNameInput.classList.remove('hidden');
                    agentNameInput.required = true;
                } else {
                    agentNameInput.classList.add('hidden');
                    agentNameInput.required = false;
                    agentNameInput.value = '';
                }
            }

            // Toggle date-range visibility for gap/gacp
            function toggleDateRange(type, show) {
                const el = document.getElementById(`${type}-date-range`);
                if (!el) return;
                if (show) {
                    el.classList.remove('hidden');
                    // Set required for date inputs when visible
                    const startDate = el.querySelector(`#${type}_start_date`);
                    const endDate = el.querySelector(`#${type}_end_date`);
                    if (startDate) startDate.required = true;
                    if (endDate) endDate.required = true;
                } else {
                    el.classList.add('hidden');
                    // Remove required and clear values when hidden
                    const startDate = el.querySelector(`#${type}_start_date`);
                    const endDate = el.querySelector(`#${type}_end_date`);
                    if (startDate) {
                        startDate.required = false;
                        startDate.value = '';
                    }
                    if (endDate) {
                        endDate.required = false;
                        endDate.value = '';
                    }
                }
            }

            // Toggle visibility of "other" text inputs when 'other' checkboxes are toggled
            function setupOtherToggles() {
                const otherCheckboxes = document.querySelectorAll('input[type="checkbox"][data-other-target]');
                otherCheckboxes.forEach(cb => {
                    const targetId = cb.getAttribute('data-other-target');

                    // Remove existing listeners to prevent duplicates
                    cb.removeEventListener('change', handleOtherCheckboxToggle);

                    // Add new listener
                    cb.addEventListener('change', function () {
                        handleOtherCheckboxToggle(this, targetId);
                    });

                    // Initialize based on current state
                    const targetElem = document.getElementById(targetId);
                    if (targetElem) {
                        if (cb.checked) {
                            targetElem.classList.remove('hidden');
                            targetElem.required = true;
                        } else {
                            targetElem.classList.add('hidden');
                            targetElem.required = false;
                        }
                    }
                });
            }

            function handleOtherCheckboxToggle(checkbox, targetId) {
                const target = document.getElementById(targetId);
                if (!target) return;

                if (checkbox.checked) {
                    target.classList.remove('hidden');
                    target.required = true;
                } else {
                    target.classList.add('hidden');
                    target.required = false;
                    target.value = '';
                }
            }

            // Helper escape for HTML
            const esc = (str) => String(str ?? '').replace(/[&<>"']/g, function (m) {
                return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m];
            });

            // Helpers for preview values display
            const val = (value, minSpace = 8) => {
                const v = esc(value);
                const space = '&nbsp;'.repeat(minSpace);
                return `<span style="font-weight: 600; color: #388E3C; text-decoration: underline; white-space: nowrap;">${v || space}</span>`;
            };
            const chk = (bool) => bool ? '<span style="color: #4CAF50; font-weight: 700;">✅ มี</span>' : '<span style="color: #D32F2F;">❌ ไม่มี</span>';
            const count_val = (value) => `<span style="font-weight: 600; color: #388E3C;">${esc(value) || '-'}</span>`;

            // Date part helper
            function getDateParts(dateStr) {
                if (!dateStr) return { day: '', month: '', year: '' };
                const parts = dateStr.split('/').map(p => p.trim());
                return {
                    day: parts[0] || '',
                    month: parts[1] || '',
                    year: parts[2] || ''
                };
            }

            // month utilities
            const MONTH_NAMES = {
                '1': 'มกราคม', '2': 'กุมภาพันธ์', '3': 'มีนาคม', '4': 'เมษายน', '5': 'พฤษภาคม', '6': 'มิถุนายน',
                '7': 'กรกฎาคม', '8': 'สิงหาคม', '9': 'กันยายน', '10': 'ตุลาคม', '11': 'พฤศจิกายน', '12': 'ธันวาคม'
            };

            function monthName(n) { return MONTH_NAMES[String(n)] || ''; }

            function monthCount(start, end) {
                const s = parseInt(start, 10), e = parseInt(end, 10);
                if (!s || !e) return '';
                if (s === e) return 1;
                if (s < e) return e - s + 1;
                // wrap-around
                return (12 - s + 1) + e;
            }

            // Robust helper: get checkbox/boolean by id or name
            function getBooleanByIdOrName(nameOrId) {
                const byId = document.getElementById(nameOrId);
                if (byId) return !!byId.checked;
                // by name (could be RadioNodeList)
                const elems = document.forms['kratomForm']?.elements[nameOrId];
                if (!elems) return false;
                if (elems.length !== undefined) {
                    for (let el of elems) {
                        if (el.checked) return true;
                    }
                    return false;
                }
                return !!elems.checked;
            }

            // Get all checked values for inputs with given name
            function getCheckedValuesByName(name) {
                const form = document.getElementById('kratomForm');
                if (!form) return [];
                // support names like 'water_system[]' or 'water_system'
                const values = [];
                // try exact name first
                const elems1 = form.querySelectorAll(`[name="${name}"]`);
                if (elems1 && elems1.length > 0) {
                    elems1.forEach(el => { if (el.checked) values.push(el.value); });
                    return values;
                }
                // fallback if name ends with []
                if (name.endsWith('[]')) {
                    const alt = name.slice(0, -2);
                    const elems2 = form.querySelectorAll(`[name="${alt}"]`);
                    elems2.forEach(el => { if (el.checked) values.push(el.value); });
                } else {
                    // also try adding [] if not provided
                    const alt2 = `${name}[]`;
                    const elems3 = form.querySelectorAll(`[name="${alt2}"]`);
                    elems3.forEach(el => { if (el.checked) values.push(el.value); });
                }
                return values;
            }

            // =============================================
            // Event handling สำหรับฟอร์มสำรวจ
            // =============================================

            // Event handling for species and variety fields
            document.addEventListener('change', e => {
                // ===== stem checkbox toggles (render/remove sections) =====
                if (e.target.classList && e.target.classList.contains('stem-cb')) {
                    const stem = e.target.value;
                    if (['red', 'white', 'green'].includes(stem)) {
                        if (e.target.checked) renderStemSection(stem);
                        else {
                            const sec = document.getElementById(`section-${stem}`);
                            if (sec) sec.remove();
                            calculateTotal();
                        }
                    }

                    // show/hide special-name (cross species) when cross checkbox toggled
                    if (stem === 'cross') {
                        const special = document.getElementById('special-name');
                        if (special) special.classList.toggle('hidden', !e.target.checked);
                    }

                    // when 'other' stem checkbox toggled, setupOtherToggles handles showing the textarea via data-other-target
                }

                // ===== variety checkbox toggles enable/disable associated count input =====
                if (e.target.classList && e.target.classList.contains('variety-cb')) {
                    const input = e.target.closest('.input-group').querySelector('.variety-count');
                    if (e.target.checked) {
                        input.disabled = false;
                        input.required = true;
                    } else {
                        input.disabled = true;
                        input.required = false;
                        input.value = '';
                    }
                    calculateTotal();
                }
            });

            /* ===== listen for input changes on counts to update total ===== */
            document.addEventListener('input', e => {
                if (e.target.classList && e.target.classList.contains('variety-count')) {
                    calculateTotal();
                }
            });

            // =============================================
            // ฟังก์ชันหลักสำหรับฟอร์มสำรวจ
            // =============================================

            // Initialize mock google.script.run only when necessary (do not overwrite existing google)
            function initializeMockGoogleScript() {
                if (typeof google === 'undefined') {
                    console.warn("google.script.run is not defined. Using a mock for testing.");
                    window.google = {
                        script: {
                            run: (function () {
                                return {
                                    withSuccessHandler: function (successCb) {
                                        return {
                                            withFailureHandler: function (failureCb) {
                                                return {
                                                    submitForm: function (data) {
                                                        console.log("Mock submitForm data:", data);
                                                        setTimeout(() => successCb("Mock submission successful!"), 800);
                                                    },
                                                    // Generic passthrough to success for testing other calls
                                                    userLogin: function (u, p) { setTimeout(() => successCb({ success: true, token: btoa(JSON.stringify({ timestamp: Date.now() })) + '.x', longName: 'MockLong', username: u }), 300); }
                                                };
                                            }
                                        };
                                    }
                                };
                            })()
                        }
                    };
                } else if (typeof google.script === 'undefined') {
                    google.script = {
                        run: (function () {
                            return {
                                withSuccessHandler: function (successCb) {
                                    return {
                                        withFailureHandler: function (failureCb) {
                                            return {
                                                submitForm: function (data) {
                                                    console.log("Mock submitForm data:", data);
                                                    setTimeout(() => successCb("Mock submission successful!"), 800);
                                                }
                                            };
                                        }
                                    };
                                }
                            };
                        })()
                    };
                } else if (typeof google.script.run === 'undefined') {
                    google.script.run = (function () {
                        return {
                            withSuccessHandler: function (successCb) {
                                return {
                                    withFailureHandler: function (failureCb) {
                                        return {
                                            submitForm: function (data) {
                                                console.log("Mock submitForm data:", data);
                                                setTimeout(() => successCb("Mock submission successful!"), 800);
                                            }
                                        };
                                    }
                                };
                            }
                        };
                    })();
                }
            }

            let formDataObj = {};

            document.addEventListener('DOMContentLoaded', () => {
                // เรียกใช้ฟังก์ชันเริ่มต้นสำหรับฟอร์มสำรวจ
                setupOtherToggles();
                toggleAgentInput();

                // Initialize GAP/GACP date ranges based on pre-selected radios (if any)
                const gapChecked = document.querySelector('input[name="gap_status"]:checked');
                toggleDateRange('gap', gapChecked && gapChecked.value === 'yes');

                const gacpChecked = document.querySelector('input[name="gacp_status"]:checked');
                toggleDateRange('gacp', gacpChecked && gacpChecked.value === 'yes');

                // Substance checkboxes logic (exclusive + conditional input)
                const substanceCheckboxes = document.querySelectorAll('.substance-cb');
                const substanceValueBox = document.getElementById('substanceValueBox');
                if (substanceCheckboxes && substanceCheckboxes.length) {
                    substanceCheckboxes.forEach(cb => {
                        cb.addEventListener('change', function () {
                            // make them exclusive (only one)
                            substanceCheckboxes.forEach(other => {
                                if (other !== this) other.checked = false;
                            });

                            // show/hide input
                            if (this.id === 'substance_checked' && this.checked) {
                                if (substanceValueBox) substanceValueBox.classList.remove('hidden');
                            } else {
                                if (substanceValueBox) substanceValueBox.classList.add('hidden');
                                const valInput = document.getElementById('substance_value');
                                if (valInput) valInput.value = '';
                            }
                        });
                    });

                    // initialize visibility
                    const anyChecked = Array.from(substanceCheckboxes).some(cb => cb.checked);
                    if (!anyChecked && substanceValueBox) substanceValueBox.classList.add('hidden');
                    else {
                        const checked = document.getElementById('substance_checked');
                        if (checked && checked.checked && substanceValueBox) substanceValueBox.classList.remove('hidden');
                    }
                }

                // Initialize mock google.script.run for testing (only if needed)
                initializeMockGoogleScript();

                // Event listeners สำหรับปุ่มในฟอร์มสำรวจ
                const nextBtn = document.getElementById('nextBtn');
                const backBtn = document.getElementById('backBtn');
                const submitBtn = document.getElementById('submitBtn');
                const formStep = document.getElementById('formStep');
                const previewStep = document.getElementById('previewStep');
                const previewCard = document.getElementById('previewCard');

                // Ensure initial visibility is consistent (handle possible inline styles)
                if (formStep) {
                    formStep.classList.remove('hidden');
                    formStep.style.display = ''; // normal display
                }
                if (previewStep) {
                    previewStep.classList.add('hidden');
                    previewStep.style.display = 'none'; // hide explicitly
                }

                if (nextBtn) {
                    nextBtn.addEventListener('click', () => {
                        const form = document.getElementById('kratomForm');
                        if (!form.checkValidity()) {
                            form.reportValidity();
                            return;
                        }

                        const water_system_values = getCheckedValuesByName('water_system[]');
                        const fertilizer_values = getCheckedValuesByName('fertilizer_method[]');
                        const past_land_values = getCheckedValuesByName('past_land_types[]');
                        const agentRadio = form.querySelector('input[name="farmer_agent"]:checked');
                        const farmer_agent = agentRadio ? agentRadio.value : '';

                        // GAP/GACP/contract values
                        const gapRadio = form.querySelector('input[name="gap_status"]:checked');
                        const gap_status = gapRadio ? gapRadio.value : '';
                        const gap_start_date = document.getElementById('gap_start_date')?.value || '';
                        const gap_end_date = document.getElementById('gap_end_date')?.value || '';

                        const gacpRadio = form.querySelector('input[name="gacp_status"]:checked');
                        const gacp_status = gacpRadio ? gacpRadio.value : '';
                        const gacp_start_date = document.getElementById('gacp_start_date')?.value || '';
                        const gacp_end_date = document.getElementById('gacp_end_date')?.value || '';

                        const contractRadio = form.querySelector('input[name="contract_status"]:checked');
                        const contract_status = contractRadio ? contractRadio.value : '';

                        // Collect species data dynamically
                        const speciesData = {};
                        ['red', 'white', 'green'].forEach(stem => {
                            speciesData[stem] = {};
                            const sec = document.getElementById(`section-${stem}`);
                            if (!sec) return;
                            const rows = sec.querySelectorAll('.input-group');
                            rows.forEach(row => {
                                const cb = row.querySelector('.variety-cb');
                                const lbl = row.querySelector('.input-group-text label')?.textContent?.trim() || '';
                                const countInput = row.querySelector('.variety-count');
                                const count = (countInput && !countInput.disabled && countInput.value) ? Number(countInput.value) : 0;
                                if (cb && cb.checked && lbl) {
                                    speciesData[stem][lbl] = count;
                                }
                            });
                        });
                        // read cross (special) and other varieties from current form
                        const specialSpeciesName = document.getElementById('special_species_name')?.value || '';
                        const otherVarietiesText = document.getElementById('other_varieties')?.value || '';
                        // total from calculated field
                        const total_tree_count_specified = Number(document.getElementById('total_tree_count')?.value || 0);

                        // Substance status
                        const substance_checked = document.getElementById('substance_checked')?.checked ? 'checked' :
                            document.getElementById('substance_not_checked')?.checked ? 'not_checked' : '';

                        // Combine water/ fertilizer "other" values only in their own fields; do not conflate with hormone_etc
                        const waterSystemDisplay = [
                            ...(water_system_values || []),
                            ...(document.getElementById('water_other_text')?.value ? [`อื่นๆ: ${document.getElementById('water_other_text').value}`] : [])
                        ].filter(Boolean).join(', ');

                        const fertilizerDisplay = [
                            ...(fertilizer_values || []),
                            ...(document.getElementById('fert_other_text')?.value ? [`อื่นๆ: ${document.getElementById('fert_other_text').value}`] : [])
                        ].filter(Boolean).join(', ');

                        // read combined hormone_and_other and volcanic checkbox
                        const hormoneAndOther = document.getElementById('hormone_and_other')?.value || '';
                        const volcanicChecked = document.getElementById('mineral_volcanic')?.checked || false;
                        const firstname = (form.elements['farmer_firstname']?.value || '').trim();
                        const lastname = (form.elements['farmer_lastname']?.value || '').trim();
                        const fallbackFullName = (form.elements['farmer_name_main']?.value || '').trim();
                        const fullName = (firstname || lastname) ? `${firstname} ${lastname}`.trim() : fallbackFullName;

                        formDataObj = {
                            farmer_agent,
                            agent_name: form.elements['agent_name']?.value || '',
                            farmer_firstname: firstname,
                            farmer_lastname: lastname,
                            farmer_name_main: fullName,
                            coord_x: form.elements['coord_x']?.value || '',
                            coord_y: form.elements['coord_y']?.value || '',
                            subdistrict: form.elements['subdistrict']?.value || '',
                            district: form.elements['district']?.value || '',
                            province: form.elements['province']?.value || '',
                            land_evidence: form.elements['land_evidence']?.value || '',
                            tel: form.elements['tel']?.value || '',
                            tree_count: form.elements['tree_count']?.value || '',
                            plant_date: form.elements['plant_date']?.value || '',
                            ready_to_sell_count: form.elements['ready_to_sell_count']?.value || '',
                            water_system_values,
                            water_other_text: document.getElementById('water_other_text')?.value || '',
                            water_system_display: waterSystemDisplay, // เพิ่มฟิลด์นี้
                            water_ph: form.elements['water_ph']?.value || '',
                            fertilizer_values,
                            fert_other_text: document.getElementById('fert_other_text')?.value || '',
                            fertilizer_display: fertilizerDisplay, // เพิ่มฟิลด์นี้
                            soil_ph: form.elements['soil_ph']?.value || '',
                            hormone_and_other: hormoneAndOther, // combined field
                            mineral_volcanic: volcanicChecked ? 'แร่ภูเขาไฟ' : '',
                            substance_value: form.elements['substance_value']?.value || '',
                            substance_status: substance_checked,
                            dry_start_month: form.elements['dry_start_month']?.value || '',
                            dry_end_month: form.elements['dry_end_month']?.value || '',
                            rainy_start_month: form.elements['rainy_start_month']?.value || '',
                            rainy_end_month: form.elements['rainy_end_month']?.value || '',
                            winter_start_month: form.elements['winter_start_month']?.value || '',
                            winter_end_month: form.elements['winter_end_month']?.value || '',
                            gap_status,
                            gap_start_date,
                            gap_end_date,
                            gacp_status,
                            gacp_start_date,
                            gacp_end_date,
                            contract_status,
                            species: speciesData,
                            special_species_name: specialSpeciesName,
                            other_varieties: otherVarietiesText,
                            total_tree_count_specified,
                            past_land_values,
                            past_other_text: document.getElementById('past_other_text')?.value || '',
                            coordinator_name: form.elements['coordinator_name']?.value || '',
                            coordinator_tel: form.elements['coordinator_tel']?.value || ''
                        };

                        // Prepare season display strings and counts
                        const data = formDataObj;
                        const rainyRange = (data.rainy_start_month || data.rainy_end_month) ? `${monthName(data.rainy_start_month) || '-'} — ${monthName(data.rainy_end_month) || '-'}` : '-';
                        const rainyCount = (data.rainy_start_month && data.rainy_end_month) ? `${monthCount(data.rainy_start_month, data.rainy_end_month)} เดือน` : '-';
                        const dryRange = (data.dry_start_month || data.dry_end_month) ? `${monthName(data.dry_start_month) || '-'} — ${monthName(data.dry_end_month) || '-'}` : '-';
                        const dryCount = (data.dry_start_month && data.dry_end_month) ? `${monthCount(data.dry_start_month, data.dry_end_month)} เดือน` : '-';
                        const winterRange = (data.winter_start_month || data.winter_end_month) ? `${monthName(data.winter_start_month) || '-'} — ${monthName(data.winter_end_month) || '-'}` : '-';
                        const winterCount = (data.winter_start_month && data.winter_end_month) ? `${monthCount(data.winter_start_month, data.winter_end_month)} เดือน` : '-';

                        const dateParts = getDateParts(data.plant_date);

                        // Summarize species for preview (compact)
                        const speciesSummary = [];
                        Object.keys(data.species).forEach(stem => {
                            const entries = data.species[stem];
                            Object.keys(entries || {}).forEach(v => {
                                speciesSummary.push(`${v} (${stemLabels[stem] || stem}): ${entries[v]}`);
                            });
                        });
                        // Add other and cross separately (do not conflate)
                        if (data.other_varieties) {
                            // split by comma for display items
                            const others = data.other_varieties.split(',').map(s => s.trim()).filter(Boolean);
                            others.forEach(o => speciesSummary.push(`อื่นๆ: ${o}`));
                        }
                        if (data.special_species_name) speciesSummary.push(`ข้ามสายพันธุ์: ${data.special_species_name}`);

                        // ------------------------
                        // PREVIEW HTML VERSION 2.1 - separate hormone and other; separate other & cross species
                        // ------------------------

                        // แปลงวันที่ GAP/GACP เป็นรูปแบบไทย DD/MM/YYYY สำหรับ preview
                        const gapStartDisplay = formatDateForDisplay(data.gap_start_date || '');
                        const gapEndDisplay = formatDateForDisplay(data.gap_end_date || '');
                        const gacpStartDisplay = formatDateForDisplay(data.gacp_start_date || '');
                        const gacpEndDisplay = formatDateForDisplay(data.gacp_end_date || '');

                        let previewHtml = `
<style>
  .preview-container {
    font-family: 'Sukhumvit Set', 'Sukhumvit', 'Inter', 'Sarabun', sans-serif;
    line-height: 1.45;
    color: #212121;
    max-width: 1200px;
    margin: 0 auto;
    padding: 12px;
  }

  /* Section Header */
  .section-header {
    background: linear-gradient(135deg, #1b5e20 0%, #388E3C 100%);
    color: white;
    padding: 12px 16px;
    border-radius: 8px 8px 0 0;
    margin-bottom: 0;
    font-weight: 700;
    font-size: 1.1rem;
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .section-header i {
    font-size: 1.2rem;
  }

  /* Lock Cards */
  .lock-card {
    background: white;
    border: 2px solid #E8F5E9;
    border-radius: 8px;
    margin-bottom: 20px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
  }

  .lock-content {
    padding: 16px;
  }

  /* Grid Layout for Lock Cards */
  .lock-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
    gap: 16px;
    margin-bottom: 20px;
  }

  .lock-row {
    display: flex;
    align-items: center;
    margin-bottom: 10px;
    padding: 6px 0;
    border-bottom: 1px dashed #E0E0E0;
  }

  .lock-row:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }

  .lock-label {
    font-weight: 600;
    color: #1b5e20;
    min-width: 140px;
    font-size: 0.9rem;
  }

  .lock-value {
    color: #212121;
    word-break: break-word;
    flex: 1;
    font-size: 0.9rem;
  }

  .lock-value.mono {
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;
  }

  /* Full Width Lock Card */
  .full-width-lock {
    grid-column: 1 / -1;
  }

  /* Summary Table */
  .summary-table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.9rem;
    margin: 16px 0;
  }

  .summary-table th {
    background: #F1F8E9;
    color: #1b5e20;
    font-weight: 700;
    padding: 10px;
    text-align: left;
    border: 1px solid #C8E6C9;
  }

  .summary-table td {
    padding: 10px;
    border: 1px solid #E0E0E0;
    vertical-align: top;
  }

  .summary-table tr:nth-child(even) {
    background: #F9F9F9;
  }

  /* Status Badges */
  .status-badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    text-align: center;
  }

  .status-success {
    background: #E8F5E9;
    color: #2E7D32;
  }

  .status-warning {
    background: #FFF3E0;
    color: #F57C00;
  }

  .status-danger {
    background: #FFEBEE;
    color: #C62828;
  }

  /* Species Grid */
  .species-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
    gap: 10px;
    margin-top: 8px;
  }

  .species-item {
    background: #F9F9F9;
    padding: 8px 12px;
    border-radius: 6px;
    font-size: 0.85rem;
  }

  .species-label {
    font-weight: 600;
    color: #555;
  }

  .species-count {
    font-weight: 700;
    color: #1b5e20;
  }

  /* Signature Section */
  .signature-section {
    background: #F8F9FA;
    border-radius: 8px;
    padding: 20px;
    margin-top: 24px;
    border: 1px solid #E0E0E0;
  }

  .signature-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 16px;
    margin-top: 12px;
  }

  .signature-item {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .signature-label {
    font-weight: 600;
    color: #1b5e20;
    min-width: 120px;
  }

  .signature-value {
    flex: 1;
    padding: 6px 12px;
    background: white;
    border: 1px solid #E0E0E0;
    border-radius: 4px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .preview-container {
      padding: 8px;
    }

    .lock-grid {
      grid-template-columns: 1fr;
    }

    .lock-row {
      flex-direction: column;
      align-items: flex-start;
      gap: 4px;
    }

    .lock-label {
      min-width: auto;
      font-size: 0.85rem;
    }

    .summary-table {
      font-size: 0.8rem;
    }

    .summary-table th,
    .summary-table td {
      padding: 6px 8px;
    }

    .species-grid {
      grid-template-columns: 1fr;
    }

    .signature-grid {
      grid-template-columns: 1fr;
    }
  }

  @media (min-width: 1024px) {
    .lock-grid {
      grid-template-columns: repeat(2, 1fr);
    }
  }
</style>

<div class="preview-container">
  <!-- ===================== LOCK 1: ข้อมูลเกษตรกรหลัก ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-person-badge"></i> ข้อมูลเกษตรกรหลัก
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">ชื่อเกษตรกร:</span>
            <span class="lock-value">${val(data.farmer_name_main)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">เบอร์โทรศัพท์:</span>
            <span class="lock-value mono">${val(data.tel || '-', 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">สถานะตัวแทน:</span>
            <span class="lock-value">${val(data.farmer_agent === 'have' ? 'มีตัวแทน' : data.farmer_agent === 'none' ? 'ยังไม่มีตัวแทน' : '-', 6)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ชื่อตัวแทน:</span>
            <span class="lock-value">${val(data.agent_name || '-', 8)}</span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">พิกัด X:</span>
            <span class="lock-value mono">${val(data.coord_x, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">พิกัด Y:</span>
            <span class="lock-value mono">${val(data.coord_y, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ตำบล / อำเภอ / จังหวัด:</span>
            <span class="lock-value">${val(data.subdistrict, 4)} / ${val(data.district, 4)} / ${val(data.province, 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">หลักฐานที่ดิน:</span>
            <span class="lock-value">${val(data.land_evidence || '-', 6)}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== LOCK 2: ข้อมูลแปลงและพันธุ์ไม้ ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-tree"></i> ข้อมูลแปลงและพันธุ์ไม้
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">จำนวนต้นทั้งหมด:</span>
            <span class="lock-value">${val(data.tree_count || '-', 6)} ต้น</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">วันที่ปลูกต้นกล้า:</span>
            <span class="lock-value">${val(data.plant_date || '-', 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">จำนวนต้นพร้อมขาย:</span>
            <span class="lock-value">${val(data.ready_to_sell_count || '-', 6)} ต้น</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ประวัติพื้นที่ 3 ปี:</span>
            <span class="lock-value">${val((Array.isArray(data.past_land_values) && data.past_land_values.length) ? data.past_land_values.join(', ') : (data.past_other_text || '-'), 12)}</span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">PH น้ำ:</span>
            <span class="lock-value">${val(data.water_ph || '-', 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">PH ดิน:</span>
            <span class="lock-value">${val(data.soil_ph || '-', 4)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">จำนวนรวมจากสายพันธุ์:</span>
            <span class="lock-value">${val(data.total_tree_count_specified ? String(data.total_tree_count_specified) : '-', 6)} ต้น</span>
          </div>
        </div>
      </div>

      <!-- ตารางสรุปสายพันธุ์ (แยก Other / Cross) -->
      <table class="summary-table">
        <thead>
          <tr>
            <th>ก้านแดง</th>
            <th>ก้านขาว</th>
            <th>ก้านเขียว</th>
            <th>อื่นๆ (ชื่อ)</th>
            <th>ข้ามสายพันธุ์ (ชื่อ)</th>
            <th>รวมทั้งหมด</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>${count_val(Object.values(data.species?.red || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${count_val(Object.values(data.species?.white || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${count_val(Object.values(data.species?.green || {}).reduce((a, b) => a + (Number(b) || 0), 0) || '0')}</td>
            <td>${val(data.other_varieties || '-', 6)}</td>
            <td>${val(data.special_species_name || '-', 6)}</td>
            <td class="status-success">${count_val(data.total_tree_count_specified || '0')}</td>
          </tr>
        </tbody>
      </table>

      <!-- รายละเอียดสายพันธุ์ (ถ้ามี) -->
      ${speciesSummary.length > 0 ? `
      <div style="margin-top: 12px;">
        <div style="font-weight: 600; color: #1b5e20; margin-bottom: 8px;">รายละเอียดสายพันธุ์:</div>
        <div class="species-grid">
          ${speciesSummary.map(item => `
            <div class="species-item">
              <div class="species-label">${esc(item.split(':')[0] || '')}</div>
              <div class="species-count">${esc((item.split(':')[1] || '').trim())}</div>
            </div>
          `).join('')}
        </div>
      </div>
      ` : ''}
    </div>
  </div>

  <!-- ===================== LOCK 3: การบริหารจัดการแปลง ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-tools"></i> การบริหารจัดการแปลง
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">ระบบให้น้ำ:</span>
            <span class="lock-value">${val(data.water_system_display || '-', 6)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">ระบให้ปุ๋ย:</span>
            <span class="lock-value">${val(data.fertilizer_display || '-', 6)}</span>
          </div>
        </div>
      </div>

      <!-- แถวแยกสำหรับ ฮอร์โมน/อื่นๆ และ แร่ภูเขาไฟ -->
      <div style="margin-top: 12px;">
        <div class="lock-row">
          <span class="lock-label">ฮอร์โมน / อื่นๆ:</span>
          <span class="lock-value">${val(data.hormone_and_other || '-', 8)}</span>
        </div>
        <div class="lock-row">
          <span class="lock-label">แร่ภูเขาไฟ (ถ้ามี):</span>
          <span class="lock-value">${data.mineral_volcanic ? val(data.mineral_volcanic) : '-'}</span>
        </div>
      </div>

      <!-- ตารางฤดูกาล -->
      <table class="summary-table" style="margin-top:12px;">
        <thead>
          <tr>
            <th>ฤดูกาล</th>
            <th>ช่วงเวลา</th>
            <th>จำนวนเดือน</th>
            <th>สถานะ</th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>ฤดูแล้ง</td>
            <td>${val(dryRange, 6)}</td>
            <td>${val(dryCount, 4)}</td>
            <td>${dryRange !== '-' ? '<span class="status-success">✅ มีข้อมูล</span>' : '<span class="status-warning">⚠️ ไม่ระบุ</span>'}</td>
          </tr>
          <tr>
            <td>ฤดูฝน</td>
            <td>${val(rainyRange, 6)}</td>
            <td>${val(rainyCount, 4)}</td>
            <td>${rainyRange !== '-' ? '<span class="status-success">✅ มีข้อมูล</span>' : '<span class="status-warning">⚠️ ไม่ระบุ</span>'}</td>
          </tr>
          <tr>
            <td>ฤดูหนาว</td>
            <td>${val(winterRange, 6)}</td>
            <td>${val(winterCount, 4)}</td>
            <td>${winterRange !== '-' ? '<span class="status-success">✅ มีข้อมูล</span>' : '<span class="status-warning">⚠️ ไม่ระบุ</span>'}</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- ===================== LOCK 4: มาตรฐานและสัญญา ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-file-earmark-check"></i> มาตรฐานและสัญญา
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">GAP สมุนไพร:</span>
            <span class="lock-value">
              ${data.gap_status === 'yes' ?
                                '<span class="status-success">✅ มี (' + val(gapStartDisplay || '-', 6) + ' — ' + val(gapEndDisplay || '-', 6) + ')</span>' :
                                data.gap_status === 'no' ?
                                    '<span class="status-warning">❌ ไม่มี</span>' :
                                    '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
          <div class="lock-row">
            <span class="lock-label">GACP สมุนไพร:</span>
            <span class="lock-value">
              ${data.gacp_status === 'yes' ?
                                '<span class="status-success">✅ มี (' + val(gacpStartDisplay || '-', 6) + ' — ' + val(gacpEndDisplay || '-', 6) + ')</span>' :
                                data.gacp_status === 'no' ?
                                    '<span class="status-warning">❌ ไม่มี</span>' :
                                    '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">คู่สัญญา:</span>
            <span class="lock-value">
              ${data.contract_status === 'old' ?
                                '<span class="status-warning">⚠️ ติดสัญญาเก่า</span>' :
                                data.contract_status === 'none' ?
                                    '<span class="status-success">✅ ไม่ติดสัญญาเก่า</span>' :
                                    '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
          <div class="lock-row">
            <span class="lock-label">สถานะโดยรวม:</span>
            <span class="lock-value">
              ${(data.gap_status === 'yes' || data.gacp_status === 'yes') ?
                                '<span class="status-success">✅ ผ่านมาตรฐาน</span>' :
                                '<span class="status-warning">⚠️ ยังไม่ผ่านมาตรฐาน</span>'}
            </span>
          </div>
        </div>

        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">สารไมทราไจนีน:</span>
            <span class="lock-value">
              ${data.substance_status === 'checked' ?
                                '<span class="status-success">✅ ตรวจแล้ว (' + val(data.substance_value || '0', 4) + ')</span>' :
                                data.substance_status === 'not_checked' ?
                                    '<span class="status-warning">❌ ยังไม่ตรวจ</span>' :
                                    '<span class="status-danger">- ไม่ระบุ -</span>'}
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===================== LOCK 5: ข้อมูลผู้ประสานงาน ===================== -->
  <div class="lock-card">
    <div class="section-header">
      <i class="bi bi-person-lines-fill"></i> ข้อมูลผู้ประสานงาน
    </div>
    <div class="lock-content">
      <div class="lock-grid">
        <!-- ล็อคซ้าย -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">ตัวแทนผู้ประสานงาน:</span>
            <span class="lock-value">${val(data.coordinator_name, 12)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">เบอร์โทรศัพท์:</span>
            <span class="lock-value mono">${val(data.coordinator_tel, 6)}</span>
          </div>
        </div>

        <!-- ล็อคขวา -->
        <div class="lock-item">
          <div class="lock-row">
            <span class="lock-label">วันที่ตรวจสอบ:</span>
            <span class="lock-value">${val(new Date().toLocaleDateString('th-TH'), 10)}</span>
          </div>
          <div class="lock-row">
            <span class="lock-label">สถานะการส่ง:</span>
            <span class="lock-value status-success">✅ พร้อมส่งข้อมูล</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div class="signature-section">
    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid #E0E0E0;">
      <div style="font-weight: 600; color: #555; margin-bottom: 8px;">ผู้ตรวจสอบ (บริษัท บ้านไทยเฮิร์บ เซ็นเตอร์ จำกัด)</div>
      <div style="font-size: 0.9rem; color: #777;">
        ✅ ข้อมูลทั้งหมดถูกตรวจสอบและยืนยันเรียบร้อยแล้ว<br>
        📞 ช่องทางติดต่อ: LINE: @bthcenter | โทร: 092-4579929, 063-5033042
      </div>
    </div>
  </div>
</div>
`;
                        // End previewHtml

                        previewCard.innerHTML = previewHtml;

                        // Show preview and hide form (ensure both class and inline style updated)
                        if (formStep) {
                            formStep.classList.add('hidden');
                            formStep.style.display = 'none';
                        }
                        if (previewStep) {
                            previewStep.classList.remove('hidden');
                            previewStep.style.display = 'block';
                        }

                        window.scrollTo(0, 0);
                    });
                }

                if (backBtn) {
                    backBtn.addEventListener('click', () => {
                        // Show form and hide preview (update both class and inline style)
                        if (formStep) {
                            formStep.classList.remove('hidden');
                            formStep.style.display = '';
                        }
                        if (previewStep) {
                            previewStep.classList.add('hidden');
                            previewStep.style.display = 'none';
                        }
                        window.scrollTo(0, 0);
                    });
                }

                if (submitBtn) {
                    submitBtn.addEventListener('click', () => {
                        const submitBtnEl = document.getElementById('submitBtn');
                        const originalText = submitBtnEl.innerHTML;

                        submitBtnEl.disabled = true;
                        submitBtnEl.innerHTML = '<div class="loading-spinner"></div> กำลังส่ง...';

                        google.script.run.withSuccessHandler(msg => {
                            showMessageBox('✅ สำเร็จ', msg);
                            document.getElementById('kratomForm').reset();

                            // Hide "other" inputs, agent input and GAP/GACP ranges after reset
                            ['water_other_text', 'fert_other_text', 'past_other_text', 'agent-name', 'gap-date-range', 'gacp-date-range', 'special-name', 'substanceValueBox'].forEach(id => {
                                const el = document.getElementById(id);
                                if (el) {
                                    el.classList.add('hidden');
                                }
                            });

                            // clear other_varieties textarea and combined hormone/other
                            const otherVar = document.getElementById('other_varieties');
                            if (otherVar) otherVar.value = '';
                            const hormoneAnd = document.getElementById('hormone_and_other');
                            if (hormoneAnd) hormoneAnd.value = '';
                            const volcanicCb = document.getElementById('mineral_volcanic');
                            if (volcanicCb) volcanicCb.checked = false;

                            // remove generated stem sections and reset total
                            const scb = document.querySelectorAll('.stem-cb');
                            scb.forEach(cb => cb.checked = false);
                            const stCont = getStemContainer();
                            if (stCont) stCont.innerHTML = '';
                            const totalEl = document.getElementById('total_tree_count');
                            if (totalEl) totalEl.value = '';

                            // ensure substance checkboxes are reset
                            const substanceCheckboxes = document.querySelectorAll('.substance-cb');
                            substanceCheckboxes.forEach(cb => cb.checked = false);
                            const subVal = document.getElementById('substance_value');
                            if (subVal) subVal.value = '';

                            // hide preview, show form (update both class and inline style)
                            if (previewStep) {
                                previewStep.classList.add('hidden');
                                previewStep.style.display = 'none';
                            }
                            if (formStep) {
                                formStep.classList.remove('hidden');
                                formStep.style.display = '';
                            }

                            submitBtnEl.disabled = false;
                            submitBtnEl.innerHTML = originalText;
                        }).withFailureHandler(error => {
                            let errorMessage = "เกิดข้อผิดพลาดในการส่งข้อมูล";
                            if (error && error.message) {
                                errorMessage += ": " + esc(error.message);
                                if (error.message.includes('ScriptError: Exception: ไม่พบรายการตามตารางที่ระบุ') || error.message.includes('ScriptError: Exception: ไม่พบชีตตามชื่อ')) {
                                    errorMessage += "<br><br><b>นี่คือข้อผิดพลาดจาก Google Apps Script (GAS) Backend ของคุณ โปรดตรวจสอบ:</b>"
                                        + "<br>1. ชื่อฟังก์ชัน GAS ที่รับข้อมูล (ต้องเป็น <code>submitForm</code>)"
                                        + "<br>2. ชื่อ Google Sheet หรือชื่อชีต (Sheet Name) ที่อ้างอิงถึงในโค้ด GAS ว่าถูกต้องหรือไม่"
                                        + "<br>3. สิทธิ์ในการเข้าถึง Google Sheet นั้น";
                                }
                            }
                            showMessageBox('❌ ข้อผิดพลาด', errorMessage);
                            submitBtnEl.disabled = false;
                            submitBtnEl.innerHTML = originalText;
                        }).submitForm(formDataObj);
                    });
                }
            });

            // =============================================
            // Custom Alert/Modal Function (Bootstrap modal)
            // =============================================
            function showCustomAlert(message, type = 'info') {
                const alertId = 'custom-alert-modal';
                let alertModal = document.getElementById(alertId);

                // Create modal if doesn't exist
                if (!alertModal) {
                    alertModal = document.createElement('div');
                    alertModal.id = alertId;
                    document.body.appendChild(alertModal);
                }

                // Determine colors based on type
                let bgColor = 'bg-blue-600';
                let titleText = 'ข้อความแจ้งเตือน';
                let iconSvg = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;

                if (type === 'success') {
                    bgColor = 'bg-green-600';
                    titleText = '✅ สำเร็จ';
                    iconSvg = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                } else if (type === 'danger') {
                    bgColor = 'bg-red-600';
                    titleText = '❌ ข้อผิดพลาด';
                    iconSvg = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
                } else if (type === 'warning') {
                    bgColor = 'bg-yellow-500';
                    titleText = '⚠️ คำเตือน';
                    iconSvg = `<svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>`;
                }

                alertModal.innerHTML = `
                    <div class="fixed inset-0 z-[9999] flex items-center justify-center p-4" id="alert-backdrop">
                        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm" onclick="document.getElementById('custom-alert-modal').innerHTML=''"></div>
                        <div class="relative bg-white rounded-2xl shadow-2xl max-w-md w-full overflow-hidden transform transition-all animate-fade-in">
                            <div class="${bgColor} px-6 py-4 flex items-center gap-3 text-white">
                                ${iconSvg}
                                <h3 class="font-bold text-lg">${titleText}</h3>
                                <button onclick="document.getElementById('custom-alert-modal').innerHTML=''" class="ml-auto text-white/80 hover:text-white">
                                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                            <div class="px-6 py-5 text-gray-700">
                                <p class="text-base">${message}</p>
                            </div>
                            <div class="px-6 pb-5 flex justify-end">
                                <button onclick="document.getElementById('custom-alert-modal').innerHTML=''" 
                                    class="px-5 py-2.5 ${bgColor} text-white font-medium rounded-lg hover:opacity-90 transition-opacity">
                                    ปิด
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            window.showSection = function (targetId, btn) {
                try {
                    // deactivate all tabs
                    document.querySelectorAll('.nav-tab').forEach(t => {
                        t.classList.remove('active');
                        t.setAttribute('aria-selected', 'false');
                    });

                    // activate clicked tab if provided
                    if (btn && btn.classList) {
                        btn.classList.add('active');
                        btn.setAttribute('aria-selected', 'true');
                    }

                    // hide all sections and show the target
                    document.querySelectorAll('.content-section').forEach(s => {
                        s.classList.remove('active');
                        s.classList.add('hidden');
                    });

                    const target = document.getElementById(targetId);
                    if (target) {
                        target.classList.remove('hidden');
                        target.classList.add('active');
                    } else {
                        console.warn('showSection: ไม่พบ element id=', targetId);
                    }

                    // Optional: apply visual color from data-section-color
                    try {
                        const color = btn && (btn.getAttribute('data-section-color') || btn.dataset.sectionColor);
                        // remove previous color indicators
                        document.querySelectorAll('.content-section').forEach(s => s.style.borderTop = '');
                        if (color && target) {
                            // you can adjust color mapping or use CSS variables
                            target.style.borderTop = `4px solid ${color === 'orange' ? '#fb923c' : color === 'blue' ? '#3b82f6' : '#6b7280'}`;
                        }
                    } catch (e) { /* ignore */ }
                } catch (e) {
                    console.error('showSection error', e);
                }
            };

            document.addEventListener('DOMContentLoaded', function () {
                document.querySelectorAll('.nav-tab').forEach(btn => {
                    // ignore if already has inline onclick that you want to keep;
                    // this ensures tabs work even if showSection wasn't defined earlier
                    btn.removeEventListener('click', btn._navTabHandler);
                    btn._navTabHandler = function (ev) {
                        const target = btn.getAttribute('data-target') || btn.dataset.target;
                        if (target) window.showSection(target, btn);
                    };
                    btn.addEventListener('click', btn._navTabHandler);
                });
            });

            // Admin client-side manager (single IIFE)
            (function () {
                // Configuration constants
                const CONFIG = {
                    MAX_SEARCH_QUERY_LENGTH: 100,
                    SEARCH_DEBOUNCE_MS: 300,
                    MAX_SAFE_EXPORT_ROWS: 5000,
                    MAX_LOGIN_ATTEMPTS: 5,
                    LOGIN_ATTEMPT_WINDOW_MS: 300000, // 5 minutes
                    DEBUG_FETCH_TIMEOUT_MS: 30000 // 30 seconds timeout for debug operations
                };

                // state
                let lastFetchedData = [];
                let currentDisplayKeys = []; // keep keys order used to render the table (for CSV export)
                let isTableExpanded = false;
                let isFetching = false;

                // Rate limiting state for admin login
                let adminLoginAttempts = [];

                // Rate limiting helper
                function checkAdminLoginRateLimit() {
                    const now = Date.now();
                    // Remove attempts older than the window
                    adminLoginAttempts = adminLoginAttempts.filter(timestamp =>
                        now - timestamp < CONFIG.LOGIN_ATTEMPT_WINDOW_MS
                    );

                    if (adminLoginAttempts.length >= CONFIG.MAX_LOGIN_ATTEMPTS) {
                        // Use reduce for safety with large arrays (avoid spread operator stack overflow)
                        const oldestAttempt = adminLoginAttempts.reduce((min, current) =>
                            Math.min(min, current), Number.MAX_SAFE_INTEGER
                        );
                        const waitTime = Math.ceil((CONFIG.LOGIN_ATTEMPT_WINDOW_MS - (now - oldestAttempt)) / 1000 / 60);
                        return { allowed: false, waitMinutes: waitTime };
                    }

                    adminLoginAttempts.push(now);
                    return { allowed: true };
                }

                // Expose rate limit check to handleAdminLogin
                window._adminRateLimitCheck = checkAdminLoginRateLimit;

                // ---------- Utilities ----------
                function escapeHtml(str) {
                    if (str === null || str === undefined) return '';
                    return String(str)
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;')
                        .replace(/"/g, '&quot;')
                        .replace(/'/g, '&#39;');
                }

                function setAdminControlsDisabled(disabled) {
                    const ids = [
                        'btn-fetch-farmers', 'btn-fetch-usage', 'btn-fetch-merged',
                        'btn-simple-test', 'btn-sheet-test', 'btn-admin-conn',
                        'btn-direct-getAll', 'btn-debug-getAll', 'admin-search-btn',
                        'admin-export-btn', 'admin-refresh-table'
                    ];
                    ids.forEach(id => {
                        const el = document.getElementById(id);
                        if (el) el.disabled = disabled;
                    });
                    // also disable logout to prevent race
                    const logoutBtn = document.getElementById('admin-logout-btn');
                    if (logoutBtn) logoutBtn.disabled = disabled;
                }

                // ---------- Table helpers ----------
                function createFooterSummary(count, columns) {
                    const footer = document.createElement('div');
                    footer.style.padding = '10px';
                    footer.style.background = '#f3f4f6';
                    footer.style.borderTop = '1px solid #d1d5db';
                    footer.style.fontSize = '12px';
                    footer.style.color = '#6b7280';
                    footer.style.position = 'sticky';
                    footer.style.bottom = '0';
                    footer.style.display = 'block';
                    footer.textContent = `📊 แสดง ${count} รายการ | 📋 ${columns} คอลัมน์ | 🕒 ${new Date().toLocaleTimeString('th-TH')}`;
                    return footer;
                }

                function clearTable() {
                    const container = document.getElementById('admin-table-container');
                    if (container) container.innerHTML = '';
                    currentDisplayKeys = [];
                }

                // robust displayTable: uses union of keys, escapes via textContent
                function displayTable(dataArray) {
                    try {
                        console.log('displayTable called with:', dataArray);

                        lastFetchedData = Array.isArray(dataArray) ? dataArray : [];
                        console.log('lastFetchedData length:', lastFetchedData.length);

                        const container = document.getElementById('admin-table-container');
                        const wrapper = document.getElementById('admin-table-wrapper');
                        const empty = document.getElementById('admin-empty');

                        if (!container || !wrapper || !empty) {
                            console.error('Required elements not found:', { container: !!container, wrapper: !!wrapper, empty: !!empty });
                            return;
                        }

                        if (!lastFetchedData || lastFetchedData.length === 0) {
                            wrapper.classList.add('hidden');
                            empty.classList.remove('hidden');
                            container.innerHTML = '';
                            currentDisplayKeys = [];
                            return;
                        }

                        empty.classList.add('hidden');
                        wrapper.classList.remove('hidden');

                        // union keys across all rows to ensure all columns shown
                        // preserve order by first-seen across rows
                        const keyOrder = [];
                        const seen = new Set();
                        lastFetchedData.forEach(row => {
                            if (row && typeof row === 'object') {
                                Object.keys(row).forEach(k => {
                                    if (!seen.has(k)) {
                                        seen.add(k);
                                        keyOrder.push(k);
                                    }
                                });
                            }
                        });

                        const keys = keyOrder.length ? keyOrder : [];

                        // clear and style container
                        container.innerHTML = '';
                        container.style.maxHeight = '500px';
                        container.style.overflow = 'auto';
                        container.style.border = '2px solid #e5e7eb';
                        container.style.borderRadius = '8px';
                        container.style.background = 'white';
                        container.style.position = 'relative';

                        // build table elements
                        const table = document.createElement('table');
                        table.style.width = '100%';
                        table.style.borderCollapse = 'collapse';
                        table.style.minWidth = '800px';

                        // thead
                        const thead = document.createElement('thead');
                        thead.style.position = 'sticky';
                        thead.style.top = '0';
                        thead.style.background = '#f8fafc';
                        thead.style.zIndex = '10';
                        const trh = document.createElement('tr');
                        keys.forEach(key => {
                            const th = document.createElement('th');
                            th.style.padding = '12px 8px';
                            th.style.textAlign = 'left';
                            th.style.border = '1px solid #d1d5db';
                            th.style.whiteSpace = 'nowrap';
                            th.style.minWidth = '120px';
                            th.style.fontWeight = '700';
                            th.textContent = key;
                            trh.appendChild(th);
                        });
                        thead.appendChild(trh);
                        table.appendChild(thead);

                        // tbody
                        const tbody = document.createElement('tbody');
                        lastFetchedData.forEach((row, rowIndex) => {
                            const tr = document.createElement('tr');
                            tr.style.backgroundColor = (rowIndex % 2 === 0) ? '#ffffff' : '#f9fafb';

                            keys.forEach(k => {
                                const td = document.createElement('td');
                                td.style.padding = '8px';
                                td.style.border = '1px solid #e5e7eb';
                                td.style.verticalAlign = 'top';
                                td.style.maxWidth = '200px';
                                td.style.wordBreak = 'break-word';

                                let v = (row && Object.prototype.hasOwnProperty.call(row, k)) ? row[k] : '';
                                if (v === null || v === undefined) v = '';
                                if (typeof v === 'object') {
                                    try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                                }
                                // safe: use textContent
                                const div = document.createElement('div');
                                div.style.padding = '0';
                                div.style.fontSize = '0.95rem';
                                div.textContent = String(v);
                                td.appendChild(div);
                                tr.appendChild(td);
                            });

                            tbody.appendChild(tr);
                        });
                        table.appendChild(tbody);

                        container.appendChild(table);

                        // footer summary
                        const footer = createFooterSummary(lastFetchedData.length, keys.length);
                        container.appendChild(footer);

                        // reset scroll
                        container.scrollTop = 0;
                        container.scrollLeft = 0;

                        currentDisplayKeys = keys.slice(); // store keys order for export

                        console.log('Table rendered successfully with keys:', currentDisplayKeys);
                    } catch (e) {
                        console.error('displayTable error:', e);
                        // try to fallback to a safe message
                        const container = document.getElementById('admin-table-container');
                        if (container) {
                            container.innerHTML = `<pre style="color:red;">เกิดข้อผิดพลาดในการแสดงตาราง: ${escapeHtml(e && e.message ? e.message : String(e))}</pre>`;
                        }
                    }
                }

                // ---------- Session / Auth helpers ----------
                function isAdminSession() {
                    try {
                        const token = sessionStorage.getItem('sessionToken');
                        const username = sessionStorage.getItem('username');
                        const isAdmin = sessionStorage.getItem('isAdmin'); // expected 'true' or 'false'

                        // require token and server-provided isAdmin flag
                        if (!token || !username) return false;
                        if (isAdmin === 'true') return true;
                        return false;
                    } catch (e) {
                        console.error('admin: isAdminSession error', e);
                        return false;
                    }
                }

                window.adminForceLogout = function () {
                    try {
                        sessionStorage.removeItem('sessionToken');
                        sessionStorage.removeItem('username');
                        sessionStorage.removeItem('longName');
                        sessionStorage.removeItem('isAdmin');
                        // reuse existing logout function if present
                        if (typeof logout === 'function') logout();
                        else window.location.reload();
                    } catch (e) {
                        console.error('adminForceLogout error', e);
                        sessionStorage.clear();
                        window.location.reload();
                    }
                };

                window.adminCheckAuthAndInit = function () {
                    const currentUserEl = document.getElementById('admin-current-user');
                    const warning = document.getElementById('admin-access-warning');
                    const controls = document.getElementById('admin-controls');

                    const username = sessionStorage.getItem('username') || '';
                    const longName = sessionStorage.getItem('longName') || '';
                    if (currentUserEl) currentUserEl.textContent = username ? `${username} (${longName || '-'})` : 'ไม่ได้ล็อกอิน';

                    if (!isAdminSession()) {
                        if (warning) warning.classList.remove('hidden');
                        if (controls) controls.classList.add('hidden');
                        if (typeof showAdminLoginModal === 'function') showAdminLoginModal();
                        return;
                    }

                    // Use helper function for consistency
                    showAdminView();
                };

                function showLoading(show = true) {
                    const el = document.getElementById('admin-loading');
                    const wrapper = document.getElementById('admin-table-wrapper');
                    if (show) {
                        if (el) el.classList.remove('hidden');
                        if (wrapper) wrapper.classList.add('hidden');
                    } else {
                        if (el) el.classList.add('hidden');
                    }
                }

                // ---------- CSV export ----------
                window.adminExportCurrentToCSV = function () {
                    try {
                        if (!lastFetchedData || lastFetchedData.length === 0) {
                            if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีข้อมูล', 'ไม่มีข้อมูลให้ดาวน์โหลด');
                            else alert('ไม่มีข้อมูลให้ดาวน์โหลด');
                            return;
                        }

                        // Warn for large exports using config constant
                        if (lastFetchedData.length > CONFIG.MAX_SAFE_EXPORT_ROWS) {
                            const ok = confirm(`กำลังดาวน์โหลด ${lastFetchedData.length} แถว ซึ่งอาจใช้เวลานานหรือทำให้เบราว์เซอร์หน่วง\nต้องการดำเนินการต่อหรือไม่?`);
                            if (!ok) return;
                        }

                        // Determine keys order: prefer currently displayed table header order, else first-seen order
                        let keys = [];
                        const tableEl = document.querySelector('#admin-table-container table');
                        if (tableEl) {
                            const ths = tableEl.querySelectorAll('thead th');
                            if (ths && ths.length) {
                                keys = Array.from(ths).map(th => th.textContent || th.innerText || '').filter(Boolean);
                            }
                        }
                        if (!keys || keys.length === 0) {
                            // build union preserving first-seen order
                            const seen = new Set();
                            lastFetchedData.forEach(row => {
                                if (row && typeof row === 'object') {
                                    Object.keys(row).forEach(k => {
                                        if (!seen.has(k)) {
                                            seen.add(k);
                                            keys.push(k);
                                        }
                                    });
                                }
                            });
                        }

                        // Fallback to small safe set if somehow still empty
                        if (!keys || keys.length === 0) keys = Object.keys(lastFetchedData[0] || {});

                        // Build CSV with proper quoting and newline handling
                        const rows = [];
                        const headerRow = keys.map(k => `"${String(k).replace(/"/g, '""')}"`).join(',');
                        rows.push(headerRow);

                        lastFetchedData.forEach(obj => {
                            const row = keys.map(k => {
                                let v = obj && Object.prototype.hasOwnProperty.call(obj, k) ? obj[k] : '';
                                if (v === null || v === undefined) return '""';
                                if (typeof v === 'object') {
                                    try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                                }
                                // Normalize to string and escape quotes
                                let s = String(v);
                                // Replace CRLF/CR with LF to avoid CSV injection problems (but keep newlines)
                                s = s.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
                                s = s.replace(/"/g, '""');

                                // CSV Injection Prevention: If cell starts with formula characters, prepend single quote
                                // Hyphen placed at end of character class to avoid escaping issues
                                if (s.length > 0 && /^[=+@\t\r\-]/.test(s)) {
                                    s = "'" + s;
                                }

                                return `"${s}"`;
                            }).join(',');
                            rows.push(row);
                        });

                        const csv = rows.join('\n');
                        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        const username = sessionStorage.getItem('username') || 'admin';
                        const filename = `admin_export_${username}_${new Date().toISOString().slice(0, 10)}.csv`;
                        a.href = url;
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        a.remove();
                        URL.revokeObjectURL(url);
                    } catch (e) {
                        console.error('adminExportCurrentToCSV error:', e);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ เกิดข้อผิดพลาด', escapeHtml(e && e.message ? e.message : String(e)));
                        else alert(String(e));
                    }
                };

                // ---------- Search/filter ----------
                let searchDebounceTimer = null;
                window.adminFilterTable = function () {
                    // Clear previous timer
                    if (searchDebounceTimer) {
                        clearTimeout(searchDebounceTimer);
                    }

                    // Debounce search using config constant
                    searchDebounceTimer = setTimeout(() => {
                        try {
                            const q = (document.getElementById('admin-search-input')?.value || '').trim().toLowerCase();
                            if (!q) {
                                displayTable(lastFetchedData);
                                return;
                            }

                            // Validate search query length using config constant
                            if (q.length > CONFIG.MAX_SEARCH_QUERY_LENGTH) {
                                console.warn('Search query too long, truncating');
                                document.getElementById('admin-search-input').value = q.substring(0, CONFIG.MAX_SEARCH_QUERY_LENGTH);
                                return;
                            }

                            const filtered = lastFetchedData.filter(row => {
                                try {
                                    return Object.values(row).some(v => {
                                        if (v === null || v === undefined) return false;
                                        if (typeof v === 'object') {
                                            try { v = JSON.stringify(v); } catch (e) { v = String(v); }
                                        }
                                        return String(v).toLowerCase().includes(q);
                                    });
                                } catch (e) {
                                    return false;
                                }
                            });
                            displayTable(filtered);
                        } catch (e) {
                            console.error('adminFilterTable error:', e);
                        }
                    }, CONFIG.SEARCH_DEBOUNCE_MS);
                };

                // ---------- Admin actions (fetch) ----------
                function setFetching(flag) {
                    isFetching = flag;
                    setAdminControlsDisabled(flag);
                    showLoading(flag);
                }

                /**
                 * Creates HTML template for displaying debug information.
                 * @param {string} resultDisplay - Pre-escaped JSON result string
                 * @returns {string} HTML template string
                 * @security Parameter MUST be HTML-escaped before calling this function
                 */
                function createDebugInfoTemplate(resultDisplay) {
                    return `<pre style="white-space:pre-wrap; max-height:400px; overflow-y:auto; font-family:monospace; font-size:12px;">${resultDisplay}</pre>`;
                }

                /**
                 * Creates HTML template for displaying debug error messages.
                 * @param {string} contextDisplay - Pre-escaped context description
                 * @param {string} errorMsg - Pre-escaped error message
                 * @returns {string} HTML template string
                 * @security Both parameters MUST be HTML-escaped before calling this function
                 */
                function createDebugErrorTemplate(contextDisplay, errorMsg) {
                    return `<div>
                    <p><strong>Context:</strong> ${contextDisplay}</p>
                    <p><strong>Error:</strong> ${errorMsg}</p>
                    <p style="margin-top:10px; font-size:0.9em; color:#666;">
                        This debug operation failed. Please check:
                        <ul style="margin:5px 0; padding-left:20px;">
                            <li>Your authentication token is valid</li>
                            <li>You have admin permissions</li>
                            <li>The backend function getAllFarmersDebug exists</li>
                            <li>The spreadsheet is accessible</li>
                        </ul>
                    </p>
                </div>`;
                }

                /**
                 * Creates HTML template for displaying debug exceptions.
                 * @param {string} errorMsg - Pre-escaped error message
                 * @returns {string} HTML template string
                 * @security Parameter MUST be HTML-escaped before calling this function
                 */
                function createDebugExceptionTemplate(errorMsg) {
                    return `<div>
                    <p>An unexpected error occurred while initiating debug operation:</p>
                    <pre style="background:#f5f5f5; padding:10px; margin-top:10px; border-radius:4px; overflow-x:auto;">${errorMsg}</pre>
                </div>`;
                }

                // Debug helper to fetch and display admin debug info
                function fetchAndShowAdminDebug(token, context) {
                    if (!token) {
                        console.warn('fetchAndShowAdminDebug: no token provided');
                        if (typeof showMessageBox === 'function') {
                            showMessageBox('⚠️ Debug Warning', 'No authentication token provided for debug operation');
                        }
                        return;
                    }

                    try {
                        console.log('fetchAndShowAdminDebug called with context:', context);

                        // Check if Google Apps Script API is available
                        if (typeof google === 'undefined' || !google.script || !google.script.run) {
                            console.error('fetchAndShowAdminDebug: google.script.run not available');
                            if (typeof showMessageBox === 'function') {
                                showMessageBox('❌ Environment Error', 'Google Apps Script API is not available. This debug function only works in the deployed web app environment.');
                            }
                            return;
                        }

                        // Track completion state to prevent race conditions
                        let operationCompleted = false;

                        // Set timeout for debug operation using CONFIG constant
                        // Set before enabling loading state to ensure proper order
                        const debugTimeout = setTimeout(() => {
                            // Only execute timeout handler if operation hasn't completed
                            if (!operationCompleted) {
                                console.warn('fetchAndShowAdminDebug: operation timed out');
                                operationCompleted = true;
                                setAdminControlsDisabled(false);
                                showLoading(false);
                                if (typeof showMessageBox === 'function') {
                                    showMessageBox('⏱️ Debug Timeout', 'Debug operation took too long and was cancelled. Please try again.');
                                }
                            }
                        }, CONFIG.DEBUG_FETCH_TIMEOUT_MS);

                        // Set loading state after timeout is configured
                        setAdminControlsDisabled(true);
                        showLoading(true);

                        google.script.run
                            .withSuccessHandler(result => {
                                // Mark operation as completed and cleanup
                                if (!operationCompleted) {
                                    operationCompleted = true;
                                    clearTimeout(debugTimeout);
                                    setAdminControlsDisabled(false);
                                    showLoading(false);

                                    console.log('Debug info fetched successfully:', result);

                                    // Display debug information
                                    if (typeof showMessageBox === 'function') {
                                        const contextDisplay = escapeHtml(context || 'Debug Info');
                                        const resultDisplay = escapeHtml(JSON.stringify(result, null, 2));
                                        const template = createDebugInfoTemplate(resultDisplay);
                                        showMessageBox('🔍 Debug Info - ' + contextDisplay, template);
                                    } else {
                                        // Fallback to console if showMessageBox is not available
                                        console.log('=== DEBUG INFO ===');
                                        console.log('Context:', context);
                                        console.log('Result:', result);
                                        alert('Debug info logged to console (F12)');
                                    }
                                }
                            })
                            .withFailureHandler(err => {
                                // Mark operation as completed and cleanup
                                if (!operationCompleted) {
                                    operationCompleted = true;
                                    clearTimeout(debugTimeout);
                                    setAdminControlsDisabled(false);
                                    showLoading(false);

                                    console.error('fetchAndShowAdminDebug failed:', err);

                                    // Display detailed error information
                                    const errorMsg = (err && err.message) ? err.message : 'Unknown error';
                                    if (typeof showMessageBox === 'function') {
                                        const contextDisplay = escapeHtml(context || 'N/A');
                                        const escapedError = escapeHtml(errorMsg);
                                        const template = createDebugErrorTemplate(contextDisplay, escapedError);
                                        showMessageBox('❌ Debug Fetch Failed', template);
                                    } else {
                                        alert('Debug fetch failed: ' + errorMsg);
                                    }
                                }
                            })
                            .getAllFarmersDebug(token);

                    } catch (e) {
                        // Handle synchronous exceptions
                        console.error('fetchAndShowAdminDebug exception:', e);
                        setAdminControlsDisabled(false);
                        showLoading(false);

                        // Use safe error message to avoid exposing internal error objects
                        const errorMsg = (e && e.message) ? e.message : 'An unexpected error occurred';
                        if (typeof showMessageBox === 'function') {
                            const escapedError = escapeHtml(errorMsg);
                            const template = createDebugExceptionTemplate(escapedError);
                            showMessageBox('❌ Debug Exception', template);
                        } else {
                            alert('Debug exception: An unexpected error occurred');
                        }
                    }
                };


                window.adminFetchAllFarmers = function () {
                    if (!isAdminSession()) {
                        if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงข้อมูลนี้');
                        return;
                    }

                    if (isFetching) return;
                    setFetching(true);
                    const token = sessionStorage.getItem('sessionToken') || '';

                    try {
                        if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                            setFetching(false);
                            return;
                        }

                        if (typeof google === 'undefined' || !google.script || !google.script.run) {
                            setFetching(false);
                            if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่สามารถเชื่อมต่อ', 'google.script.run ไม่พร้อมใช้งาน');
                            return;
                        }

                        google.script.run
                            .withSuccessHandler(result => {
                                setFetching(false);
                                console.log('=== adminFetchAllFarmers SUCCESS ===', result);

                                if (result === null || result === undefined) {
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'getAllFarmers คืนค่าเป็น null/undefined');
                                    return;
                                }

                                try {
                                    let data = result;
                                    if (typeof result === 'string') {
                                        data = JSON.parse(result);
                                    }

                                    if (!data) {
                                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'ไม่สามารถแปลงผลลัพธ์ได้');
                                        return;
                                    }

                                    if (data.success === false) {
                                        if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว (server)', escapeHtml(data.message || JSON.stringify(data)));
                                        return;
                                    }

                                    if (data.success && Array.isArray(data.data)) {
                                        displayTable(data.data);
                                        return;
                                    }

                                    if (Array.isArray(data)) {
                                        displayTable(data);
                                        return;
                                    }

                                    if (typeof showMessageBox === 'function') showMessageBox('❌ รูปแบบข้อมูลไม่ถูกต้อง', `<pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                                } catch (e) {
                                    console.error('Parse error:', e);
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ข้อผิดพลาดในการประมวลผล', 'เกิดข้อผิดพลาด:  ' + escapeHtml(e.message || String(e)));
                                }
                            })
                            .withFailureHandler(err => {
                                setFetching(false);
                                console.error('=== adminFetchAllFarmers FAILURE ===', err);
                                fetchAndShowAdminDebug(token, 'getAllFarmers failed (failureHandler)');
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว', escapeHtml((err && err.message) || 'ไม่สามารถดึงข้อมูลจาก Backend ได้'));
                            })
                            .getAllFarmers(token);

                    } catch (e) {
                        setFetching(false);
                        console.error('=== adminFetchAllFarmers EXCEPTION ===', e);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่รองรับ', 'เกิดข้อผิดพลาด: ' + escapeHtml(e.message || String(e)));
                    }
                };

                window.adminFetchAllUsage = function () {
                    if (!isAdminSession()) {
                        if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงข้อมูลนี้');
                        return;
                    }

                    if (isFetching) return;
                    setFetching(true);
                    const token = sessionStorage.getItem('sessionToken') || '';

                    try {
                        if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                            setFetching(false);
                            return;
                        }

                        if (typeof google === 'undefined' || !google.script || !google.script.run) {
                            setFetching(false);
                            if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่สามารถเชื่อมต่อ', 'google.script.run ไม่พร้อมใช้งาน');
                            return;
                        }

                        google.script.run
                            .withSuccessHandler(result => {
                                setFetching(false);
                                console.log('getAllUsage result:', result);

                                if (result === null || typeof result === 'undefined') {
                                    fetchAndShowAdminDebug(token, 'getAllUsage returned null/undefined');
                                    return;
                                }
                                try {
                                    const data = (typeof result === 'string') ? JSON.parse(result) : result;
                                    if (!data) { if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'getAllUsage คืนค่าเป็น null/undefined'); return; }
                                    if (data.success === false) { if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว (server)', escapeHtml(data.message || JSON.stringify(data))); return; }
                                    if (data.success && Array.isArray(data.data)) { displayTable(data.data); return; }
                                    if (Array.isArray(data)) { displayTable(data); return; }
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่ตรงรูปแบบที่คาด', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                                } catch (e) {
                                    console.error('adminFetchAllUsage parse error', e);
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการประมวลผลผลลัพธ์: ' + escapeHtml(e && e.message));
                                }
                            })
                            .withFailureHandler(err => {
                                setFetching(false);
                                console.error('adminFetchAllUsage failed', err);
                                fetchAndShowAdminDebug(token, 'getAllUsage failed (failureHandler)');
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว', escapeHtml((err && err.message) || 'ไม่สามารถดึงข้อมูลจาก Backend ได้'));
                            })
                            .getAllUsage(token);

                    } catch (e) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่รองรับ', 'ไม่พบ google.script.run ในสภาพแวดล้อมนี้');
                    }
                };

                window.adminFetchMerged = function () {
                    if (!isAdminSession()) {
                        if (typeof showMessageBox === 'function') showMessageBox('❌ สิทธิ์ไม่เพียงพอ', 'คุณไม่มีสิทธิ์เข้าถึงข้อมูลนี้');
                        return;
                    }

                    if (isFetching) return;
                    setFetching(true);
                    const token = sessionStorage.getItem('sessionToken') || '';

                    try {
                        if (typeof isAppsScriptReady === 'function' && !isAppsScriptReady('Admin Fetch')) {
                            setFetching(false);
                            return;
                        }

                        if (typeof google === 'undefined' || !google.script || !google.script.run) {
                            setFetching(false);
                            if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่สามารถเชื่อมต่อ', 'google.script.run ไม่พร้อมใช้งาน');
                            return;
                        }

                        google.script.run
                            .withSuccessHandler(result => {
                                setFetching(false);
                                console.log('getAllMerged result:', result);

                                if (result === null || typeof result === 'undefined') {
                                    fetchAndShowAdminDebug(token, 'getAllMerged returned null/undefined');
                                    return;
                                }

                                try {
                                    const data = (typeof result === 'string') ? JSON.parse(result) : result;
                                    if (!data) { if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่มีผลลัพธ์', 'getAllMerged คืนค่าเป็น null/undefined'); return; }
                                    if (data.success === false) { if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว (server)', escapeHtml(data.message || JSON.stringify(data))); return; }
                                    if (data.success && Array.isArray(data.data)) { displayTable(data.data); return; }
                                    if (Array.isArray(data)) { displayTable(data); return; }
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่ตรงรูปแบบที่คาด', `<pre style="white-space:pre-wrap;">${escapeHtml(JSON.stringify(data, null, 2))}</pre>`);
                                } catch (e) {
                                    console.error('adminFetchMerged parse error', e);
                                    if (typeof showMessageBox === 'function') showMessageBox('❌ ข้อผิดพลาด', 'เกิดข้อผิดพลาดในการประมวลผลผลลัพธ์: ' + escapeHtml(e && e.message));
                                }
                            })
                            .withFailureHandler(err => {
                                setFetching(false);
                                console.error('adminFetchMerged failed', err);
                                fetchAndShowAdminDebug(token, 'getAllMerged failed (failureHandler)');
                                if (typeof showMessageBox === 'function') showMessageBox('❌ ดึงข้อมูลล้มเหลว', escapeHtml((err && err.message) || 'ไม่สามารถดึงข้อมูลจาก Backend ได้'));
                            })
                            .getAllMerged(token);

                    } catch (e) {
                        setFetching(false);
                        if (typeof showMessageBox === 'function') showMessageBox('❌ ไม่รองรับ', 'ไม่พบ google.script.run ในสภาพแวดล้อมนี้');
                    }
                };


                // Expose minimal debug helpers only in development mode
                // Production deployments should remove this or gate it with environment check
                if (typeof console !== 'undefined' && console.log && window.location.hostname === 'localhost') {
                    window._admin_internal = {
                        getStats: () => ({
                            dataCount: lastFetchedData.length,
                            columnsCount: currentDisplayKeys.length,
                            isAdminSession: isAdminSession()
                        })
                    };
                }

                // observer to auto-call adminCheckAuthAndInit when view shown (if you use navigateTo)
                const adminView = document.getElementById('admin-view');
                if (adminView) {
                    const mo = new MutationObserver(() => {
                        if (!adminView.classList.contains('hidden')) setTimeout(() => adminCheckAuthAndInit(), 50);
                    });
                    mo.observe(adminView, { attributes: true, attributeFilter: ['class'] });
                }
            })();

            // =============================================
            // INITIALIZATION ของระบบหลัก
            // =============================================
            window.onload = () => {
                try {
                    console.log('🚀 Starting system initialization...');

                    // Step 1: Populate all dropdowns first
                    console.log('Step 1: Populating dropdowns...');
                    const populateSuccess = populateLongOptions();

                    if (!populateSuccess) {
                        console.warn('⚠️ Initial dropdown population had issues, will retry on user interaction');
                    }

                    // Step 2: Initialize other components
                    console.log('Step 2: Initializing components...');
                    showView('main-menu-view');
                    initializeFertilizerCheckboxes();

                    // Step 3: Check if user already logged in
                    console.log('Step 3: Checking login status...');
                    const currentUser = checkLoginStatus();

                    if (currentUser) {
                        console.log('✅ User already logged in:', currentUser.longName);

                        // Give dropdowns a moment to render, then auto-select
                        setTimeout(() => {
                            console.log('🔄 Auto-selecting dropdowns for logged-in user...');
                            updateAllLongDropdowns(currentUser.longName);
                            updateSheetALongDropdown();
                        }, DOM_READY_DELAY_MS);
                    } else {
                        console.log('ℹ️ No active user session');
                    }

                    // Step 4: Check GAS environment
                    isAppsScriptReady('Initialization');

                    console.log('✅ ระบบโหลดเสร็จสิ้น');
                } catch (error) {
                    console.error('❌ ข้อผิดพลาดในการโหลดระบบ:', error);
                    showMessageBox("❌ ข้อผิดพลาดระบบ",
                        "เกิดข้อผิดพลาดในการโหลดระบบ: " + error.message
                    );
                }
            };

            // =============================================
            // GLOBAL FUNCTION EXPORTS สำหรับฟอร์มสำรวจ
            // =============================================
            window.toggleAgentInput = toggleAgentInput;
            window.toggleDateRange = toggleDateRange;
            window.renderStemSection = renderStemSection;
            window.calculateTotal = calculateTotal;
            window.setupOtherToggles = setupOtherToggles;
            window.showCustomAlert = showCustomAlert;

            // General exports for other modules
            window.showLoginModal = showLoginModal;
            window.hideLoginModal = hideLoginModal;
            window.handleLogin = handleLogin;
            window.showAdminLoginModal = showAdminLoginModal;
            window.hideAdminLoginModal = hideAdminLoginModal;
            window.handleAdminLogin = handleAdminLogin;
            window.checkAuthAndShowSubmenu = checkAuthAndShowSubmenu;
            window.logout = logout;
            window.toggleOtherWateringInput = toggleOtherWateringInput;
            window.toggleOtherFertilizerInput = toggleOtherFertilizerInput;
            window.handleSheetASubmit = handleSheetASubmit;
            window.hideMessageBox = hideMessageBox;
            window.fetchAndDisplaySheetAData = fetchAndDisplaySheetAData;

            window.getFertilizerUsageData = getFertilizerUsageData;
            window.getUsageData = getUsageData;
            window.toggleOtherFertilizerInputUse = toggleOtherFertilizerInputUse;
            window.initializeFertilizerCheckboxes = initializeFertilizerCheckboxes;
            window.resetUsageContainers = resetUsageContainers;
            window.createFertilizerUsageHTML = createFertilizerUsageHTML;
            window.handleSheetBUseSubmit = handleSheetBUseSubmit;

            window.toggleAdjustedBRate = toggleAdjustedBRate;
            window.toggleAdjustedBNanoRate = toggleAdjustedBNanoRate;
            window.fetchAndDisplaySheetBUseData = fetchAndDisplaySheetBUseData;
            window.fetchSummaryData = fetchSummaryData;

            window.openLeafSampleForm = openLeafSampleForm;

            // alias navigateTo to existing showView
            window.navigateTo = showView;

            // =============================================
            // PWA SERVICE WORKER REGISTRATION
            // =============================================
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('sw.js', { scope: './' })
                        .then(registration => {
                            console.log('✅ Service Worker registered successfully:', registration.scope);

                            // Check for updates periodically
                            setInterval(() => {
                                registration.update();
                            }, 60000); // Check every minute

                            // Handle service worker updates
                            registration.addEventListener('updatefound', () => {
                                const newWorker = registration.installing;
                                newWorker.addEventListener('statechange', () => {
                                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                        // New service worker available
                                        console.log('🔄 New version available! Please refresh.');

                                        // Optionally show a notification to the user
                                        if (window.confirm('มีเวอร์ชันใหม่ของระบบ คุณต้องการรีเฟรชหน้าเพื่ออัพเดทหรือไม่?')) {
                                            newWorker.postMessage({ type: 'SKIP_WAITING' });
                                            window.location.reload();
                                        }
                                    }
                                });
                            });
                        })
                        .catch(error => {
                            console.error('❌ Service Worker registration failed:', error);
                        });

                    // Handle service worker controller change (when new SW takes over)
                    navigator.serviceWorker.addEventListener('controllerchange', () => {
                        console.log('🔄 Service Worker controller changed, reloading page...');
                        window.location.reload();
                    });
                });
            } else {
                console.warn('⚠️ Service Workers are not supported in this browser');
            }

            // =============================================
            // PWA INSTALL PROMPT
            // =============================================
            let deferredPrompt;

            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent the mini-infobar from appearing on mobile
                e.preventDefault();
                // Stash the event so it can be triggered later
                deferredPrompt = e;

                console.log('💾 PWA install prompt available');

                // Optionally show a custom install button
                // You can create a button in the UI and call showInstallPrompt() when clicked
            });

            window.showInstallPrompt = async function () {
                if (!deferredPrompt) {
                    console.log('ℹ️ Install prompt not available');
                    return;
                }

                // Show the install prompt
                deferredPrompt.prompt();

                // Wait for the user to respond to the prompt
                const { outcome } = await deferredPrompt.userChoice;

                if (outcome === 'accepted') {
                    console.log('✅ User accepted the install prompt');
                } else {
                    console.log('❌ User dismissed the install prompt');
                }

                // Clear the deferredPrompt
                deferredPrompt = null;
            };

            window.addEventListener('appinstalled', () => {
                console.log('✅ PWA installed successfully');
                deferredPrompt = null;
            });
        </script>
        <script>
            // =============================================
            // GACP SYSTEM LOGIC (Converted from React)
            // =============================================

            // --- 1. State & Constants ---

            const GACP_MENU_ITEMS = [
                { id: 'dashboard', label: 'Dashboard & Analytics', icon: 'layout-dashboard' },
                { id: 'quality-assurance', label: '1. การประกันคุณภาพ', icon: 'clipboard-check', sections: ['quality-assurance'] },
                { id: 'personnel', label: '2. บุคลากร', icon: 'user-check', sections: ['personnel'] },
                { id: 'hygiene', label: '3. สุขลักษณะส่วนบุคคล', icon: 'sparkles', sections: ['hygiene-dressing', 'hygiene-behavior', 'hygiene-health'] },
                { id: 'site', label: '4. มาตรฐานพื้นที่ปลูก', icon: 'map-pin', sections: ['site-soil', 'site-physical'] },
                { id: 'processing', label: '5. สถานที่แปรรูปเบื้องต้นและบรรจุ', icon: 'building-2', sections: ['processing-location', 'processing-zoning', 'processing-utilities'] },
                { id: 'tools', label: '6. มาตรฐานอุปกรณ์', icon: 'wrench', sections: ['tools-design', 'tools-maint', 'tools-waste'] },
                { id: 'fertilizer', label: '7. การจัดการปุ๋ย', icon: 'leaf', sections: ['fertilizer-reg', 'fertilizer-usage', 'fertilizer-storage'] },
                { id: 'water', label: '8. มาตรฐานการจัดการน้ำ', icon: 'droplets', sections: ['water-quality', 'water-risk', 'water-system'] },
                { id: 'documents', label: '9. การจัดการเอกสาร', icon: 'file-text', sections: ['docs-sop', 'docs-records', 'docs-trace'] },
                { id: 'harvest', label: '10. คุณภาพการเก็บเกี่ยว', icon: 'scissors', sections: ['harvest-standard', 'harvest-pests', 'harvest-ops', 'harvest-logistics'] },
                { id: 'pre-processing', label: '11. กระบวนการแปรรูปเบื้องต้น', icon: 'settings', sections: ['pre-processing-raw', 'pre-processing-drying', 'pre-processing-storage', 'pre-processing-standards'] },
                { id: 'packaging', label: '12. การบรรจุและการติดฉลาก', icon: 'package-check', sections: ['packaging-std', 'packaging-finished', 'packaging-label'] },
                { id: 'transport', label: '13. การจัดเก็บและการขนย้าย', icon: 'truck', sections: ['transport-env', 'transport-qc', 'transport-trace'] },
            ];

            const GACP_CHECKLIST_ITEMS = {
                'quality-assurance': ["แผนควบคุมการผลิตภาพรวม (CP/CCP)", "การเตรียมแปลงและเพาะพันธุ์", "การส่งเสริมการเจริญเติบโต", "การควบคุมศัตรูพืช", "การจัดการเพื่อความปลอดภัย", "การเก็บเกี่ยวและหลังเก็บเกี่ยว", "การขนย้ายวัตถุดิบ", "การอบรมพนักงาน"],
                'personnel': ["ความรู้ปัจจัยการผลิตและความปลอดภัย", "ทักษะการปลูกและดูแลรักษา", "ทักษะการเก็บเกี่ยว", "ทักษะการแปรรูป", "การเก็บรักษาวัตถุดิบ", "การรักษาคุณภาพหลังเก็บเกี่ยว"],
                'hygiene-dressing': ["ชุดปฏิบัติงานในแปลง สะอาด ปลอดภัย", "ชุดปฏิบัติงานแปรรูป (หมวก/หน้ากาก/ถุงมือ)", "งดสวมเครื่องประดับขณะแปรรูป", "อุปกรณ์ PPE สำหรับสารชีวภัณฑ์"],
                'hygiene-behavior': ["การล้างมือถูกต้องและสม่ำเสมอ", "เขตปลอดบุหรี่และอาหารในจุดผลิต", "การควบคุมสุขอนามัยบุคคลภายนอก"],
                'hygiene-health': ["ตรวจสุขภาพประจำปี", "นโยบายการลาป่วย (ท้องเสีย/แผลเปิด)", "การอบรมการใช้ชุดป้องกัน"],
                'site-soil': ["ผลตรวจโลหะหนัก 5 ชนิด", "ผลตรวจสารเคมีกำจัดศัตรูพืช", "หลักฐานการวิเคราะห์ดินรายปี", "แผนบริหารความเสี่ยงภัยธรรมชาติ"],
                'site-physical': ["แนวกันชน/รั้วรอบแปลง", "การจัดการขยะ/สิ่งปฏิกูลในฟาร์ม", "ระยะห่างจากแหล่งมลพิษ"],
                'processing-location': ["สถานที่สะอาด ไร้กลิ่น/ควัน", "โครงสร้างแข็งแรง กันสัตว์/แมลง", "วัสดุผิวสัมผัสล้างทำความสะอาดง่าย"],
                'processing-zoning': ["ผังการไหลแบบทางเดียว", "แยกโซน ล้าง/ผลิต/บรรจุ", "พื้นที่กักกันวัตถุดิบแยกชัดเจน", "จุดเปลี่ยนเครื่องแต่งกายพนักงาน"],
                'processing-utilities': ["น้ำสะอาดและถังเก็บมิดชิด", "ระบบระบายอากาศ/กรองอากาศ", "แสงสว่างเพียงพอและมีฝาครอบไฟ", "อ่างล้างมือพร้อมน้ำยาฆ่าเชื้อ"],
                'tools-design': ["อุปกรณ์สัมผัสพืชสะอาด", "วัสดุ Food Grade ไม่เป็นสนิม", "ออกแบบให้ถอดล้างทำความสะอาดง่าย"],
                'tools-maint': ["เครื่องชั่งมีความเที่ยงตรง", "ใบสอบเทียบประจำปี (Calibration)", "บันทึกการซ่อมบำรุงรักษา"],
                'tools-waste': ["ถังขยะปิดมิดชิดกันรั่ว", "ป้ายกำกับถังขยะชัดเจน", "ทางขนย้ายของเสียแยกจากผลผลิต", "กำจัดขยะทิ้งทุกวัน"],
                'fertilizer-reg': ["ปุ๋ยมีเลขทะเบียน DOA ถูกต้อง", "ใบขึ้นทะเบียน (กรณีผลิตเอง)", "ผลตรวจโลหะหนักในปุ๋ยหมัก"],
                'fertilizer-usage': ["ใช้ตามความต้องการพืช", "กันปุ๋ยปนเปื้อนเชื้อโรคสู่ใบ", "ห้ามใช้สิ่งขับถ่ายคน", "ปุ๋ยอินทรีย์ย่อยสลายสมบูรณ์แล้ว"],
                'fertilizer-storage': ["แยกพื้นที่เก็บ/ผสมเป็นสัดส่วน", "ไม่ปนเปื้อนสู่แหล่งน้ำ"],
                'water-quality': ["ผลตรวจโลหะหนักผ่านเกณฑ์", "ผลตรวจสารเคมีกำจัดศัตรูพืช", "น้ำล้างคุณภาพระดับน้ำดื่ม", "รายงานผลตรวจน้ำประจำปี"],
                'water-risk': ["แผนสุ่มตรวจบ่อพักน้ำ", "ประเมินความเสี่ยงมลพิษข้างเคียง", "ไม่ใช้น้ำเสียโรงงาน/ชุมชน"],
                'water-system': ["วิธีการให้น้ำเหมาะสม", "ระบบบำบัดน้ำทิ้งก่อนปล่อย"],
                'docs-sop': ["SOP การปลูก/ธาตุอาหาร", "SOP ศัตรูพืช/ระบบน้ำ", "SOP หลังเก็บเกี่ยว/บด", "SOP บรรจุ/ขนส่ง/ของเสีย", "SOP ฝึกอบรม/บันทึก"],
                'docs-records': ["ประวัติที่ดิน 3 ปี", "บันทึกกิจกรรมประจำวัน", "บันทึกปัจจัยการผลิต", "บันทึกสารชีวภัณฑ์", "บันทึกสภาพอากาศ"],
                'docs-trace': ["หมายเลขรุ่นผลิต (Lot)", "เอกสารซื้อขายครบถ้วน", "บันทึกการประเมินย้อนหลัง", "บันทึกการทบทวนงาน", "เก็บเอกสารไว้อย่างน้อย 2 ปี"],
                'harvest-standard': ["ป้องกันการปนสายพันธุ์", "ไม่กระทบชุมชน", "เกษตรเชิงอนุรักษ์"],
                'harvest-pests': ["ระบบ IPM", "สารเคมีมีทะเบียน", "สารชีวภัณฑ์ปลอดภัย", "สอบเทียบเครื่องพ่น", "แยกที่เก็บสารเคมี"],
                'harvest-ops': ["ระยะเก็บเหมาะสม", "เก็บตอนฟ้าแจ้ง", "คัดใบราทิ้ง", "กันวัชพืชปน"],
                'harvest-logistics': ["ภาชนะสะอาดไม่วางพื้น", "ไม่วางซ้อนทับกันหนา", "พนักงานสะอาด", "ขนส่งทันทีกันฝุ่น"],
                'pre-processing-raw': ["คุมอุณหภูมิวัตถุดิบ", "ล้างใบสะอาด", "คัดแยกก่อนเข้าผลิต"],
                'pre-processing-drying': ["ทำแห้งทันที", "ระบบลดความชื้นดี", "ไม่แปรรูปปนพืชอื่น"],
                'pre-processing-storage': ["คุมความชื้นที่เก็บ", "กันหนู/แมลงมิดชิด", "อุปกรณ์ไม่เป็นสนิม"],
                'pre-processing-standards': ["มาตรฐานไทย/ต่างประเทศ", "แจ้งกรรมวิธีพิเศษ (ถ้ามี)"],
                'packaging-std': ["บรรจุทันทีกันแสง", "วัสดุ Food Grade", "SOP การล้างภาชนะใช้ซ้ำ", "ที่เก็บภาชนะเปล่าสะอาด"],
                'packaging-finished': ["วางบนพาเลทพลาสติก", "เว้นระยะจากผนัง", "แยกเก็บพืชอื่นชัดเจน"],
                'packaging-label': ["ชื่อพืช/ส่วนที่ใช้", "ชื่อผู้ผลิต/แหล่งต้นกำเนิด", "เลขรุ่น/วันเก็บเกี่ยว/วันผลิต", "ปริมาณบรรจุชัดเจน", "หมึกพิมพ์คงทน"],
                'transport-env': ["รถขนส่งกันแสง/ความชื้น", "คลังสินค้าคุมปัจจัยแวดล้อม", "กันปนเปื้อนระหว่างทาง"],
                'transport-qc': ["ผลแล็บรายรุ่น (เชื้อ/เคมี)", "ตรวจความชื้น (Moisture)", "แผนการสุ่มตรวจชัดเจน"],
                'transport-trace': ["เก็บตัวอย่างอ้างอิง 6 เดือน", "สืบค้นข้อมูลย้อนกลับได้ทันที"]
            };

            let gacpState = {
                activeTab: 'dashboard',
                farmerInfo: {
                    hasRepresentative: false,
                    representativeName: '',
                    firstName: '',
                    lastName: '',
                    location: '',
                    date: new Date().toISOString().split('T')[0],
                    gps: '13.7563, 100.5018'
                },
                notesData: {},
                imagesData: {},
                checkData: {},
                isSaving: false
            };

            // Initialize checkData
            Object.keys(GACP_CHECKLIST_ITEMS).forEach(k => {
                gacpState.checkData[k] = Array(GACP_CHECKLIST_ITEMS[k].length).fill(false);
            });

            // --- 2. Helper Functions ---

            function gacpCalculateProgress(sections) {
                if (!sections || sections.length === 0) return 0;
                let total = 0;
                let completed = 0;
                sections.forEach(s => {
                    if (gacpState.checkData[s]) {
                        total += gacpState.checkData[s].length;
                        completed += gacpState.checkData[s].filter(Boolean).length;
                    }
                });
                return Math.round((completed / total) * 100) || 0;
            }

            function gacpGetOverallStatus() {
                const allSections = Object.keys(gacpState.checkData);
                const p = gacpCalculateProgress(allSections);
                if (p === 100) return { text: 'ผ่านเกณฑ์ดีเยี่ยม', color: 'text-emerald-500', bg: 'bg-emerald-500' };
                if (p >= 80) return { text: 'ผ่านเกณฑ์พื้นฐาน', color: 'text-blue-500', bg: 'bg-blue-500' };
                return { text: 'ต้องปรับปรุงแก้ไข', color: 'text-amber-500', bg: 'bg-amber-500' };
            }

            // --- 3. Render Functions ---

            function renderGACPSidebar() {
                const menuContainer = document.getElementById('gacp-menu');
                if (!menuContainer) return;

                menuContainer.innerHTML = GACP_MENU_ITEMS.map(item => `
                <button onclick="setGACPActiveTab('${item.id}'); toggleGACPSidebar(false)" 
                    class="w-full flex items-center gap-3 px-6 py-3.5 text-sm transition-all hover:bg-slate-800 
                    ${gacpState.activeTab === item.id ? 'bg-emerald-600 text-white shadow-lg shadow-emerald-900/20' : 'text-slate-400'}">
                    <i data-lucide="${item.icon}" class="w-[18px] h-[18px]"></i>
                    <span class="text-left font-medium">${item.label}</span>
                </button>
            `).join('');

                lucide.createIcons();
            }

            function renderGACPContent() {
                const contentArea = document.getElementById('gacp-content-area');
                if (!contentArea) return;

                if (gacpState.activeTab === 'dashboard') {
                    contentArea.innerHTML = renderGACPDashboard();
                } else {
                    const item = GACP_MENU_ITEMS.find(m => m.id === gacpState.activeTab);
                    if (item) {
                        contentArea.innerHTML = renderGACPSectionPage(item);
                    }
                }
                lucide.createIcons({ root: contentArea });
            }

            function renderGACPDashboard() {
                const overall = gacpGetOverallStatus();
                const progress = gacpCalculateProgress(Object.keys(gacpState.checkData));
                const passedCategories = GACP_MENU_ITEMS.slice(1).filter(m => gacpCalculateProgress(m.sections) === 100).length;
                const issuesCount = Object.values(gacpState.checkData).flat().filter(v => v === false).length;

                return `
            <div class="max-w-6xl mx-auto space-y-10 animate-in fade-in duration-700 pb-20">
                ${renderFarmerCard()}
                
                <div class="flex items-center gap-3 mb-2">
                    <i data-lucide="bar-chart-3" class="text-slate-400 w-6 h-6"></i>
                    <h2 class="text-lg font-black text-slate-700 uppercase tracking-widest">การวิเคราะห์ข้อมูลเชิงลึก</h2>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-10 rounded-[2.5rem] border border-slate-200 shadow-sm relative overflow-hidden flex flex-col justify-between">
                         <div class="relative z-10">
                            <div class="flex justify-between items-start mb-8">
                                <span class="text-slate-500 font-black text-[11px] uppercase tracking-widest">คะแนนการประเมินรวม</span>
                                <div class="p-3 rounded-2xl bg-slate-50 ${overall.color} shadow-inner">
                                    <i data-lucide="alert-triangle" class="w-7 h-7"></i>
                                </div>
                            </div>
                            <div class="flex flex-col gap-1 mb-6">
                                <span class="text-slate-400 font-black text-[10px] uppercase tracking-[0.2em]">เกษตรกรผู้รับการตรวจ:</span>
                                <h3 class="text-2xl font-black text-slate-800">
                                  ${(gacpState.farmerInfo.firstName || gacpState.farmerInfo.lastName) ? `${gacpState.farmerInfo.firstName} ${gacpState.farmerInfo.lastName}` : "ยังไม่ได้ระบุชื่อ"}
                                </h3>
                            </div>
                            <div class="flex items-end gap-3">
                                <span class="text-8xl font-black text-slate-900 leading-none">${progress}</span>
                                <span class="text-4xl font-black text-slate-200 mb-2">%</span>
                            </div>
                            <p class="mt-6 text-2xl font-black ${overall.color} flex items-center gap-3">
                                ${overall.text}
                                ${progress >= 80 ? '<i data-lucide="check-circle-2" class="w-6 h-6"></i>' : ''}
                            </p>
                        </div>
                        
                        <!-- Mini Charts -->
                         <div class="grid grid-cols-2 sm:grid-cols-4 gap-4 mt-10 relative z-10">
                            ${[
                        { label: 'บุคลากร', sec: ['personnel'] },
                        { label: 'พื้นที่ปลูก', sec: ['site-soil', 'site-physical'] },
                        { label: 'แปรรูป', sec: ['processing-location', 'processing-zoning', 'processing-utilities'] },
                        { label: 'เอกสาร', sec: ['docs-sop', 'docs-records', 'docs-trace'] }
                    ].map(stat => {
                        const p = gacpCalculateProgress(stat.sec);
                        return `
                                <div class="bg-slate-50 p-3 rounded-2xl border border-slate-100">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-[10px] font-bold text-slate-400">${stat.label}</span>
                                        <span class="text-[10px] font-black text-slate-700">${p}%</span>
                                    </div>
                                    <div class="w-full h-1.5 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="bg-emerald-500 h-full" style="width: ${p}%"></div>
                                    </div>
                                </div>`;
                    }).join('')}
                        </div>
                        <div class="absolute -bottom-10 -right-10 opacity-[0.03] pointer-events-none">
                             <i data-lucide="leaf" class="w-[300px] h-[300px]"></i>
                        </div>
                    </div>

                    <div class="space-y-8">
                        <div class="bg-emerald-600 p-10 rounded-[2.5rem] text-white shadow-2xl shadow-emerald-200 relative overflow-hidden group">
                            <span class="text-emerald-200 font-black text-[11px] uppercase tracking-widest relative z-10">หมวดหมู่ที่ผ่านเกณฑ์</span>
                            <p class="text-7xl font-black mt-6 relative z-10">${passedCategories}</p>
                            <p class="text-sm font-bold text-emerald-100 mt-4 relative z-10">จากทั้งหมด ${GACP_MENU_ITEMS.length - 1} หมวดใหญ่</p>
                             <i data-lucide="users" class="absolute -right-6 -bottom-6 text-white/10 w-[120px] h-[120px]"></i>
                        </div>
                         <div class="bg-slate-900 p-10 rounded-[2.5rem] text-white shadow-2xl shadow-slate-300 relative overflow-hidden group">
                            <span class="text-slate-500 font-black text-[11px] uppercase tracking-widest relative z-10">จุดที่ต้องแก้ไขสะสม</span>
                            <p class="text-7xl font-black mt-6 text-amber-500 relative z-10">${issuesCount}</p>
                            <p class="text-sm font-bold text-slate-400 mt-4 relative z-10">รายการที่ยังไม่สมบูรณ์</p>
                            <i data-lucide="alert-circle" class="absolute -right-6 -bottom-6 text-white/5 w-[120px] h-[120px]"></i>
                        </div>
                    </div>
                </div>

                <!-- Quick Access Grid -->
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    ${GACP_MENU_ITEMS.slice(1).map(item => {
                        const prog = gacpCalculateProgress(item.sections);
                        return `
                        <button onclick="setGACPActiveTab('${item.id}')"
                            class="bg-white p-6 rounded-[2rem] border border-slate-200 hover:border-emerald-500 hover:shadow-2xl hover:-translate-y-2 transition-all text-left flex flex-col group relative overflow-hidden">
                            <div class="flex justify-between items-start mb-6">
                                <div class="p-4 rounded-2xl transition-all duration-300 ${prog === 100 ? 'bg-emerald-500 text-white shadow-lg shadow-emerald-500/30' : 'bg-slate-100 text-slate-500 group-hover:bg-emerald-50'}">
                                    <i data-lucide="${item.icon}" class="w-6 h-6"></i>
                                </div>
                                ${prog === 100 ? `<div class="bg-emerald-50 p-2 rounded-full"><i data-lucide="check-circle-2" class="w-4 h-4 text-emerald-500"></i></div>` : ''}
                            </div>
                            <h4 class="font-black text-slate-800 text-sm group-hover:text-emerald-600 transition-colors line-clamp-2 mb-4 h-10 leading-snug">${item.label}</h4>
                            <div class="mt-auto">
                                <div class="flex items-center justify-between mb-2">
                                     <span class="text-[10px] font-black text-slate-400 uppercase tracking-wider">ความสมบูรณ์</span>
                                     <span class="text-[10px] font-black ${prog === 100 ? 'text-emerald-600' : 'text-slate-600'}">${prog}%</span>
                                </div>
                                <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden shadow-inner">
                                    <div class="h-full transition-all duration-500 ${prog === 100 ? 'bg-emerald-500' : 'bg-slate-400 group-hover:bg-emerald-400'}" style="width: ${prog}%"></div>
                                </div>
                            </div>
                        </button>`;
                    }).join('')}
                </div>
            </div>`;
            }

            function renderFarmerCard() {
                return `
            <div class="bg-white rounded-3xl p-8 shadow-sm border border-slate-200 mb-6 transition-all">
                <div class="flex flex-col gap-8">
                    <div class="flex flex-wrap items-center gap-4 border-b border-slate-100 pb-6">
                         <div class="flex items-center gap-3 mr-4">
                            <i data-lucide="users" class="text-emerald-500 w-6 h-6"></i>
                            <span class="font-black text-slate-700 text-sm uppercase tracking-wider">สถานะการตรวจสอบ</span>
                         </div>
                         <div class="flex bg-slate-100 p-1.5 rounded-2xl">
                            <button onclick="updateFarmerInfo('hasRepresentative', false)" 
                                class="px-6 py-2.5 rounded-xl text-sm font-black transition-all ${!gacpState.farmerInfo.hasRepresentative ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                ไม่มีตัวแทน
                            </button>
                             <button onclick="updateFarmerInfo('hasRepresentative', true)" 
                                class="px-6 py-2.5 rounded-xl text-sm font-black transition-all ${gacpState.farmerInfo.hasRepresentative ? 'bg-white text-emerald-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}">
                                มีตัวแทน
                            </button>
                         </div>
                         ${gacpState.farmerInfo.hasRepresentative ? `
                         <div class="flex-1 min-w-[300px] animate-in slide-in-from-left duration-300">
                            <input placeholder="โปรดระบุชื่อตัวแทน..." 
                                class="w-full bg-emerald-50/50 border-2 border-emerald-100 rounded-2xl px-5 py-2.5 text-sm focus:border-emerald-500 focus:ring-0 outline-none font-medium placeholder:text-emerald-300"
                                value="${gacpState.farmerInfo.representativeName}" 
                                onchange="updateFarmerInfo('representativeName', this.value)">
                         </div>` : ''}
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div class="space-y-6">
                             <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">ชื่อเกษตรกร</label>
                                    <div class="flex items-center gap-3 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 group focus-within:border-emerald-500 transition-all">
                                        <i data-lucide="user" class="text-slate-400 w-[18px] h-[18px]"></i>
                                        <input class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none font-bold text-slate-800" 
                                            placeholder="ชื่อ..." value="${gacpState.farmerInfo.firstName}" onchange="updateFarmerInfo('firstName', this.value)">
                                    </div>
                                </div>
                                <div>
                                    <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">นามสกุล</label>
                                    <div class="flex items-center gap-3 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 group focus-within:border-emerald-500 transition-all">
                                        <input class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none font-bold text-slate-800"
                                            placeholder="นามสกุล..." value="${gacpState.farmerInfo.lastName}" onchange="updateFarmerInfo('lastName', this.value)">
                                    </div>
                                </div>
                             </div>
                             <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">ที่ตั้งแปลง / จังหวัด</label>
                                <div class="flex items-center gap-3 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 group focus-within:border-emerald-500 transition-all">
                                    <i data-lucide="map-pin" class="text-slate-400 w-5 h-5"></i>
                                    <input class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none font-bold text-slate-800"
                                        placeholder="ตำบล, อำเภอ, จังหวัด..." value="${gacpState.farmerInfo.location}" onchange="updateFarmerInfo('location', this.value)">
                                </div>
                             </div>
                        </div>
                        <div class="space-y-6 md:border-l border-slate-100 md:pl-8">
                             <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">วันที่เข้าตรวจสอบ</label>
                                <div class="flex items-center gap-3 bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3 group focus-within:border-emerald-500 transition-all">
                                    <i data-lucide="calendar" class="text-slate-400 w-5 h-5"></i>
                                    <input type="date" class="w-full bg-transparent border-none p-0 focus:ring-0 outline-none font-bold text-slate-800"
                                        value="${gacpState.farmerInfo.date}" onchange="updateFarmerInfo('date', this.value)">
                                </div>
                             </div>
                             <div>
                                <label class="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-2 block">พิกัดแปลง (GPS)</label>
                                <div class="flex items-center justify-between bg-slate-50 border border-slate-100 rounded-2xl px-4 py-3">
                                    <div class="flex items-center gap-3">
                                        <i data-lucide="map-pin" class="text-emerald-500 w-5 h-5"></i>
                                        <span class="font-bold text-slate-800">${gacpState.farmerInfo.gps}</span>
                                    </div>
                                    <button onclick="updateGPSLocation()" class="text-xs font-black bg-emerald-100 text-emerald-700 px-4 py-2 rounded-xl hover:bg-emerald-200 transition-colors">อัปเดตตำแหน่ง</button>
                                </div>
                             </div>
                        </div>
                    </div>
                </div>
            </div>`;
            }

            function renderGACPSectionPage(menuItem) {
                const hasCriteria = menuItem.label.includes("พื้นที่ปลูก") || menuItem.label.includes("น้ำ");
                return `
            <div class="max-w-5xl mx-auto space-y-6 pb-24 animate-in fade-in duration-300">
                <div class="bg-white rounded-[2rem] shadow-xl shadow-slate-200/50 border border-slate-200 overflow-hidden">
                    <div class="p-8 border-b border-slate-100 bg-white flex flex-col md:flex-row md:items-center justify-between gap-6">
                        <div class="flex gap-4 items-center">
                            <div class="p-4 bg-emerald-500 rounded-2xl text-white shadow-lg shadow-emerald-500/30">
                                <i data-lucide="${menuItem.icon}" class="w-8 h-8"></i>
                            </div>
                            <div>
                                <h2 class="text-2xl font-black text-slate-900 tracking-tight">${menuItem.label}</h2>
                                <p class="text-slate-500 text-sm mt-1 font-bold">การตรวจสอบความถูกต้องตามหลักเกณฑ์ GAP ในหมวด${menuItem.label}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-6 bg-slate-50 p-5 rounded-3xl border border-slate-100">
                            <div class="text-right">
                                <div class="text-3xl font-black text-emerald-600">${gacpCalculateProgress(menuItem.sections)}%</div>
                                <div class="text-[10px] text-slate-400 font-black uppercase tracking-widest">ความคืบหน้า</div>
                            </div>
                            ${hasCriteria ? `<button onclick="toggleCriteriaModal(true)" class="flex items-center gap-2 px-5 py-2.5 bg-emerald-600 text-white rounded-2xl text-sm font-black shadow-md shadow-emerald-500/30 hover:bg-emerald-700 transition-all"><i data-lucide="info" class="w-[18px] h-[18px]"></i> เกณฑ์มาตรฐาน</button>` : ''}
                        </div>
                    </div>
                    
                    <div class="p-6 md:p-10 space-y-10 bg-slate-50/20">
                        ${menuItem.sections.map(section => `
                            <div class="bg-white border border-slate-200 rounded-[2rem] overflow-hidden shadow-sm">
                                <div class="bg-slate-50 px-8 py-4 border-b border-slate-100 flex items-center justify-between">
                                    <div class="flex items-center gap-3">
                                        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
                                        <h3 class="font-black text-slate-800 text-xs uppercase tracking-widest">${section.replace('-', ' ')}</h3>
                                    </div>
                                    <div class="text-[10px] font-black text-slate-400">บันทึกแล้ว ${Object.keys(gacpState.notesData).filter(k => k.startsWith(section)).length} หมายเหตุ</div>
                                </div>
                                <div class="divide-y divide-slate-100">
                                    ${(GACP_CHECKLIST_ITEMS[section] || []).map((label, idx) => renderChecklistItem(section, idx, label)).join('')}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>`;
            }

            function renderChecklistItem(section, index, label) {
                const noteKey = `${section}-${index}`;
                const currentNote = gacpState.notesData[noteKey] || '';
                const isChecked = gacpState.checkData[section][index];
                const currentImages = gacpState.imagesData[noteKey] || 0;
                const noteSafe = currentNote.replace(/"/g, '&quot;');

                return `
            <div class="group border-b border-slate-50 last:border-0 transition-all duration-200 overflow-hidden">
                <div class="flex items-start justify-between p-5 group-hover:bg-emerald-50/20">
                    <div class="flex items-start gap-4 flex-1">
                        <span class="mt-1.5 flex items-center justify-center w-6 h-6 rounded-full bg-slate-100 text-[10px] font-black text-slate-400 group-hover:bg-emerald-100 group-hover:text-emerald-600 transition-colors">${index + 1}</span>
                        <div class="flex-1 pr-4">
                            <span class="text-slate-700 block font-bold leading-relaxed">${label}</span>
                            <div class="flex gap-4 mt-3">
                                <button onclick="updateGACPImageCount('${noteKey}')" class="flex items-center gap-1.5 text-[10px] font-black uppercase tracking-wider text-slate-400 hover:text-emerald-600 transition-colors">
                                    <i data-lucide="camera" class="w-[14px] h-[14px]"></i> ${currentImages > 0 ? `รูปภาพ (${currentImages})` : 'เพิ่มรูปหลักฐาน'}
                                </button>
                                <button onclick="toggleNoteField('${noteKey}')" class="flex items-center gap-1.5 text-[10px] font-black uppercase tracking-wider transition-colors ${currentNote ? 'text-amber-600' : 'text-slate-400 hover:text-amber-600'}">
                                    <i data-lucide="message-square-plus" class="w-[14px] h-[14px]"></i> ${currentNote ? 'แก้ไขหมายเหตุ' : 'เพิ่มหมายเหตุ'}
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="flex pt-1.5 pl-4">
                        <input type="checkbox" ${isChecked ? 'checked' : ''} onchange="toggleGACPCheck('${section}', ${index})" class="w-8 h-8 rounded-xl border-slate-300 text-emerald-600 focus:ring-emerald-500 cursor-pointer shadow-sm transition-all">
                    </div>
                </div>
                <!-- Note Field -->
                <div id="note-field-${noteKey}" class="${currentNote ? 'block' : 'hidden'} px-5 pb-5 animate-in slide-in-from-top-2 duration-300">
                     <div class="ml-10 bg-amber-50/50 border border-amber-100 rounded-2xl p-3">
                         <div class="flex items-center justify-between mb-2">
                            <span class="text-[10px] font-black text-amber-600 uppercase tracking-widest flex items-center gap-2"><i data-lucide="file-text" class="w-3 h-3"></i> หมายเหตุ / ข้อเสนอแนะ</span>
                         </div>
                         <textarea rows="2" class="w-full bg-white border-none rounded-xl p-3 text-sm focus:ring-2 focus:ring-amber-200 outline-none text-slate-700 placeholder:text-slate-300"
                            placeholder="พิมพ์ข้อความที่นี่..." onchange="updateGACPNote('${section}', ${index}', this.value)">${currentNote}</textarea>
                     </div>
                </div>
            </div>`;
            }

            // --- 4. Event Handlers & API ---

            function setGACPActiveTab(tabId) {
                gacpState.activeTab = tabId;
                renderGACPSidebar();
                renderGACPContent();
            }

            function toggleGACPSidebar(open) {
                const sb = document.getElementById('gacp-sidebar');
                const overlay = document.querySelector('.gacp-sidebar-overlay');
                if (open) {
                    sb.classList.add('open');
                    if (overlay) overlay.classList.add('active');
                } else {
                    sb.classList.remove('open');
                    if (overlay) overlay.classList.remove('active');
                }
            }

            function updateFarmerInfo(field, value) {
                gacpState.farmerInfo[field] = value;
                if (document.getElementById('gacp-menu')) {
                    // re-render if needed, mostly for dashboard
                    if (gacpState.activeTab === 'dashboard') renderGACPContent();
                }
            }

            function toggleGACPCheck(section, index) {
                gacpState.checkData[section][index] = !gacpState.checkData[section][index];
                // Re-render only necessary parts could be optimized, but full re-render safest for progress bars
                renderGACPContent();
            }

            function updateGACPNote(section, index, value) {
                gacpState.notesData[`${section}-${index}`] = value;
            }

            function updateGACPImageCount(key) {
                gacpState.imagesData[key] = (gacpState.imagesData[key] || 0) + 1;
                renderGACPContent();
            }

            function toggleNoteField(key) {
                const el = document.getElementById(`note-field-${key}`);
                if (el) {
                    if (el.classList.contains('hidden')) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            }

            function toggleCriteriaModal(show) {
                const m = document.getElementById('gacp-criteria-modal');
                if (m) {
                    if (show) m.classList.remove('hidden');
                    else m.classList.add('hidden');
                }
            }

            // Export/Save/Init
            function exportToPDF() {
                window.print();
            }

            async function updateGPSLocation() {
                if (!navigator.geolocation) {
                    alert('เบราว์เซอร์ของคุณไม่รองรับการระบุตำแหน่ง');
                    return;
                }

                const btn = document.querySelector('button[onclick="updateGPSLocation()"]');
                const originalText = btn ? btn.innerText : 'อัปเดตตำแหน่ง';
                if (btn) btn.innerText = 'กำลังค้นหา...';

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const coords = `${position.coords.latitude.toFixed(6)}, ${position.coords.longitude.toFixed(6)}`;
                        updateFarmerInfo('gps', coords);
                        if (btn) btn.innerText = originalText;
                        if (gacpState.activeTab === 'dashboard') renderGACPContent();
                    },
                    (error) => {
                        console.error('GPS Error:', error);
                        alert('ไม่สามารถระบุตำแหน่งได้: ' + error.message);
                        if (btn) btn.innerText = originalText;
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            }
            function saveGACPData() {
                if (gacpState.isSaving) return;

                const btn = document.getElementById('gacp-save-btn');
                const originalContent = btn.innerHTML;

                // Set Loading UI
                gacpState.isSaving = true;
                btn.innerHTML = '<div class="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> กำลังบันทึก...';
                btn.disabled = true;
                btn.classList.add('bg-slate-400');

                const token = sessionStorage.getItem('sessionToken') || '';

                google.script.run
                    .withSuccessHandler(result => {
                        gacpState.isSaving = false;
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                        btn.classList.remove('bg-slate-400');

                        if (result.success) {
                            if (typeof showMessageBox === 'function') showMessageBox('บันทึกสำเร็จ', 'ข้อมูลถูกบันทึกเรียบร้อยแล้ว');
                            else alert('บันทึกสำเร็จ');
                        } else {
                            if (typeof showMessageBox === 'function') showMessageBox('เกิดข้อผิดพลาด', result.message);
                            else alert('เกิดข้อผิดพลาด: ' + result.message);
                        }
                    })
                    .withFailureHandler(err => {
                        gacpState.isSaving = false;
                        btn.innerHTML = originalContent;
                        btn.disabled = false;
                        btn.classList.remove('bg-slate-400');

                        if (typeof showMessageBox === 'function') showMessageBox('เกิดข้อผิดพลาด', 'Server Error: ' + err.message);
                        else alert('Server Error: ' + err.message);
                    })
                    .saveGACPData(gacpState, token);
            }

            function initGACP() {
                renderGACPSidebar();
                renderGACPContent();

                // Hook into the visibility of admin-lounge to re-render icons
                const obs = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.target.id === 'admin-lounge' && !mutation.target.classList.contains('hidden')) {
                            renderGACPSidebar();
                            renderGACPContent();
                        }
                    });
                });
                const al = document.getElementById('admin-lounge');
                if (al) obs.observe(al, { attributes: true, attributeFilter: ['class'] });
            }

            // Auto-run init
            document.addEventListener('DOMContentLoaded', initGACP);

            // Expose critical functions to window explicitly for safety
            window.setGACPActiveTab = setGACPActiveTab;
            window.toggleGACPSidebar = toggleGACPSidebar;
            window.updateFarmerInfo = updateFarmerInfo;
            window.toggleGACPCheck = toggleGACPCheck;
            window.updateGACPNote = updateGACPNote;
            window.updateGACPImageCount = updateGACPImageCount;
            window.toggleNoteField = toggleNoteField;
            window.toggleCriteriaModal = toggleCriteriaModal;
            window.saveGACPData = saveGACPData;
            window.exportToPDF = exportToPDF;
            window.updateGPSLocation = updateGPSLocation;

        </script>
        <script>
            // =============================================
            // DELIVERY SYSTEM LOGIC
            // =============================================

            // State Machine Definitions (Thai)
            const LOT_STATES = {
                PENDING: "รอเก็บเกี่ยว",
                HARVESTED: "เก็บเกี่ยวแล้ว",
                SORTED: "คัดแยกแล้ว",
                CLEANED: "ล้างทำความสะอาดแล้ว",
                DRIED: "อบแห้งแล้ว",
                GROUND: "บดผงแล้ว",
                PACKED: "บรรจุแล้ว",
                MERGED: "รวม Lot แล้ว"
            };

            const STATE_FLOW = [
                "PENDING",
                "HARVESTED",
                "SORTED",
                "CLEANED",
                "DRIED",
                "GROUND",
                "PACKED"
            ];

            let currentActiveLot = null;
            // Track selected SORTED lots for combined cleaning
            let selectedSortedLots = new Set();

            document.addEventListener('DOMContentLoaded', () => {
                // Observer to auto-load lots when view is shown
                const observer = new MutationObserver((mutations) => {
                    mutations.forEach((mutation) => {
                        if (mutation.target.id === 'delivery-system-view' && !mutation.target.classList.contains('hidden')) {
                            loadActiveLots();
                        }
                    });
                });
                const target = document.getElementById('delivery-system-view');
                if (target) observer.observe(target, { attributes: true, attributeFilter: ['class'] });
            });

            function loadActiveLots() {
                const container = document.getElementById('delivery-active-lots-container');
                const token = sessionStorage.getItem('sessionToken');

                if (!token) {
                    container.innerHTML = '<div class="text-center text-red-500">กรุณาล็อกอินใหม่</div>';
                    return;
                }

                container.innerHTML = '<div class="text-center py-10 text-gray-500"><div class="loading-spinner mx-auto mb-2"></div>กำลังโหลดข้อมูล Lot...</div>';

                google.script.run
                    .withSuccessHandler(result => {
                        if (result.success) {
                            renderActiveLots(result.lots);
                        } else {
                            container.innerHTML = `<div class="text-center text-red-500">เกิดข้อผิดพลาด: ${result.message}</div>`;
                        }
                    })
                    .withFailureHandler(err => {
                        container.innerHTML = `<div class="text-center text-red-500">Server Error: ${err.message}</div>`;
                    })
                    .getAgentLots(token);
            }

            function renderActiveLots(lots) {
                const container = document.getElementById('delivery-active-lots-container');
                // Clear selected lots when reloading
                selectedSortedLots.clear();
                updateCombineCleaningButton();

                if (!lots || lots.length === 0) {
                    container.innerHTML = `
                    <div class="text-center py-10 bg-gray-50 rounded-lg border border-gray-200">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-12 w-12 mx-auto text-gray-300 mb-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                        <p class="text-gray-500">ยังไม่มีรายการ Lot การผลิต</p>
                        <div class="mt-4 flex gap-4 justify-center">
                             <button onclick="showDeliveryNewLotModal(true)" class="text-blue-600 font-semibold hover:underline">รับซื้อ (Receive)</button>
                             <button onclick="showDeliveryNewLotModal(false)" class="text-green-600 font-semibold hover:underline">เก็บเกี่ยว (Harvest)</button>
                        </div>
                    </div>
                `;
                    return;
                }

                let html = '';
                lots.filter(lot => lot.state !== 'MERGED').forEach(lot => {
                    const stateDisplay = LOT_STATES[lot.state] || lot.state;
                    const dateDisplay = new Date(lot.updated_at).toLocaleDateString('th-TH', {
                        year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit'
                    });

                    // Color coding based on state
                    let stateColor = "bg-gray-100 text-gray-800";
                    if (lot.state === 'PENDING') stateColor = "bg-yellow-100 text-yellow-800";
                    else if (lot.state === 'HARVESTED') stateColor = "bg-blue-100 text-blue-800";
                    else if (lot.state === 'SORTED') stateColor = "bg-cyan-100 text-cyan-800";
                    else if (lot.state === 'CLEANED') stateColor = "bg-teal-100 text-teal-800";

                    // Risk display
                    let riskHtml = '';
                    if (lot.risk_score > 0) {
                        riskHtml = `<span class="ml-2 px-2 py-0.5 rounded text-xs bg-red-100 text-red-800 font-bold">⚠️ Risk: ${lot.risk_score}</span>`;
                    }

                    // Checkbox for SORTED lots
                    let checkboxHtml = '';
                    if (lot.state === 'SORTED') {
                        checkboxHtml = `
                            <div class="mr-3 flex items-center" onclick="event.stopPropagation()">
                                <input type="checkbox" 
                                    id="chk-${lot.lot_id}" 
                                    class="sorted-lot-checkbox w-5 h-5 accent-cyan-600 cursor-pointer"
                                    data-lot-id="${lot.lot_id}"
                                    data-farmer-name="${lot.farmer_name || lot.farmer_id || '-'}"
                                    onchange="toggleSortedLotSelection('${lot.lot_id}', '${lot.farmer_name || lot.farmer_id || '-'}', this.checked)">
                            </div>
                        `;
                    }

                    html += `
                    <div class="bg-white border border-gray-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow ${lot.state === 'SORTED' ? 'border-l-4 border-l-cyan-500' : ''}">
                        <div class="flex items-start">
                            ${checkboxHtml}
                            <div class="flex-grow cursor-pointer" onclick="openLotAction('${lot.lot_id}', '${lot.state}')">
                                <div class="flex justify-between items-start mb-2">
                                    <div>
                                        <div class="font-bold text-lg text-gray-800 flex items-center">
                                            ${lot.lot_id}
                                            ${riskHtml}
                                        </div>
                                        <div class="text-sm text-gray-500">เกษตรกร: ${lot.farmer_name || lot.farmer_id || '-'}</div>
                                    </div>
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold ${stateColor}">
                                        ${stateDisplay}
                                    </span>
                                </div>
                                <div class="flex justify-between items-end mt-4">
                                    <div class="text-xs text-gray-400">อัปเดตล่าสุด: ${dateDisplay}</div>
                                    <button class="text-blue-600 hover:text-blue-800 text-sm font-medium flex items-center gap-1">
                                        ดำเนินการต่อ 
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                });
                container.innerHTML = html;
            }

            // Toggle lot selection for combined cleaning
            function toggleSortedLotSelection(lotId, farmerName, isChecked) {
                if (isChecked) {
                    selectedSortedLots.add({ lotId, farmerName });
                } else {
                    selectedSortedLots.forEach(item => {
                        if (item.lotId === lotId) selectedSortedLots.delete(item);
                    });
                }
                updateCombineCleaningButton();
            }

            // Update the combine cleaning button visibility
            function updateCombineCleaningButton() {
                const btn = document.getElementById('combine-cleaning-btn');
                if (btn) {
                    if (selectedSortedLots.size > 0) {
                        btn.classList.remove('hidden');
                        btn.querySelector('span').textContent = `รวมล้าง (${selectedSortedLots.size})`;
                    } else {
                        btn.classList.add('hidden');
                    }
                }
            }

            // Show combined cleaning modal for selected SORTED lots
            function showCombinedCleaningModal() {
                if (selectedSortedLots.size === 0) {
                    showCustomAlert('กรุณาเลือก Lot ที่ต้องการรวมล้างก่อน', 'warning');
                    return;
                }

                const overlay = document.getElementById('delivery-form-overlay');
                const content = document.getElementById('delivery-form-content');
                const title = document.getElementById('delivery-form-title');
                const btn = document.getElementById('delivery-form-submit-btn');

                // Get selected lot info
                const selectedLotsArray = Array.from(selectedSortedLots);
                const lotIds = selectedLotsArray.map(l => l.lotId);
                const farmerNames = [...new Set(selectedLotsArray.map(l => l.farmerName))].join(', ');

                title.textContent = `รวมล้าง ${selectedSortedLots.size} Lot`;
                overlay.classList.remove('hidden');

                content.innerHTML = `
                <form class="space-y-4" id="combined-cleaning-form">
                    <input type="hidden" name="lot_ids" value="${lotIds.join(',')}">
                    <input type="hidden" name="process_step" value="cleaning">
                    
                    <div class="p-4 bg-cyan-50 rounded-lg border border-cyan-200 mb-4">
                        <h4 class="font-bold text-cyan-800 text-sm mb-2">Lot ที่เลือกรวมล้าง:</h4>
                        <div class="flex flex-wrap gap-2">
                            ${lotIds.map(id => `<span class="px-2 py-1 bg-cyan-100 text-cyan-800 rounded text-xs font-medium">${id}</span>`).join('')}
                        </div>
                        <p class="text-xs text-cyan-600 mt-2">เกษตรกร: ${farmerNames}</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ผู้ควบคุม</label>
                        <input type="text" name="cleaning_operator" required class="w-full border rounded p-2" placeholder="ระบุชื่อ">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">วิธีทำความสะอาด</label>
                         <select name="cleaning_method" class="w-full border rounded p-2 bg-white">
                                <option value="soaking">แช่น้ำ</option>
                                <option value="flow">ล้างน้ำไหลผ่าน</option>
                                <option value="other">อื่น ๆ</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label class="block text-sm font-medium mb-1">ปริมาณต่อรอบ (กก.)</label>
                             <input type="number" name="cleaning_qty_per_round" required min="0" step="0.1" class="w-full border rounded p-2">
                        </div>
                        <div>
                             <label class="block text-sm font-medium mb-1">เวลาที่ใช้ต่อรอบ (นาที)</label>
                             <input type="number" name="cleaning_time_per_round" required min="0" class="w-full border rounded p-2">
                        </div>
                    </div>

                    <div>
                         <label class="block text-sm font-medium mb-1">จำนวนรอบล้าง (ครั้ง)</label>
                         <input type="number" name="cleaning_round_count" value="1" required min="1" class="w-full border rounded p-2">
                    </div>
                    
                     <div>
                        <label class="block text-sm font-medium mb-1">เวลาจบงาน</label>
                        <input type="time" name="cleaning_end_time" required class="w-full border rounded p-2">
                    </div>
                    
                    <div class="p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">
                        <span class="font-bold">⚠️ หมายเหตุ:</span> ทุก Lot ที่เลือกจะถูกอัปเดตเป็นสถานะ "ล้างแล้ว" พร้อมกัน
                    </div>
                </form>
                `;

                btn.innerText = "ยืนยันรวมล้าง";
                btn.onclick = function () { submitCombinedCleaning(); };
            }

            // Submit combined cleaning for multiple lots
            function submitCombinedCleaning() {
                const form = document.getElementById('combined-cleaning-form');
                if (!form || !form.reportValidity()) return;

                const formData = new FormData(form);
                const lotIds = formData.get('lot_ids').split(',');

                const data = {
                    lot_ids: lotIds,
                    process_step: 'cleaning',
                    cleaning_operator: formData.get('cleaning_operator'),
                    cleaning_method: formData.get('cleaning_method'),
                    cleaning_qty_per_round: formData.get('cleaning_qty_per_round'),
                    cleaning_time_per_round: formData.get('cleaning_time_per_round'),
                    cleaning_round_count: formData.get('cleaning_round_count'),
                    cleaning_end_time: formData.get('cleaning_end_time')
                };

                const token = sessionStorage.getItem('sessionToken');

                // Disable button while processing
                const submitBtn = document.getElementById('delivery-form-submit-btn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerText = 'กำลังบันทึก...';
                }

                google.script.run
                    .withSuccessHandler(res => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerText = 'ยืนยันรวมล้าง';
                        }
                        if (res.success) {
                            showCustomAlert(`✅ ${res.message}`, 'success');
                            closeDeliveryForm();
                            selectedSortedLots.clear();
                            updateCombineCleaningButton();
                            loadActiveLots();
                        } else {
                            showCustomAlert(`❌ ${res.message}`, 'danger');
                        }
                    })
                    .withFailureHandler(err => {
                        if (submitBtn) {
                            submitBtn.disabled = false;
                            submitBtn.innerText = 'ยืนยันรวมล้าง';
                        }
                        showCustomAlert(`❌ เกิดข้อผิดพลาด: ${err.message}`, 'danger');
                    })
                    .updateMultipleLotState(data, token);
            }

            // =============================================
            // MODALS & FORMS
            // =============================================

            function showDeliveryNewLotModal(startAtSorting = false) {
                const overlay = document.getElementById('delivery-form-overlay');
                const content = document.getElementById('delivery-form-content');
                const title = document.getElementById('delivery-form-title');

                overlay.classList.remove('hidden');

                if (startAtSorting) {
                    title.textContent = "เปิด Lot ใหม่ (กรณีรับซื้อ / ไม่มีทีมเก็บ)";
                    // Case 2: Start at Sorting (Received)
                    content.innerHTML = renderReceiveGoodsForm();
                    document.getElementById('delivery-form-submit-btn').innerText = "บันทึกรับซื้อ";
                } else {
                    title.textContent = "เปิด Lot ใหม่ (เริ่มการเก็บเกี่ยว)";
                    // Case 1: Start Harvest -> PENDING
                    content.innerHTML = renderStartHarvestForm();
                    document.getElementById('delivery-form-submit-btn').innerText = "เริ่มเก็บ";
                }

                // Auto populate date
                const dateInput = document.getElementById('dl-harvest-date');
                if (dateInput) dateInput.valueAsDate = new Date();

                // Populate farmers dropdown
                populateFarmersDropdownForDelivery('dl-farmer-select');
            }

            function closeDeliveryForm() {
                const overlay = document.getElementById('delivery-form-overlay');
                overlay.classList.add('hidden');
                // Reset form content to prevent stale data
                const content = document.getElementById('delivery-form-content');
                if (content) content.innerHTML = '';
            }

            function submitDeliveryForm() {
                const btn = document.getElementById('delivery-form-submit-btn');
                const originalText = btn.innerText;

                // Basic Frontend Validation
                const form = document.querySelector('#delivery-form-content form');
                if (!form) {
                    showCustomAlert('❌ ไม่พบฟอร์ม กรุณาลองใหม่อีกครั้ง', 'danger');
                    return;
                }
                if (!form.reportValidity()) return;

                const formData = new FormData(form);
                const data = Object.fromEntries(formData.entries());

                const token = sessionStorage.getItem('sessionToken');

                btn.disabled = true;
                btn.innerText = "กำลังบันทึก...";

                const isNew = !data.lot_id;

                if (isNew) {
                    // Create Lot
                    // If "Receive Goods" mode (Case 2), set initial state to HARVESTED (Ready to Sort)
                    if (data.form_mode === 'receive_goods') {
                        data.initial_state = 'HARVESTED';
                    } else {
                        data.initial_state = 'PENDING'; // Start Harvest
                    }

                    google.script.run
                        .withSuccessHandler(res => {
                            btn.disabled = false;
                            btn.innerText = originalText;
                            if (res.success) {
                                closeDeliveryForm();
                                loadActiveLots();
                                showCustomAlert(`✅ เปิด Lot สำเร็จ: ${res.lot_id}`, 'success');
                            } else {
                                showCustomAlert(`❌ เกิดข้อผิดพลาด: ${res.message}`, 'danger');
                            }
                        })
                        .withFailureHandler(err => {
                            btn.disabled = false;
                            btn.innerText = originalText;
                            showCustomAlert(`❌ Server Error: ${err.message}`, 'danger');
                        })
                        .createLot(data, token);
                } else {
                    // Update State Logic
                    let nextState = data.current_state || 'PENDING'; // Default fallback

                    // Logic based on process_step
                    if (data.process_step === 'end_harvest') nextState = 'HARVESTED';
                    else if (data.process_step === 'sorting') nextState = 'SORTED';
                    else if (data.process_step === 'cleaning') nextState = 'CLEANED';
                    else if (data.process_step === 'drying') nextState = 'DRIED';
                    else if (data.process_step === 'grinding') nextState = 'GROUND';
                    else if (data.process_step === 'packing') nextState = 'PACKED';

                    google.script.run
                        .withSuccessHandler(res => {
                            btn.disabled = false;
                            btn.innerText = originalText;
                            if (res.success) {
                                closeDeliveryForm();
                                loadActiveLots();
                                showCustomAlert(`✅ บันทึกขั้นตอนสำเร็จ`, 'success');
                            } else {
                                showCustomAlert(`❌ เกิดข้อผิดพลาด: ${res.message}`, 'danger');
                            }
                        })
                        .updateLotState(data.lot_id, nextState, data, token);
                }
            }

            // =============================================
            // FORM TEMPLATES
            // =============================================

            function renderStartHarvestForm() {
                return `
                <form class="space-y-4">
                    <input type="hidden" name="process_step" value="start_harvest">
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">เลือกเกษตรกร</label>
                        <select id="dl-farmer-select" name="farmer_id" required class="w-full border rounded p-2 bg-white">
                            <option value="">-- กำลังโหลดรายชื่อ --</option>
                        </select>
                        <input type="hidden" name="farmer_name" id="dl-farmer-name">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">จังหวัด/อำเภอ</label>
                            <input type="text" name="location" class="w-full border rounded p-2" placeholder="ระบุพื้นที่">
                        </div>
                         <div>
                            <label class="block text-sm font-medium mb-1">สายพันธุ์</label>
                            <select name="species" class="w-full border rounded p-2 bg-white">
                                <option value="ก้านแดง">ก้านแดง</option>
                                <option value="ก้านเขียว">ก้านเขียว</option>
                                <option value="แมงดา">แมงดา</option>
                                <option value="เหรียญทอง">เหรียญทอง</option>
                            </select>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ช่วงเวลาเก็บ</label>
                        <div class="flex gap-4">
                            <label class="flex items-center gap-2">
                                <input type="radio" name="time_slot" value="morning" checked> เช้า (06:00-11:00)
                            </label>
                            <label class="flex items-center gap-2">
                                <input type="radio" name="time_slot" value="afternoon"> บ่าย (13:00-17:00)
                            </label>
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ขนาดภาชนะ</label>
                         <select name="container_size" class="w-full border rounded p-2 bg-white">
                                <option value="basket_20kg">ตะกร้า 20 กก.</option>
                                <option value="bag_10kg">ถุง 10 กก.</option>
                                <option value="bulk">เทกอง/รถกระบะ</option>
                        </select>
                    </div>
                    
                    <div class="p-3 bg-yellow-50 rounded border border-yellow-200 text-sm text-yellow-800">
                        <span class="font-bold">⚠️ หมายเหตุ:</span> กดบันทึกเพื่อเริ่มเปิด Lot (Pending)
                    </div>
                </form>
            `;
            }

            function renderEndHarvestForm(lotId) {
                return `
                <form class="space-y-4">
                    <input type="hidden" name="lot_id" value="${lotId}">
                    <input type="hidden" name="process_step" value="end_harvest">
                    
                    <div class="p-4 bg-yellow-50 rounded border border-yellow-200 text-center">
                        <h3 class="font-bold text-yellow-800">ยืนยันปริมาณการเก็บเกี่ยว (ปิดการเก็บ)</h3>
                        <p class="text-xs text-yellow-700">กรุณาชั่งน้ำหนักจริงที่หน้างาน</p>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ปริมาณที่เก็บจริง (กก.)</label>
                        <input type="number" name="qty_harvested" required min="0.1" step="0.1" class="w-full border rounded p-2 text-lg font-bold">
                    </div>
                </form>
             `;
            }

            function renderReceiveGoodsForm() {
                return `
               <form class="space-y-4">
                    <input type="hidden" name="form_mode" value="receive_goods">
                    <input type="hidden" name="process_step" value="receive_goods">
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">เลือกเกษตรกร (เจ้าของแปลง)</label>
                        <select id="dl-farmer-select" name="farmer_id" required class="w-full border rounded p-2 bg-white">
                            <option value="">-- กำลังโหลดรายชื่อ --</option>
                        </select>
                        <input type="hidden" name="farmer_name" id="dl-farmer-name">
                    </div>
                    
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">จังหวัด/อำเภอ</label>
                            <input type="text" name="location" class="w-full border rounded p-2" placeholder="ระบุพื้นที่">
                        </div>
                         <div>
                            <label class="block text-sm font-medium mb-1">สายพันธุ์</label>
                            <select name="species" class="w-full border rounded p-2 bg-white">
                                <option value="ก้านแดง">ก้านแดง</option>
                                <option value="ก้านเขียว">ก้านเขียว</option>
                                <option value="แมงดา">แมงดา</option>
                                <option value="เหรียญทอง">เหรียญทอง</option>
                            </select>
                        </div>
                    </div>

                    <div>
                        <label class="block text-sm font-medium mb-1">น้ำหนักรับเข้า (กก.)</label>
                        <input type="number" name="qty_harvested" required min="0.1" step="0.1" class="w-full border rounded p-2 text-lg font-bold">
                        <small class="text-gray-500">น้ำหนักสดที่รับเข้าเพื่อรอคัดแยก</small>
                    </div>
                    
                    <div class="p-3 bg-green-50 rounded border border-green-200 text-sm text-green-800">
                        <span class="font-bold">Info:</span> เมื่อบันทึกแล้ว Lot จะมีสถานะ "เก็บเกี่ยวแล้ว" พร้อมสำหรับการคัดแยก
                    </div>
                </form>
             `;
            }

            function populateFarmersDropdownForDelivery(selectId) {
                const token = sessionStorage.getItem('sessionToken');
                const longName = sessionStorage.getItem('longName');
                const select = document.getElementById(selectId);

                console.log('📋 populateFarmersDropdownForDelivery called with:', { selectId, longName, token: token ? 'present' : 'missing' });

                select.innerHTML = '<option value="">กำลังโหลด...</option>';

                google.script.run
                    .withSuccessHandler(result => {
                        console.log('📋 getAllFarmersByLong raw result:', result);

                        select.innerHTML = '<option value="">-- เลือกเกษตรกร --</option>';

                        // Parse result (getAllFarmersByLong returns JSON string)
                        let data;
                        try {
                            data = typeof result === 'string' ? JSON.parse(result) : result;
                        } catch (e) {
                            console.error('📋 JSON parse error:', e);
                            data = result;
                        }

                        console.log('📋 Parsed data:', data);
                        console.log('📋 data.success:', data?.success);
                        console.log('📋 data.data:', data?.data);
                        console.log('📋 Is array:', Array.isArray(data?.data));
                        console.log('📋 Length:', data?.data?.length);

                        if (data && data.success && Array.isArray(data.data) && data.data.length > 0) {
                            console.log('📋 First farmer record:', data.data[0]);

                            data.data.forEach(f => {
                                // Keys from Sheet A (Thai headers)
                                const key = f['รหัสเกษตรกร'] || f['a-id'] || '';
                                const name = f['ชื่อ-นามสกุล'] || f['a-fullname'] || key;

                                console.log('📋 Farmer:', { key, name, rawKeys: Object.keys(f) });

                                if (key) {
                                    const opt = document.createElement('option');
                                    opt.value = key;
                                    opt.textContent = `${name} (${key})`;
                                    opt.dataset.name = name;
                                    select.appendChild(opt);
                                }
                            });

                            // Use onchange attribute instead of addEventListener to prevent duplicate listeners
                            select.onchange = function () {
                                const nameInput = document.getElementById('dl-farmer-name');
                                const selectedOpt = this.options[this.selectedIndex];
                                if (nameInput) {
                                    // Reset farmer_name if empty option is selected
                                    nameInput.value = (selectedOpt && selectedOpt.value) ? (selectedOpt.dataset.name || '') : '';
                                }
                            };
                        } else {
                            // No farmers found in Sheet A
                            console.warn('📋 No farmers found or invalid data structure');
                            select.innerHTML = '<option value="">ไม่พบเกษตรกรที่ลงทะเบียนในระบบ</option>';
                            showCustomAlert('ไม่พบเกษตรกรที่ลงทะเบียน กรุณาเพิ่มข้อมูลเกษตรกรในหน้า "ข้อมูลการสำรวจจริง" ก่อน', 'warning');
                        }
                    })
                    .withFailureHandler(e => {
                        console.error('📋 populateFarmersDropdownForDelivery failure:', e);
                        select.innerHTML = '<option>โหลดล้มเหลว</option>';
                    })
                    .getAllFarmersByLong(longName, token);
            }

            function openLotAction(lotId, currentState) {
                console.log(`Open Lot: ${lotId}, State: ${currentState}`);

                const overlay = document.getElementById('delivery-form-overlay');
                const content = document.getElementById('delivery-form-content');
                const title = document.getElementById('delivery-form-title');
                const btn = document.getElementById('delivery-form-submit-btn');

                // Reset Button
                btn.innerText = "บันทึก";
                btn.disabled = false;
                btn.classList.remove('hidden');

                overlay.classList.remove('hidden');

                // Determine Form based on State
                if (currentState === 'PENDING') {
                    title.textContent = `บันทึกผลการเก็บเกี่ยว (End Harvest) - ${lotId}`;
                    content.innerHTML = renderEndHarvestForm(lotId);
                    btn.innerText = "จบการเก็บ";
                } else if (currentState === 'HARVESTED') {
                    title.textContent = `ขั้นตอนที่ 2: การคัดแยก (Sorting) - ${lotId}`;
                    content.innerHTML = renderSortingForm(lotId);
                    btn.innerText = "ปิดการคัด";
                } else if (currentState === 'SORTED') {
                    title.textContent = `ขั้นตอนที่ 3: การล้าง (Cleaning) - ${lotId}`;
                    content.innerHTML = renderCleaningForm(lotId);
                    btn.innerText = "ปิดการล้าง";
                } else if (currentState === 'CLEANED') {
                    title.textContent = `ขั้นตอนที่ 4: การอบแห้ง (Drying) - ${lotId}`;
                    content.innerHTML = renderDryingForm(lotId);
                    btn.innerText = "จบการอบ";
                } else if (currentState === 'DRIED') {
                    title.textContent = `ขั้นตอนที่ 5: การบดผง (Grinding) - ${lotId}`;
                    content.innerHTML = renderGrindingForm(lotId);
                    btn.innerText = "จบบด";
                } else if (currentState === 'GROUND') {
                    title.textContent = `ขั้นตอนที่ 6: การแพ็ค (Packing) - ${lotId}`;
                    content.innerHTML = renderPackingForm(lotId);
                    btn.innerText = "ปิด Lot";
                } else if (currentState === 'PACKED') {
                    title.textContent = `รายละเอียด Lot ${lotId} (จบกระบวนการ)`;
                    content.innerHTML = `<div class="p-4 text-center text-green-600 font-bold">Lot นี้เสร็จสิ้นกระบวนการแล้ว</div>`;
                    btn.classList.add('hidden'); // Hide submit
                    return;
                }
            } function renderSortingForm(lotId) {
                return `
                <form class="space-y-4">
                    <input type="hidden" name="lot_id" value="${lotId}">
                    <input type="hidden" name="process_step" value="sorting">
                    
                    <div class="p-3 bg-blue-50 rounded border border-blue-200 mb-4">
                        <h4 class="font-bold text-blue-800 text-sm">บันทึกผลการคัดแยก (Quality Control)</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ผู้ควบคุม/คัดแยก</label>
                        <input type="text" name="sorting_operator" required class="w-full border rounded p-2" placeholder="ระบุชื่อ">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                         <div>
                             <label class="block text-sm font-medium mb-1">ถุงที่ตรวจ (ผ่าน)</label>
                             <input type="number" name="sorting_bags_pass" required min="0" class="w-full border rounded p-2">
                         </div>
                         <div>
                             <label class="block text-sm font-medium mb-1">ถุงที่ตรวจ (ไม่ผ่าน)</label>
                             <input type="number" name="sorting_bags_fail" required min="0" class="w-full border rounded p-2">
                         </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">การจัดการของไม่ผ่าน</label>
                        <div class="flex gap-4">
                             <label class="flex items-center gap-1"><input type="radio" name="sorting_fail_action" value="destroy" checked> ทำลาย</label>
                             <label class="flex items-center gap-1"><input type="radio" name="sorting_fail_action" value="use"> แยกใช้</label>
                             <label class="flex items-center gap-1"><input type="radio" name="sorting_fail_action" value="return"> ส่งคืน</label>
                        </div>
                    </div>
                    
                    <hr class="border-gray-100">

                    <div>
                        <label class="block text-sm font-medium mb-1 text-blue-700">ปริมาณคงเหลือหลังคัด (กก.)</label>
                        <input type="number" name="qty_sorted_remaining" required min="0" step="0.1" class="w-full border rounded p-2 bg-blue-50 font-bold">
                        <small class="text-gray-500">น้ำหนักที่พร้อมสำหรับขั้นตอนถัดไป (ล้าง)</small>
                    </div>
                    
                    <div class="p-2 bg-gray-50 text-xs text-gray-500 rounded">
                        * ข้อมูลการคัดต้องสะท้อนสภาพวัตถุดิบจริง
                    </div>
                </form>
             `;
            }

            function renderCleaningForm(lotId) {
                return `
                <form class="space-y-4">
                    <input type="hidden" name="lot_id" value="${lotId}">
                    <input type="hidden" name="process_step" value="cleaning">
                    
                    <div class="p-3 bg-cyan-50 rounded border border-cyan-200 mb-4">
                        <h4 class="font-bold text-cyan-800 text-sm">บันทึกการทำความสะอาด</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ผู้ควบคุม</label>
                        <input type="text" name="cleaning_operator" required class="w-full border rounded p-2" placeholder="ระบุชื่อ">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">วิธีทำความสะอาด</label>
                         <select name="cleaning_method" class="w-full border rounded p-2 bg-white">
                                <option value="soaking">แช่น้ำ</option>
                                <option value="flow">ล้างน้ำไหลผ่าน</option>
                                <option value="other">อื่น ๆ</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label class="block text-sm font-medium mb-1">ปริมาณต่อรอบ (กก.)</label>
                             <input type="number" name="cleaning_qty_per_round" required min="0" step="0.1" class="w-full border rounded p-2">
                        </div>
                        <div>
                             <label class="block text-sm font-medium mb-1">เวลาที่ใช้ต่อรอบ (นาที)</label>
                             <input type="number" name="cleaning_time_per_round" required min="0" class="w-full border rounded p-2">
                        </div>
                    </div>

                    <div>
                         <label class="block text-sm font-medium mb-1">จำนวนรอบล้าง (ครั้ง)</label>
                         <input type="number" name="cleaning_round_count" value="1" required min="1" class="w-full border rounded p-2">
                    </div>
                    
                     <div>
                        <label class="block text-sm font-medium mb-1">เวลาจบงาน</label>
                        <input type="time" name="cleaning_end_time" required class="w-full border rounded p-2">
                    </div>
                    
                    <div class="p-2 bg-gray-50 text-xs text-gray-500 rounded">
                        * ข้อมูลการล้างต้องสอดคล้องกับวิธีที่เลือก
                    </div>
                </form>
                `;
            }

            function renderDryingForm(lotId) {
                return `
                <form class="space-y-4">
                    <input type="hidden" name="lot_id" value="${lotId}">
                    <input type="hidden" name="process_step" value="drying">
                    
                    <div class="p-3 bg-orange-50 rounded border border-orange-200 mb-4">
                        <h4 class="font-bold text-orange-800 text-sm">บันทึกการอบ (Drying)</h4>
                    </div>
                    
                     <div>
                        <label class="block text-sm font-medium mb-1">ผู้ควบคุม</label>
                        <input type="text" name="drying_operator" required class="w-full border rounded p-2" placeholder="ระบุชื่อ">
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">วิธีอบ</label>
                         <select name="drying_method" class="w-full border rounded p-2 bg-white">
                                <option value="sun">ตากแดด</option>
                                <option value="oven">เตาอบ</option>
                                <option value="other">อื่น ๆ</option>
                        </select>
                    </div>
                    
                     <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label class="block text-sm font-medium mb-1">เวลาเริ่มอบ</label>
                             <input type="datetime-local" name="drying_start_time" required class="w-full border rounded p-2">
                        </div>
                        <div>
                             <label class="block text-sm font-medium mb-1">เวลาจบอบ</label>
                             <input type="datetime-local" name="drying_end_time" required class="w-full border rounded p-2">
                        </div>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">ช่วงอุณหภูมิ (°C)</label>
                        <input type="text" name="drying_temp_range" placeholder="เช่น 45-60" class="w-full border rounded p-2">
                    </div>
                    
                     <div>
                        <label class="block text-sm font-medium mb-1 text-orange-700">ความชื้นหลังอบ (%) (ถ้ามี)</label>
                        <input type="number" name="drying_moisture_after" min="0" max="100" step="0.1" class="w-full border rounded p-2">
                    </div>
                    
                    <div class="p-2 bg-gray-50 text-xs text-gray-500 rounded">
                       * ไม่สามารถเริ่มอบได้ หากพื้นที่อบไม่พร้อมใช้งาน
                    </div>
                </form>
                `;
            }

            function renderGrindingForm(lotId) {
                return `
                <form class="space-y-4">
                    <input type="hidden" name="lot_id" value="${lotId}">
                    <input type="hidden" name="process_step" value="grinding">
                    
                    <div class="p-3 bg-gray-100 rounded border border-gray-300 mb-4">
                        <h4 class="font-bold text-gray-800 text-sm">บันทึกการบดผง (Grinding)</h4>
                    </div>
                    
                     <div>
                        <label class="block text-sm font-medium mb-1">ผู้ควบคุม</label>
                        <input type="text" name="grinding_operator" required class="w-full border rounded p-2" placeholder="ระบุชื่อ">
                    </div>
                    
                    <div>
                         <label class="block text-sm font-medium mb-1">เวลาหยุดเครื่องก่อนรอบนี้ (นาที)</label>
                         <input type="number" name="grinding_machine_rest" placeholder="ถ้าเครื่องทำงานต่อเนื่องใส่ 0" class="w-full border rounded p-2">
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                             <label class="block text-sm font-medium mb-1">ปริมาณเข้า (กก.)</label>
                             <input type="number" name="grinding_qty_in" required min="0" step="0.1" class="w-full border rounded p-2">
                        </div>
                        <div>
                             <label class="block text-sm font-medium mb-1 text-gray-900 font-bold">ปริมาณออก (กก.)</label>
                             <input type="number" name="grinding_qty_out" required min="0" step="0.1" class="w-full border rounded p-2 bg-gray-50 border-gray-400">
                        </div>
                    </div>
                    
                    <div class="p-2 bg-gray-50 text-xs text-gray-500 rounded">
                       * กรุณาตรวจสอบความพร้อมของเครื่องก่อนเริ่มกระบวนการ
                    </div>
                </form>
                `;
            }

            function renderPackingForm(lotId) {
                return `
                <form class="space-y-4">
                    <input type="hidden" name="lot_id" value="${lotId}">
                    <input type="hidden" name="process_step" value="packing">
                    
                    <div class="p-3 bg-green-50 rounded border border-green-200 mb-4">
                        <h4 class="font-bold text-green-800 text-sm">การบรรจุและการปิด Lot (Packing & Closing)</h4>
                    </div>
                    
                    <div>
                        <label class="block text-sm font-medium mb-1">รูปแบบบรรจุ</label>
                         <select name="packing_format" class="w-full border rounded p-2 bg-white">
                                <option value="bag_1kg">ถุง 1 กก.</option>
                                <option value="bag_5kg">ถุง 5 กก.</option>
                                <option value="box_10kg">กล่อง 10 กก.</option>
                                <option value="other">อื่น ๆ</option>
                        </select>
                    </div>
                    
                    <div>
                         <label class="block text-sm font-medium mb-1">จำนวน (ถุง/กล่อง)</label>
                         <input type="number" name="packing_qty" required min="1" class="w-full border rounded p-2">
                    </div>
                    
                    <div>
                         <label class="block text-sm font-medium mb-1">ความชื้นก่อนส่ง (%)</label>
                         <input type="number" name="packing_moisture" required min="0" max="100" step="0.01" class="w-full border rounded p-2">
                    </div>
                    
                    <div>
                         <label class="block text-sm font-medium mb-1">ข้อมูลคุณภาพ / หมายเหตุ</label>
                         <textarea name="packing_quality_note" class="w-full border rounded p-2" rows="2"></textarea>
                    </div>
                    
                    <div class="p-3 bg-red-50 rounded border border-red-200 text-sm text-red-800">
                        <span class="font-bold">ยืนยันการปิด Lot:</span> เมื่อบันทึกแล้ว Lot จะถูกปิด (CLOSED) และสร้าง QR Code สำหรับจัดส่ง
                    </div>
                </form>
                `;
            }


            function adminInitProductionDashboard() {
                const token = sessionStorage.getItem('sessionToken');
                if (!token) return;

                // Loading State
                document.getElementById('ad-prod-state-breakdown').innerHTML = '<div class="text-center py-4">กำลังโหลด...</div>';

                google.script.run
                    .withSuccessHandler(res => {
                        if (res.success) {
                            renderAdminProductionDashboard(res.lots);
                        } else {
                            showCustomAlert('เปิดข้อมูลไม่สำเร็จ: ' + res.message, 'danger');
                        }
                    })
                    .withFailureHandler(e => {
                        showCustomAlert('Server Error: ' + e.message, 'danger');
                    })
                    .getAdminDashboardData(token);
            }

            function renderAdminProductionDashboard(lots) {
                // 1. Metrics
                const total = lots.length;
                const completed = lots.filter(l => l.state === 'PACKED').length; // Assuming PACKED is done
                const active = total - completed;
                const risk = lots.filter(l => (l.risk_score || 0) > 0).length;

                document.getElementById('ad-prod-total').innerText = total;
                document.getElementById('ad-prod-active').innerText = active;
                document.getElementById('ad-prod-completed').innerText = completed;
                document.getElementById('ad-prod-risk').innerText = risk;

                // 2. State Breakdown
                const counts = {};
                STATE_FLOW.forEach(s => counts[s] = 0);
                lots.forEach(l => {
                    if (counts[l.state] !== undefined) counts[l.state]++;
                    else {
                        counts[l.state] = (counts[l.state] || 0) + 1;
                    }
                });

                let barHtml = '';
                STATE_FLOW.forEach(s => {
                    const count = counts[s] || 0;
                    const pct = total > 0 ? (count / total * 100) : 0;
                    barHtml += `
                    <div class="mb-2">
                        <div class="flex justify-between text-xs mb-1">
                            <span class="font-medium text-gray-700">${LOT_STATES[s] || s}</span>
                            <span class="text-gray-500">${count} (${pct.toFixed(1)}%)</span>
                        </div>
                        <div class="w-full bg-gray-100 rounded-full h-2.5">
                            <div class="bg-blue-600 h-2.5 rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                 `;
                });
                document.getElementById('ad-prod-state-breakdown').innerHTML = barHtml;

                // 3. Risk Table
                const riskLots = lots.filter(l => (l.risk_score || 0) > 0).sort((a, b) => b.risk_score - a.risk_score);
                let riskRows = '';
                if (riskLots.length === 0) {
                    riskRows = '<tr><td colspan="3" class="px-3 py-4 text-center text-gray-400">No high risk lots</td></tr>';
                } else {
                    riskLots.forEach(l => {
                        let flags = '-';
                        try {
                            if (Array.isArray(l.risk_flags)) flags = l.risk_flags.join(', ');
                            else if (typeof l.risk_flags === 'string') flags = l.risk_flags;
                        } catch (e) { }

                        riskRows += `
                        <tr class="border-t hover:bg-red-50">
                            <td class="px-3 py-2 font-medium">${l.lot_id}</td>
                            <td class="px-3 py-2 text-red-600 font-bold">${l.risk_score}</td>
                            <td class="px-3 py-2 text-xs text-gray-600">${flags}</td>
                        </tr>
                     `;
                    });
                }
                document.getElementById('ad-prod-risk-table').innerHTML = riskRows;

                // 4. All Lots Table (Latest 50)
                let lotsRows = '';
                lots.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                lots.slice(0, 50).forEach(l => {
                    const updated = new Date(l.updated_at).toLocaleDateString('th-TH');
                    lotsRows += `
                    <tr class="border-t hover:bg-gray-50">
                        <td class="px-4 py-3 font-medium text-blue-600 cursor-pointer" onclick="openLotAction('${l.lot_id}', '${l.state}')">${l.lot_id}</td>
                        <td class="px-4 py-3">
                            <span class="px-2 py-1 rounded text-xs bg-gray-100">${LOT_STATES[l.state] || l.state}</span>
                        </td>
                        <td class="px-4 py-3 text-sm">${l.agent_id}</td>
                        <td class="px-4 py-3 text-sm">${l.farmer_id || (l.data ? l.data.farmer_id : '-') || '-'}</td>
                        <td class="px-4 py-3 text-xs text-gray-500">${updated}</td>
                        <td class="px-4 py-3 text-sm">
                            <button class="text-gray-500 hover:text-blue-600" onclick="alert('View Details Not Implemented')">View</button>
                        </td>
                    </tr>
                 `;
                });
                document.getElementById('ad-prod-lots-table').innerHTML = lotsRows;
            }

        </script>
</body>

</html>